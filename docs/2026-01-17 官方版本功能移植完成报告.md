# å®˜æ–¹ç‰ˆæœ¬åŠŸèƒ½ç§»æ¤å®ŒæˆæŠ¥å‘Š

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-17  
**ç§»æ¤æ¥æº**: gcli2api_official (PR #291)  
**Git æäº¤**: `30703d5`

---

## ä¸€ã€ç§»æ¤å®Œæˆæƒ…å†µ

### âœ… å·²å®Œæˆç§»æ¤çš„åŠŸèƒ½

#### 1. Thinking Budget/Level å†²çªä¿®å¤ â­â­â­â­â­

**é—®é¢˜æè¿°**:  
å½“åŒæ—¶å­˜åœ¨ `thinkingBudget` å’Œ `thinkingLevel` å­—æ®µæ—¶ï¼ŒGemini API ä¼šè¿”å› 400 é”™è¯¯ã€‚

**å®˜æ–¹ç‰ˆæœ¬ä¿®å¤**:  
åœ¨è®¾ç½® `thinkingBudget` æ—¶ï¼Œæ˜ç¡®ç§»é™¤ `thinkingLevel` å­—æ®µï¼Œé¿å…å†²çªã€‚

**ç§»æ¤ä½ç½®**:
- âœ… `src/converters/tool_converter.py:526` - `generate_generation_config()` å‡½æ•°
- âœ… `src/anthropic_converter.py:1099` - `apply_thinking_config()` å‡½æ•°
- âœ… `src/openai_transfer.py:243,250` - `openai_request_to_gemini_payload()` å‡½æ•°
- âœ… `src/gcli_chat_api.py:852,861` - `build_gemini_payload_from_native()` å‡½æ•°
- âœ… `src/converters/gemini_fix.py:347,301` - `normalize_gemini_request()` å‡½æ•°

**ä¿®å¤ä»£ç **:
```python
# [FIX 2026-01-17] ç§»é™¤ thinkingLevel é¿å…ä¸ thinkingBudget å†²çªï¼ˆå®˜æ–¹ç‰ˆæœ¬ä¿®å¤ï¼‰
# å‚è€ƒ: gcli2api_official PR #291 (fix/thinking-budget-level-conflict)
thinking_config.pop("thinkingLevel", None)
```

**é¢„æœŸæ•ˆæœ**:  
- âœ… æ¶ˆé™¤ 400 é”™è¯¯
- âœ… æé«˜è¯·æ±‚æˆåŠŸç‡
- âœ… ä¸å®˜æ–¹ç‰ˆæœ¬è¡Œä¸ºä¸€è‡´

---

#### 2. MCP åœºæ™¯æ™ºèƒ½æ£€æµ‹ â­â­â­

**é—®é¢˜æè¿°**:  
åœ¨ MCPï¼ˆModel Context Protocolï¼‰åœºæ™¯ä¸‹ï¼Œå½“å­˜åœ¨å·¥å…·è°ƒç”¨æ—¶ï¼Œthinking æ¨¡å¼å¯èƒ½ä¼šå¤±æ•ˆã€‚

**å®˜æ–¹ç‰ˆæœ¬ä¿®å¤**:  
æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨æ—¶ï¼Œè‡ªåŠ¨ç§»é™¤ `thinkingConfig`ï¼Œé¿å…å¤±æ•ˆã€‚

**ç§»æ¤ä½ç½®**:
- âœ… `src/converters/gemini_fix.py:353-377` - `normalize_gemini_request()` å‡½æ•°

**ä¿®å¤ä»£ç **:
```python
if "claude" in model.lower():
    # [FIX 2026-01-17] ç§»æ¤å®˜æ–¹ç‰ˆæœ¬ï¼šæ£€æµ‹æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨ï¼ˆMCPåœºæ™¯ï¼‰
    has_tool_calls = any(
        isinstance(content, dict) and 
        any(
            isinstance(part, dict) and ("functionCall" in part or "function_call" in part)
            for part in content.get("parts", [])
        )
        for content in contents
    )
    
    if has_tool_calls:
        # MCP åœºæ™¯ï¼šæ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼Œç§»é™¤ thinkingConfig
        log.warning(f"[ANTIGRAVITY] æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼ˆMCPåœºæ™¯ï¼‰ï¼Œç§»é™¤ thinkingConfig é¿å…å¤±æ•ˆ")
        generation_config.pop("thinkingConfig", None)
```

**é¢„æœŸæ•ˆæœ**:  
- âœ… æé«˜ MCP åœºæ™¯ä¸‹çš„ç¨³å®šæ€§
- âœ… é¿å…å·¥å…·è°ƒç”¨æ—¶ thinking æ¨¡å¼å¤±æ•ˆ
- âœ… æ™ºèƒ½é€‚é…ä¸åŒä½¿ç”¨åœºæ™¯

---

### âš ï¸ å·²å­˜åœ¨ä½†éœ€éªŒè¯çš„åŠŸèƒ½

#### Contents æ¸…ç†é€»è¾‘

**çŠ¶æ€**: âœ… å·²å­˜åœ¨  
**ä½ç½®**: `src/converters/gemini_fix.py:183-250` - `clean_contents()` å‡½æ•°

**è¯´æ˜**:  
è‡ªç ”ç‰ˆæœ¬å·²ç»å®ç°äº† Contents æ¸…ç†é€»è¾‘ï¼ŒåŒ…æ‹¬ï¼š
- âœ… text å­—æ®µç±»å‹ä¿®å¤ï¼ˆåˆ—è¡¨â†’å­—ç¬¦ä¸²ï¼‰
- âœ… ç©º part è¿‡æ»¤
- âœ… å°¾éšç©ºæ ¼æ¸…ç†
- âœ… ä¸æ”¯æŒå­—æ®µè¿‡æ»¤ï¼ˆcache_control ç­‰ï¼‰

**éªŒè¯å»ºè®®**:  
å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬çš„å®ç°ï¼Œç¡®ä¿é€»è¾‘å®Œå…¨ä¸€è‡´ã€‚

---

## äºŒã€ä»£ç å˜æ›´ç»Ÿè®¡

### ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¡Œæ•°å˜åŒ– |
|------|---------|---------|
| `src/converters/tool_converter.py` | ä¿®æ”¹ | +3/-0 |
| `src/anthropic_converter.py` | ä¿®æ”¹ | +5/-0 |
| `src/openai_transfer.py` | ä¿®æ”¹ | +2/-0 |
| `src/gcli_chat_api.py` | ä¿®æ”¹ | +2/-0 |
| `src/converters/gemini_fix.py` | ä¿®æ”¹ | +46/-19 |

**æ€»è®¡**: 5 ä¸ªæ–‡ä»¶ï¼Œ+58 è¡Œï¼Œ-19 è¡Œ

---

## ä¸‰ã€æµ‹è¯•å»ºè®®

### 3.1 åŠŸèƒ½æµ‹è¯•

1. **Thinking Budget å†²çªæµ‹è¯•**
   - æµ‹è¯•åŒæ—¶å­˜åœ¨ thinkingBudget å’Œ thinkingLevel çš„åœºæ™¯
   - éªŒè¯ä¸å†å‡ºç° 400 é”™è¯¯

2. **MCP åœºæ™¯æµ‹è¯•**
   - æµ‹è¯•åŒ…å«å·¥å…·è°ƒç”¨çš„è¯·æ±‚
   - éªŒè¯ thinkingConfig è¢«æ­£ç¡®ç§»é™¤
   - éªŒè¯å·¥å…·è°ƒç”¨åŠŸèƒ½æ­£å¸¸

3. **å›å½’æµ‹è¯•**
   - æµ‹è¯•æ™®é€š thinking æ¨¡å¼è¯·æ±‚
   - æµ‹è¯•é thinking æ¨¡å¼è¯·æ±‚
   - éªŒè¯ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

---

## å››ã€åç»­ä¼˜åŒ–å»ºè®®

### 4.1 å¾…ç§»æ¤åŠŸèƒ½ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

1. **ç»Ÿä¸€è¯·æ±‚è§„èŒƒåŒ–ä¼˜åŒ–**
   - å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬çš„ `normalize_gemini_request()` å®ç°
   - ç¡®ä¿æ‰€æœ‰è¾¹ç•Œæƒ…å†µéƒ½å·²å¤„ç†

2. **æ¨¡å‹åç§°å¤„ç†ä¼˜åŒ–**
   - éªŒè¯ `get_base_model_name()` æ˜¯å¦æ”¯æŒå¾ªç¯ç§»é™¤å¤šä¸ªåç¼€
   - å¯¹æ¯”å®˜æ–¹ç‰ˆæœ¬çš„å®ç°

### 4.2 æŒç»­åŒæ­¥ç­–ç•¥

1. **å®šæœŸæ£€æŸ¥å®˜æ–¹ç‰ˆæœ¬æ›´æ–°**
   - æ¯å‘¨æ£€æŸ¥ä¸€æ¬¡å®˜æ–¹ä»“åº“çš„æ›´æ–°
   - é‡ç‚¹å…³æ³¨ bug ä¿®å¤å’Œå…¼å®¹æ€§æ”¹è¿›

2. **å»ºç«‹åŒæ­¥æ£€æŸ¥æ¸…å•**
   - ç»´æŠ¤ä¸€ä¸ªåŠŸèƒ½å¯¹æ¯”è¡¨
   - æ ‡è®°å·²ç§»æ¤ã€å¾…ç§»æ¤ã€å·²å­˜åœ¨ä½†éœ€éªŒè¯çš„åŠŸèƒ½

---

## äº”ã€æ€»ç»“

### 5.1 ç§»æ¤æˆæœ

âœ… **æˆåŠŸç§»æ¤ 2 ä¸ªæ ¸å¿ƒåŠŸèƒ½**:
1. Thinking Budget/Level å†²çªä¿®å¤ï¼ˆ5 ä¸ªæ–‡ä»¶ï¼‰
2. MCP åœºæ™¯æ™ºèƒ½æ£€æµ‹ï¼ˆ1 ä¸ªæ–‡ä»¶ï¼‰

âœ… **ä»£ç è´¨é‡**:
- æ— è¯­æ³•é”™è¯¯
- æ·»åŠ äº†è¯¦ç»†çš„æ³¨é‡Šè¯´æ˜
- ä¿æŒäº†ä»£ç é£æ ¼ä¸€è‡´æ€§

### 5.2 é¢„æœŸæ”¶ç›Š

- âœ… **æé«˜è¯·æ±‚æˆåŠŸç‡**: æ¶ˆé™¤ Thinking Budget å†²çªå¯¼è‡´çš„ 400 é”™è¯¯
- âœ… **æé«˜ç¨³å®šæ€§**: MCP åœºæ™¯æ£€æµ‹é¿å…å·¥å…·è°ƒç”¨å¤±æ•ˆ
- âœ… **ä¿æŒåŒæ­¥**: ä¸å®˜æ–¹ç‰ˆæœ¬å…³é”®ä¿®å¤ä¿æŒä¸€è‡´

### 5.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… å®ŒæˆåŠŸèƒ½æµ‹è¯•
2. âš ï¸ éªŒè¯ Contents æ¸…ç†é€»è¾‘æ˜¯å¦å®Œå…¨ä¸€è‡´
3. ğŸ“ å»ºç«‹å®šæœŸåŒæ­¥æœºåˆ¶

---

## å…­ã€å‚è€ƒèµ„æ–™

- å®˜æ–¹ç‰ˆæœ¬æºç : `gcli2api_official/src/converter/gemini_fix.py`
- å®˜æ–¹ç‰ˆæœ¬ PR: #291 (fix/thinking-budget-level-conflict)
- ç§»æ¤åˆ†ææŠ¥å‘Š: `docs/2026-01-17 å®˜æ–¹ç‰ˆæœ¬åŠŸèƒ½ç§»æ¤åˆ†ææŠ¥å‘Š.md`
- Git æäº¤: `30703d5`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-17  
**ç»´æŠ¤è€…**: æµ®æµ®é…± (Claude Opus 4)
