# gcli2api å®˜æ–¹ç‰ˆæœ¬åŠŸèƒ½ç§»æ¤åˆ†ææŠ¥å‘Š

**æ–‡æ¡£æ—¥æœŸ**: 2026-01-17  
**åˆ†æç›®æ ‡**: å¯¹æ¯” gcli2api å®˜æ–¹ç‰ˆæœ¬ä¸è‡ªç ”ç‰ˆæœ¬ï¼Œæ‰¾å‡ºå€¼å¾—ç§»æ¤çš„åŠŸèƒ½  
**åˆ†ææ–¹æ³•**: ä½¿ç”¨ ACE å·¥å…·è¿›è¡Œä»£ç æ‰«æä¸å¯¹æ¯”

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

é€šè¿‡ ACE å·¥å…·æ‰«æå’Œä»£ç å¯¹æ¯”ï¼Œå‘ç°å®˜æ–¹ç‰ˆæœ¬åœ¨ä»¥ä¸‹æ–¹é¢æœ‰å€¼å¾—ç§»æ¤çš„æ”¹è¿›ï¼š

1. âœ… **Thinking Budget ä¸ Thinking Level å†²çªä¿®å¤**ï¼ˆæœ€æ–°ä¿®å¤ï¼ŒPR #291ï¼‰
2. âœ… **ç»Ÿä¸€çš„ Gemini è¯·æ±‚è§„èŒƒåŒ–å¤„ç†**ï¼ˆ`normalize_gemini_request` å‡½æ•°ï¼‰
3. âœ… **å®Œå–„çš„ Contents æ¸…ç†é€»è¾‘**ï¼ˆtext å­—æ®µç±»å‹ä¿®å¤ã€ç©º part è¿‡æ»¤ï¼‰
4. âœ… **MCP åœºæ™¯æ™ºèƒ½æ£€æµ‹**ï¼ˆå·¥å…·è°ƒç”¨æ—¶è‡ªåŠ¨ç§»é™¤ thinkingConfigï¼‰
5. âœ… **æ›´å¥å£®çš„æ¨¡å‹åç§°å¤„ç†**ï¼ˆå¾ªç¯ç§»é™¤å¤šä¸ªåç¼€ï¼‰

---

## äºŒã€æ ¸å¿ƒåŠŸèƒ½å¯¹æ¯”

### 2.1 Thinking Budget ä¸ Thinking Level å†²çªä¿®å¤ â­â­â­

**å®˜æ–¹ç‰ˆæœ¬å®ç°**ï¼ˆ`src/converter/gemini_fix.py:171`ï¼‰:
```python
# è®¾ç½®æ€è€ƒé¢„ç®—
if thinking_budget:
    thinking_config["thinkingBudget"] = thinking_budget
    thinking_config.pop("thinkingLevel", None)  # é¿å…ä¸ thinkingBudget å†²çª
```

**è‡ªç ”ç‰ˆæœ¬ç°çŠ¶**:
- âŒ æœªæ˜ç¡®ç§»é™¤ `thinkingLevel` å­—æ®µ
- âš ï¸ å¯èƒ½å¯¼è‡´ 400 é”™è¯¯ï¼ˆå½“åŒæ—¶å­˜åœ¨ thinkingBudget å’Œ thinkingLevel æ—¶ï¼‰

**ç§»æ¤ä»·å€¼**: â­â­â­â­â­ **æé«˜ä¼˜å…ˆçº§**

**ç§»æ¤ä½ç½®**:
- `src/converters/tool_converter.py` - `generate_generation_config()` å‡½æ•°
- `src/anthropic_converter.py` - `get_thinking_config()` å‡½æ•°
- `src/openai_transfer.py` - thinking é…ç½®å¤„ç†éƒ¨åˆ†

---

### 2.2 ç»Ÿä¸€çš„ Gemini è¯·æ±‚è§„èŒƒåŒ–å¤„ç† â­â­â­

**å®˜æ–¹ç‰ˆæœ¬å®ç°**ï¼ˆ`src/converter/gemini_fix.py:116-349`ï¼‰:
- `normalize_gemini_request()` å‡½æ•°ç»Ÿä¸€å¤„ç†æ‰€æœ‰ Gemini è¯·æ±‚
- æ”¯æŒ `geminicli` å’Œ `antigravity` ä¸¤ç§æ¨¡å¼
- è‡ªåŠ¨å¤„ç†æ€è€ƒé…ç½®ã€æœç´¢å·¥å…·ã€æ¨¡å‹åç§°ã€å‚æ•°é™åˆ¶ç­‰

**è‡ªç ”ç‰ˆæœ¬ç°çŠ¶**:
- âœ… æœ‰ç±»ä¼¼çš„é€»è¾‘ï¼Œä½†åˆ†æ•£åœ¨å¤šä¸ªæ–‡ä»¶ä¸­
- âš ï¸ ç¼ºå°‘ç»Ÿä¸€çš„è§„èŒƒåŒ–å…¥å£
- âš ï¸ éƒ¨åˆ†è¾¹ç•Œæƒ…å†µå¤„ç†ä¸å®Œå–„

**ç§»æ¤ä»·å€¼**: â­â­â­â­ **é«˜ä¼˜å…ˆçº§**

**ç§»æ¤å»ºè®®**:
1. åˆ›å»º `src/converters/gemini_fix.py`ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
2. ç§»æ¤ `normalize_gemini_request()` å‡½æ•°
3. åœ¨è¯·æ±‚å¤„ç†æµç¨‹ä¸­è°ƒç”¨æ­¤å‡½æ•°

---

### 2.3 Contents æ¸…ç†é€»è¾‘ â­â­â­

**å®˜æ–¹ç‰ˆæœ¬å®ç°**ï¼ˆ`src/converter/gemini_fix.py:294-344`ï¼‰:
```python
# ä¿®å¤ text å­—æ®µï¼šç¡®ä¿æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯åˆ—è¡¨
if "text" in part:
    text_value = part["text"]
    if isinstance(text_value, list):
        # å¦‚æœæ˜¯åˆ—è¡¨ï¼Œåˆå¹¶ä¸ºå­—ç¬¦ä¸²
        log.warning(f"[GEMINI_FIX] text å­—æ®µæ˜¯åˆ—è¡¨ï¼Œè‡ªåŠ¨åˆå¹¶: {text_value}")
        part["text"] = " ".join(str(t) for t in text_value if t)
    elif isinstance(text_value, str):
        # æ¸…ç†å°¾éšç©ºæ ¼
        part["text"] = text_value.rstrip()
    else:
        # å…¶ä»–ç±»å‹è½¬ä¸ºå­—ç¬¦ä¸²
        log.warning(f"[GEMINI_FIX] text å­—æ®µç±»å‹å¼‚å¸¸ ({type(text_value)}), è½¬ä¸ºå­—ç¬¦ä¸²: {text_value}")
        part["text"] = str(text_value)
```

**è‡ªç ”ç‰ˆæœ¬ç°çŠ¶**:
- âŒ ç¼ºå°‘ text å­—æ®µç±»å‹ä¿®å¤é€»è¾‘
- âš ï¸ å¯èƒ½å¯¼è‡´ API è°ƒç”¨å¤±è´¥

**ç§»æ¤ä»·å€¼**: â­â­â­â­ **é«˜ä¼˜å…ˆçº§**

**ç§»æ¤ä½ç½®**:
- `src/antigravity_api.py` - è¯·æ±‚æ„å»ºå‰
- `src/gcli_chat_api.py` - è¯·æ±‚å¤„ç†å‰

---

### 2.4 MCP åœºæ™¯æ™ºèƒ½æ£€æµ‹ â­â­

**å®˜æ–¹ç‰ˆæœ¬å®ç°**ï¼ˆ`src/converter/gemini_fix.py:222-236`ï¼‰:
```python
if "claude" in model.lower():
    # æ£€æµ‹æ˜¯å¦æœ‰å·¥å…·è°ƒç”¨ï¼ˆMCPåœºæ™¯ï¼‰
    has_tool_calls = any(
        isinstance(content, dict) and 
        any(
            isinstance(part, dict) and ("functionCall" in part or "function_call" in part)
            for part in content.get("parts", [])
        )
        for content in contents
    )
    
    if has_tool_calls:
        # MCP åœºæ™¯ï¼šæ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼Œç§»é™¤ thinkingConfig
        log.warning(f"[ANTIGRAVITY] æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼ˆMCPåœºæ™¯ï¼‰ï¼Œç§»é™¤ thinkingConfig é¿å…å¤±æ•ˆ")
        generation_config.pop("thinkingConfig", None)
```

**è‡ªç ”ç‰ˆæœ¬ç°çŠ¶**:
- âŒ æœªå®ç° MCP åœºæ™¯æ£€æµ‹
- âš ï¸ å¯èƒ½å¯¼è‡´ thinking æ¨¡å¼åœ¨å·¥å…·è°ƒç”¨æ—¶å¤±æ•ˆ

**ç§»æ¤ä»·å€¼**: â­â­â­ **ä¸­ä¼˜å…ˆçº§**

**ç§»æ¤ä½ç½®**:
- `src/antigravity_api.py` - `build_antigravity_request_body()` å‡½æ•°
- `src/antigravity_router.py` - è¯·æ±‚å¤„ç†å‰

---

### 2.5 æ›´å¥å£®çš„æ¨¡å‹åç§°å¤„ç† â­â­

**å®˜æ–¹ç‰ˆæœ¬å®ç°**ï¼ˆ`src/converter/gemini_fix.py:66-80`ï¼‰:
```python
def get_base_model_name(model_name: str) -> str:
    """ç§»é™¤æ¨¡å‹åç§°ä¸­çš„åç¼€,è¿”å›åŸºç¡€æ¨¡å‹å"""
    # æŒ‰ç…§ä»é•¿åˆ°çŸ­çš„é¡ºåºæ’åˆ—ï¼Œé¿å… -think å…ˆäº -maxthinking è¢«åŒ¹é…
    suffixes = ["-maxthinking", "-nothinking", "-search", "-think"]
    result = model_name
    changed = True
    # æŒç»­å¾ªç¯ç›´åˆ°æ²¡æœ‰ä»»ä½•åç¼€å¯ä»¥ç§»é™¤
    while changed:
        changed = False
        for suffix in suffixes:
            if result.endswith(suffix):
                result = result[:-len(suffix)]
                changed = True
                # ä¸ä½¿ç”¨ breakï¼Œç»§ç»­æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å…¶ä»–åç¼€
    return result
```

**è‡ªç ”ç‰ˆæœ¬ç°çŠ¶**:
- âœ… æœ‰ç±»ä¼¼å‡½æ•°ï¼Œä½†å¯èƒ½ä¸æ”¯æŒå¾ªç¯ç§»é™¤å¤šä¸ªåç¼€
- âš ï¸ éœ€è¦éªŒè¯æ˜¯å¦èƒ½å¤„ç†å¤æ‚åç¼€ç»„åˆ

**ç§»æ¤ä»·å€¼**: â­â­ **ä¸­ä½ä¼˜å…ˆçº§**

**ç§»æ¤ä½ç½®**:
- `src/converters/gemini_fix.py` - å¦‚æœå·²å­˜åœ¨ï¼Œæ›´æ–°å‡½æ•°
- `src/utils.py` - å¦‚æœå‡½æ•°åœ¨è¿™é‡Œï¼Œæ›´æ–°å®ç°

---

## ä¸‰ã€è¯¦ç»†åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½æ¨¡å— | å®˜æ–¹ç‰ˆæœ¬ | è‡ªç ”ç‰ˆæœ¬ | ç§»æ¤ä¼˜å…ˆçº§ | ç§»æ¤éš¾åº¦ |
|---------|---------|---------|-----------|---------|
| Thinking Budget/Level å†²çªä¿®å¤ | âœ… å·²ä¿®å¤ | âŒ æœªä¿®å¤ | â­â­â­â­â­ | ğŸŸ¢ ä½ |
| ç»Ÿä¸€è¯·æ±‚è§„èŒƒåŒ– | âœ… å®Œæ•´å®ç° | âš ï¸ åˆ†æ•£å®ç° | â­â­â­â­ | ğŸŸ¡ ä¸­ |
| Contents æ¸…ç†é€»è¾‘ | âœ… å®Œå–„ | âŒ ç¼ºå¤± | â­â­â­â­ | ğŸŸ¢ ä½ |
| MCP åœºæ™¯æ£€æµ‹ | âœ… å·²å®ç° | âŒ æœªå®ç° | â­â­â­ | ğŸŸ¡ ä¸­ |
| æ¨¡å‹åç§°å¤„ç† | âœ… å¾ªç¯ç§»é™¤ | âš ï¸ éœ€éªŒè¯ | â­â­ | ğŸŸ¢ ä½ |
| å›¾åƒç”Ÿæˆè¯·æ±‚å¤„ç† | âœ… å®Œæ•´ | âš ï¸ éœ€å¯¹æ¯” | â­â­ | ğŸŸ¡ ä¸­ |
| å‚æ•°èŒƒå›´é™åˆ¶ | âœ… å¼ºåˆ¶é™åˆ¶ | âš ï¸ éƒ¨åˆ†é™åˆ¶ | â­â­ | ğŸŸ¢ ä½ |

---

## å››ã€ç§»æ¤å®æ–½å»ºè®®

### 4.1 é«˜ä¼˜å…ˆçº§ç§»æ¤ï¼ˆç«‹å³å®æ–½ï¼‰

#### ç§»æ¤ 1: Thinking Budget/Level å†²çªä¿®å¤

**ç›®æ ‡æ–‡ä»¶**: 
- `src/converters/tool_converter.py`
- `src/anthropic_converter.py`

**ä¿®æ”¹å†…å®¹**:
```python
# åœ¨è®¾ç½® thinkingBudget åï¼Œæ˜ç¡®ç§»é™¤ thinkingLevel
if "thinkingBudget" in thinking_config:
    thinking_config.pop("thinkingLevel", None)  # é¿å…å†²çª
```

**é¢„æœŸæ•ˆæœ**: æ¶ˆé™¤ 400 é”™è¯¯ï¼Œæé«˜è¯·æ±‚æˆåŠŸç‡

---

#### ç§»æ¤ 2: Contents æ¸…ç†é€»è¾‘

**ç›®æ ‡æ–‡ä»¶**: 
- `src/antigravity_api.py`
- `src/gcli_chat_api.py`

**ä¿®æ”¹å†…å®¹**: æ·»åŠ  text å­—æ®µç±»å‹ä¿®å¤å’Œç©º part è¿‡æ»¤é€»è¾‘

**é¢„æœŸæ•ˆæœ**: æé«˜è¯·æ±‚å…¼å®¹æ€§ï¼Œå‡å°‘æ ¼å¼é”™è¯¯

---

### 4.2 ä¸­ä¼˜å…ˆçº§ç§»æ¤ï¼ˆ1 å‘¨å†…ï¼‰

#### ç§»æ¤ 3: MCP åœºæ™¯æ£€æµ‹

**ç›®æ ‡æ–‡ä»¶**: `src/antigravity_api.py`

**ä¿®æ”¹å†…å®¹**: åœ¨æ„å»ºè¯·æ±‚å‰æ£€æµ‹å·¥å…·è°ƒç”¨ï¼Œè‡ªåŠ¨ç§»é™¤ thinkingConfig

**é¢„æœŸæ•ˆæœ**: æé«˜ MCP åœºæ™¯ä¸‹çš„ç¨³å®šæ€§

---

#### ç§»æ¤ 4: ç»Ÿä¸€è¯·æ±‚è§„èŒƒåŒ–

**ç›®æ ‡æ–‡ä»¶**: `src/converters/gemini_fix.py`ï¼ˆæ–°å»ºæˆ–æ›´æ–°ï¼‰

**ä¿®æ”¹å†…å®¹**: ç§»æ¤ `normalize_gemini_request()` å‡½æ•°

**é¢„æœŸæ•ˆæœ**: ç»Ÿä¸€è¯·æ±‚å¤„ç†é€»è¾‘ï¼Œå‡å°‘ä»£ç é‡å¤

---

### 4.3 ä½ä¼˜å…ˆçº§ç§»æ¤ï¼ˆæŒç»­ä¼˜åŒ–ï¼‰

#### ç§»æ¤ 5: æ¨¡å‹åç§°å¤„ç†ä¼˜åŒ–

**ç›®æ ‡æ–‡ä»¶**: `src/converters/gemini_fix.py` æˆ– `src/utils.py`

**ä¿®æ”¹å†…å®¹**: æ›´æ–° `get_base_model_name()` å‡½æ•°ï¼Œæ”¯æŒå¾ªç¯ç§»é™¤å¤šä¸ªåç¼€

**é¢„æœŸæ•ˆæœ**: æé«˜æ¨¡å‹åç§°è§£æçš„å¥å£®æ€§

---

## äº”ã€ä»£ç å¯¹æ¯”è¯¦æƒ…

### 5.1 Thinking Budget å¤„ç†å¯¹æ¯”

**å®˜æ–¹ç‰ˆæœ¬**ï¼ˆ`gemini_fix.py:169-171`ï¼‰:
```python
# è®¾ç½®æ€è€ƒé¢„ç®—
if thinking_budget:
    thinking_config["thinkingBudget"] = thinking_budget
    thinking_config.pop("thinkingLevel", None)  # é¿å…ä¸ thinkingBudget å†²çª
```

**è‡ªç ”ç‰ˆæœ¬**ï¼ˆ`tool_converter.py:519-522`ï¼‰:
```python
config_dict["thinkingConfig"] = {
    "includeThoughts": True,
    "thinkingBudget": thinking_budget
}
# âŒ ç¼ºå°‘ thinkingLevel ç§»é™¤é€»è¾‘
```

**å·®å¼‚**: å®˜æ–¹ç‰ˆæœ¬æ˜ç¡®ç§»é™¤äº† `thinkingLevel`ï¼Œé¿å…å†²çª

---

### 5.2 Contents æ¸…ç†å¯¹æ¯”

**å®˜æ–¹ç‰ˆæœ¬**ï¼ˆ`gemini_fix.py:315-328`ï¼‰:
```python
# ä¿®å¤ text å­—æ®µï¼šç¡®ä¿æ˜¯å­—ç¬¦ä¸²è€Œä¸æ˜¯åˆ—è¡¨
if "text" in part:
    text_value = part["text"]
    if isinstance(text_value, list):
        part["text"] = " ".join(str(t) for t in text_value if t)
    elif isinstance(text_value, str):
        part["text"] = text_value.rstrip()
    else:
        part["text"] = str(text_value)
```

**è‡ªç ”ç‰ˆæœ¬**: âŒ æœªå®ç°æ­¤é€»è¾‘

**å·®å¼‚**: å®˜æ–¹ç‰ˆæœ¬æœ‰å®Œå–„çš„ç±»å‹ä¿®å¤å’Œæ¸…ç†é€»è¾‘

---

### 5.3 MCP åœºæ™¯æ£€æµ‹å¯¹æ¯”

**å®˜æ–¹ç‰ˆæœ¬**ï¼ˆ`gemini_fix.py:222-236`ï¼‰:
```python
if "claude" in model.lower():
    has_tool_calls = any(...)  # æ£€æµ‹å·¥å…·è°ƒç”¨
    if has_tool_calls:
        generation_config.pop("thinkingConfig", None)  # ç§»é™¤ thinkingConfig
```

**è‡ªç ”ç‰ˆæœ¬**: âŒ æœªå®ç°æ­¤æ£€æµ‹

**å·®å¼‚**: å®˜æ–¹ç‰ˆæœ¬èƒ½æ™ºèƒ½æ£€æµ‹ MCP åœºæ™¯å¹¶è‡ªåŠ¨è°ƒæ•´é…ç½®

---

## å…­ã€ç§»æ¤é£é™©è¯„ä¼°

### 6.1 ä½é£é™©ç§»æ¤

- âœ… Thinking Budget/Level å†²çªä¿®å¤ï¼ˆç®€å•æ·»åŠ ä¸€è¡Œä»£ç ï¼‰
- âœ… Contents æ¸…ç†é€»è¾‘ï¼ˆç‹¬ç«‹å‡½æ•°ï¼Œä¸å½±å“ç°æœ‰é€»è¾‘ï¼‰
- âœ… æ¨¡å‹åç§°å¤„ç†ä¼˜åŒ–ï¼ˆå‘åå…¼å®¹ï¼‰

### 6.2 ä¸­é£é™©ç§»æ¤

- âš ï¸ MCP åœºæ™¯æ£€æµ‹ï¼ˆéœ€è¦ç†è§£ç°æœ‰è¯·æ±‚æµç¨‹ï¼‰
- âš ï¸ ç»Ÿä¸€è¯·æ±‚è§„èŒƒåŒ–ï¼ˆå¯èƒ½å½±å“ç°æœ‰è°ƒç”¨ç‚¹ï¼‰

### 6.3 æµ‹è¯•å»ºè®®

1. **å•å…ƒæµ‹è¯•**: ä¸ºæ¯ä¸ªç§»æ¤åŠŸèƒ½æ·»åŠ æµ‹è¯•ç”¨ä¾‹
2. **é›†æˆæµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„è¯·æ±‚æµç¨‹
3. **å›å½’æµ‹è¯•**: ç¡®ä¿ç°æœ‰åŠŸèƒ½ä¸å—å½±å“

---

## ä¸ƒã€æ€»ç»“

### 7.1 æ ¸å¿ƒå‘ç°

1. **å®˜æ–¹ç‰ˆæœ¬åœ¨ Thinking Budget å¤„ç†ä¸Šæ›´å®Œå–„**ï¼Œæ˜ç¡®ç§»é™¤äº†å†²çªå­—æ®µ
2. **å®˜æ–¹ç‰ˆæœ¬æœ‰æ›´å®Œå–„çš„è¯·æ±‚è§„èŒƒåŒ–é€»è¾‘**ï¼Œç»Ÿä¸€å¤„ç†å„ç§è¾¹ç•Œæƒ…å†µ
3. **å®˜æ–¹ç‰ˆæœ¬æœ‰ MCP åœºæ™¯æ™ºèƒ½æ£€æµ‹**ï¼Œæé«˜å·¥å…·è°ƒç”¨åœºæ™¯ä¸‹çš„ç¨³å®šæ€§

### 7.2 ç§»æ¤ä¼˜å…ˆçº§

**ç«‹å³å®æ–½**:
1. Thinking Budget/Level å†²çªä¿®å¤
2. Contents æ¸…ç†é€»è¾‘

**1 å‘¨å†…å®æ–½**:
3. MCP åœºæ™¯æ£€æµ‹
4. ç»Ÿä¸€è¯·æ±‚è§„èŒƒåŒ–

**æŒç»­ä¼˜åŒ–**:
5. æ¨¡å‹åç§°å¤„ç†ä¼˜åŒ–

### 7.3 é¢„æœŸæ”¶ç›Š

- âœ… **æé«˜è¯·æ±‚æˆåŠŸç‡**: ä¿®å¤ Thinking Budget å†²çªå¯¼è‡´çš„ 400 é”™è¯¯
- âœ… **æé«˜å…¼å®¹æ€§**: Contents æ¸…ç†é€»è¾‘å¤„ç†å„ç§æ ¼å¼å¼‚å¸¸
- âœ… **æé«˜ç¨³å®šæ€§**: MCP åœºæ™¯æ£€æµ‹é¿å…å·¥å…·è°ƒç”¨å¤±æ•ˆ
- âœ… **ä»£ç è´¨é‡**: ç»Ÿä¸€è§„èŒƒåŒ–é€»è¾‘å‡å°‘ä»£ç é‡å¤

---

## å…«ã€å‚è€ƒèµ„æ–™

- å®˜æ–¹ç‰ˆæœ¬æºç : `gcli2api_official/src/converter/gemini_fix.py`
- å®˜æ–¹ç‰ˆæœ¬ PR: #291 (fix/thinking-budget-level-conflict)
- è‡ªç ”ç‰ˆæœ¬æºç : `gcli2api/src/converters/tool_converter.py`
- è‡ªç ”ç‰ˆæœ¬æºç : `gcli2api/src/anthropic_converter.py`

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2026-01-17  
**ç»´æŠ¤è€…**: æµ®æµ®é…± (Claude Opus 4)
