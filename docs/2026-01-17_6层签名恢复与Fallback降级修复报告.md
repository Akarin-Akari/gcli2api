# 6层签名恢复与Fallback降级修复报告

**文档创建时间**: 2026-01-17 08:30
**作者**: Claude Opus 4.5 (浮浮酱)
**项目**: gcli2api
**严重程度**: P0 Critical

---

## 一、问题描述

### 1.1 用户报告

在实现了6层签名缓存架构后，Claude Code 反而出现了丢工具ID的状况：

```
[08:09:44] [WARNING] [SIGNATURE_RECOVERY] All 6 layers failed for tool_id=call_644a6dbd0d0afb79a8c04e9f
[08:09:44] [WARNING] [ANTHROPIC CONVERTER] No signature found for tool call: call_644a6dbd0d0afb79a8c04e9f, using placeholder
```

### 1.2 影响范围

- 所有使用工具调用的 Claude Code 对话
- 工具调用丢失签名 → thinking 模式被禁用 → 功能降级

---

## 二、根因分析

### 2.1 6层恢复策略失败原因

| Layer | 策略 | 失败原因 |
|-------|------|---------|
| **Layer 1** | Client signature | Claude Code 发送的工具ID是原始格式 `call_xxx`，没有编码签名 |
| **Layer 2** | Context signature | **硬编码为 `None`**（注释说"工具调用不关联 thinking"） |
| **Layer 3** | Encoded Tool ID | 无法从原始ID解码出签名 |
| **Layer 4** | Session Cache | 时序问题：请求阶段执行时，Session缓存还没写入 |
| **Layer 5** | Tool Cache | 时序问题：第一轮请求时缓存是空的 |
| **Layer 6** | Last Signature | 可能为空或类型不匹配 |

### 2.2 核心问题

**Layer 2 被硬编码为 `None`**！

```python
# 修复前（有问题）
final_sig = recover_signature_for_tool_use(
    ...
    last_thought_signature=None,  # ❌ 硬编码为 None
    ...
)
```

但实际上，Claude 的 **thinking 块和 tool_use 块在同一个 assistant 消息中**，thinking 块的签名应该传递给同一消息中的 tool_use 块！

---

## 三、修复内容

### 3.1 修复1：添加签名跟踪变量

**位置**: `anthropic_converter.py` 第572-584行

```python
# [FIX 2026-01-17] 跟踪最近的 thinking 签名，用于工具调用恢复
# 关键修复：Claude 的 thinking 块和 tool_use 块在同一个 assistant 消息中
# thinking 块的签名应该传递给同一消息中的 tool_use 块
last_thinking_signature: Optional[str] = None

for msg in messages:
    ...
    # [FIX 2026-01-17] 每个消息开始时重置当前消息的 thinking 签名
    current_msg_thinking_signature: Optional[str] = None
```

### 3.2 修复2：在处理 thinking 块时保存签名

**位置**: `anthropic_converter.py` 第667-671行

```python
# [FIX 2026-01-17] 保存当前消息的 thinking 签名，用于同一消息中的 tool_use 块
current_msg_thinking_signature = final_signature
last_thinking_signature = final_signature
log.debug(f"[ANTHROPIC CONVERTER] Saved thinking signature for tool_use recovery: sig_len={len(final_signature)}")
```

### 3.3 修复3：在处理 tool_use 块时使用保存的签名

**位置**: `anthropic_converter.py` 第787-798行

```python
# [FIX 2026-01-17] 关键修复：使用同一消息中的 thinking 签名作为上下文签名
# 优先使用当前消息的 thinking 签名，其次使用最近的 thinking 签名
context_signature = current_msg_thinking_signature or last_thinking_signature
final_sig = recover_signature_for_tool_use(
    tool_id=original_id,
    encoded_tool_id=encoded_id,
    signature=thoughtsignature,
    last_thought_signature=context_signature,  # [FIX 2026-01-17] 传入上下文签名
    session_id=session_id
)
```

### 3.4 修复4：Fallback 降级到 text（同步 Antigravity-Manager）

**位置**: `anthropic_converter.py` 第678-686行, 第752-760行

```python
# [FIX 2026-01-17] 所有恢复策略都失败，降级为 text 块而不是跳过
# 参考 Antigravity-Manager v3.3.35 的实现
if thinking_text and thinking_text.strip():
    parts.append({"text": f"[Previous thinking: {thinking_text}]"})
    log.info(f"[ANTHROPIC CONVERTER] Thinking block 签名恢复失败，降级为 text: "
             f"thinking_len={len(thinking_text)}")
else:
    log.warning(f"[ANTHROPIC CONVERTER] Thinking block 所有恢复策略失败且内容为空，跳过此 block")
```

---

## 四、修复效果

### 4.1 6层恢复策略现在可以正常工作

| Layer | 修复前 | 修复后 |
|-------|--------|--------|
| **Layer 2** | 永远为 None | ✅ 使用同一消息中的 thinking 签名 |

### 4.2 Fallback 策略改进

| 场景 | 修复前 | 修复后 |
|------|--------|--------|
| 签名恢复失败 | 直接跳过 → 内容丢失 | 降级为 text → 内容保留 |

---

## 五、测试验证

### 5.1 测试结果

```
======================= 19 passed, 2 warnings in 0.41s ========================
```

### 5.2 语法检查

```
Syntax check passed!
```

---

## 六、同步的 Antigravity-Manager 策略

根据 Antigravity-Manager v3.3.35 的更新，本次同步了以下策略：

| 策略 | 状态 | 说明 |
|------|------|------|
| 降级 thinking 到 text | ✅ 已实现 | 保留上下文内容 |
| Fallback 重试时保持 thinking 模式 | ⏳ 待实现 | 需要在路由层实现 |
| 强制重试 thinking signature 错误 | ⏳ 待实现 | 需要在路由层实现 |

---

## 七、后续建议

### 7.1 P1 优化

1. **实现 400 错误自动重试**：遇到 `Invalid signature` 错误时自动重试
2. **保持 thinking 模式启用**：重试时不禁用 thinking 模式

### 7.2 P2 优化

1. **添加更多日志**：记录每层恢复策略的尝试结果
2. **监控面板**：将签名恢复统计暴露到 Web 管理界面

---

## 八、总结

### 8.1 修复内容

- ✅ 修复 Layer 2 (Context signature) 硬编码为 None 的问题
- ✅ 实现 thinking 签名跨块传递
- ✅ 同步 Antigravity-Manager 的 Fallback 降级策略

### 8.2 预期效果

- 6层签名恢复策略的 Layer 2 现在可以正常工作
- 签名恢复失败时内容不再丢失
- Claude Code 工具调用功能恢复正常

---

**文档结束**

祝下一个 Claude Agent 开发顺利喵～ ฅ'ω'ฅ
