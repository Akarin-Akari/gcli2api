# 多步推理失效诊断报告

**日期**: 2026-01-12
**作者**: Claude Opus 4.5 (浮浮酱)
**问题类型**: Signature 缓存架构问题

---

## 问题描述

用户反馈：gcli2api 在为 Cursor 转发 Claude 模型时，多步推理功能失效。

## 诊断结论

### 根本原因

**Signature 缓存采用纯内存存储，服务重启后缓存丢失，导致 thinking 模式被强制禁用。**

### 触发机制

```
服务重启
    ↓
内存缓存清空
    ↓
Cursor 发送包含历史 thinking block 的请求
    ↓
系统检测到 thinking block 但无法找到对应的 signature
    ↓
为避免 Claude API 400 错误，强制禁用 thinking 模式
    ↓
多步推理功能失效
```

### 日志证据

```json
{"message": "[ANTIGRAVITY] Thinking 已启用，但历史消息中没有有效的 thinking block（包含 signature），禁用 thinking 模式以避免 400 错误"}
{"thinking": false}
```

### 代码位置

**antigravity_router.py:1796-1805**
```python
if any_thinking_found and not all_thinking_valid:
    # 尝试 fallback 到最近的缓存 signature
    last_sig = get_last_signature()
    if last_sig:
        log.info("找到最近缓存的 signature，保持 thinking 模式启用")
        all_thinking_valid = True
    else:
        log.warning("禁用 thinking 模式以避免 400 错误")
        enable_thinking = False
```

---

## 架构分析

### 旧架构 (LEGACY_ONLY) 的问题

| 问题 | 影响 | 严重程度 |
|------|------|----------|
| 服务重启后缓存丢失 | thinking 模式被禁用，多步推理失效 | **严重** |
| 无对话隔离 | 多对话共享同一缓存，可能出现串扰 | 中等 |
| 无持久化 | 长时间运行后内存占用增长 | 低 |

### 新架构 v2.0 的优势

1. **L1 内存缓存 + L2 SQLite 持久化**
   - 服务重启后可从 SQLite 恢复 signature
   - 解决多步推理失效的根本问题

2. **对话指纹隔离**
   - 每个对话有独立的缓存空间
   - 避免多对话串扰

3. **渐进式迁移策略**
   - 四阶段迁移：LEGACY_ONLY → DUAL_WRITE → NEW_PREFERRED → NEW_ONLY
   - 可随时回滚，风险可控

---

## 是否应该用新架构取代旧的？

### 答案：是的，但应该渐进式迁移

**理由**：
1. 新架构 v2.0 已经过验收测试，功能完备
2. 四阶段迁移策略风险可控
3. 旧架构的固有缺陷（无持久化）无法通过其他方式解决

---

## 修复方案

### 方案A：快速修复（推荐）

**启用 DUAL_WRITE 阶段**，让新缓存开始持久化 signature：

#### 方式1：环境变量（推荐）
```bash
export CACHE_USE_MIGRATION_ADAPTER=true
export CACHE_MIGRATION_PHASE=2
```

#### 方式2：代码调用
```python
from signature_cache import enable_migration_mode, set_migration_phase
enable_migration_mode()
set_migration_phase('DUAL_WRITE')
```

#### 方式3：API 调用
```bash
POST /cache/migration/enable-phase2
```

### 方案B：完全迁移到新架构

如果 DUAL_WRITE 运行稳定，可以逐步升级：

| 阶段 | 名称 | 操作 | 观察时间 |
|------|------|------|----------|
| Phase 2 | DUAL_WRITE | 同时写入新旧缓存 | 1-2 天 |
| Phase 3 | NEW_PREFERRED | 优先读新缓存 | 1-2 天 |
| Phase 4 | NEW_ONLY | 完全切换 | 永久 |

---

## 验证方法

启用后检查：

1. **重启服务后检查日志**
   - 不应再出现 `thinking=False` 的警告
   - 应看到 `找到最近缓存的 signature，保持 thinking 模式启用`

2. **查看缓存统计**
   ```bash
   GET /cache/migration/stats
   ```

3. **验证多步推理**
   - 在 Cursor 中发起需要多步推理的请求
   - 确认 Claude 能够正常进行工具调用循环

---

## 风险提示

- DUAL_WRITE 阶段风险最低，可随时回滚
- 建议在非高峰期启用
- 启用后监控 `/cache/migration/stats` 接口
- 如遇问题，可通过以下方式回滚：
  ```python
  from signature_cache import disable_migration_mode
  disable_migration_mode()
  ```

---

## 总结

| 项目 | 说明 |
|------|------|
| **问题根因** | 纯内存缓存无法在服务重启后恢复 signature |
| **影响范围** | 所有使用 thinking 模式的多步推理请求 |
| **修复方案** | 启用 DUAL_WRITE 阶段，逐步迁移到新缓存架构 |
| **风险等级** | 低（可随时回滚） |
| **建议操作** | 立即启用 DUAL_WRITE，观察稳定后逐步升级 |

---

*诊断完成，建议立即启用 DUAL_WRITE 阶段以恢复多步推理功能！*
