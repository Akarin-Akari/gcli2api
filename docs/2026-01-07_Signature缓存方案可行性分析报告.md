# Signature ç¼“å­˜æ–¹æ¡ˆå¯è¡Œæ€§åˆ†ææŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-07
**åˆ†æäºº**: Claude Opus 4.5 (æµ®æµ®é…±)
**ç ”ç©¶ç›®æ ‡**: éªŒè¯ç”¨æˆ·æå‡ºçš„ signature ç¼“å­˜æ–¹æ¡ˆçš„æŠ€æœ¯å¯è¡Œæ€§

---

## ç”¨æˆ·å‡è®¾éªŒè¯

### åŸå§‹å‡è®¾

ç”¨æˆ·æå‡ºäº†ä¸€ä¸ªå…³é”®æ´å¯Ÿï¼š

> 1. Antigravity è¿”å›çš„ signature æ˜¯çœŸå®æœ‰æ•ˆçš„ï¼ˆæ¥è‡ª Anthropicï¼‰
> 2. é—®é¢˜ä¸æ˜¯"æ‹¿ä¸åˆ° signature"ï¼Œè€Œæ˜¯"Cursor ä¸¢å¼ƒäº† signature"
> 3. è§£å†³æ–¹æ¡ˆï¼šåœ¨ä»£ç†å±‚ç¼“å­˜ signature

### éªŒè¯ç»“æœï¼šâœ… å‡è®¾å®Œå…¨æ­£ç¡®ï¼

---

## é—®é¢˜æ ¹æºåˆ†æ

### æ•°æ®æµè¿½è¸ª

```
ç¬¬ä¸€è½®è¯·æ±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cursor å‘é€è¯·æ±‚ï¼ˆOpenAI æ ¼å¼ï¼‰                                           â”‚
â”‚     â†“                                                                   â”‚
â”‚ gcli2api è½¬æ¢ä¸º Antigravity æ ¼å¼                                         â”‚
â”‚     â†“                                                                   â”‚
â”‚ Antigravity è¿”å›å“åº”ï¼ˆåŒ…å« thinking + signatureï¼‰                        â”‚
â”‚     â†“                                                                   â”‚
â”‚ gcli2api è½¬æ¢ä¸º OpenAI æ ¼å¼                                              â”‚
â”‚     â”œâ”€ thinking â†’ reasoning_contentï¼ˆçº¯æ–‡æœ¬ï¼‰                            â”‚
â”‚     â””â”€ signature â†’ âŒ ä¸¢å¤±ï¼ï¼ˆOpenAI æ ¼å¼æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼‰                   â”‚
â”‚     â†“                                                                   â”‚
â”‚ Cursor æ”¶åˆ°å“åº”ï¼ˆæ²¡æœ‰ signatureï¼‰                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç¬¬äºŒè½®è¯·æ±‚ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cursor å‘é€è¯·æ±‚ï¼ˆåŒ…å«å†å²æ¶ˆæ¯ï¼‰                                          â”‚
â”‚     â”œâ”€ å†å² assistant æ¶ˆæ¯åŒ…å« reasoning_content                         â”‚
â”‚     â””â”€ âŒ æ²¡æœ‰ signatureï¼ˆå› ä¸ºä»æœªæ”¶åˆ°è¿‡ï¼‰                               â”‚
â”‚     â†“                                                                   â”‚
â”‚ gcli2api æ£€æµ‹å†å²æ¶ˆæ¯                                                    â”‚
â”‚     â”œâ”€ å‘ç°æœ‰ thinking å†…å®¹                                              â”‚
â”‚     â””â”€ âŒ æ²¡æœ‰æœ‰æ•ˆçš„ signature                                           â”‚
â”‚     â†“                                                                   â”‚
â”‚ gcli2api è¢«è¿«ç¦ç”¨ thinking æ¨¡å¼                                          â”‚
â”‚     â””â”€ é¿å… 400 é”™è¯¯ï¼š"thinking.signature: Field required"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä»£ç è¯æ®

#### è¯æ® 1: Antigravity ç¡®å®è¿”å› signature

`src/anthropic_streaming.py:243-257`:
```python
signature = part.get("thoughtSignature")
if (signature and state._current_block_type == "thinking"
    and not state._current_thinking_signature):
    evt = _sse_event("content_block_delta", {
        "delta": {"type": "signature_delta", "signature": signature}
    })
    state._current_thinking_signature = str(signature)
```

#### è¯æ® 2: OpenAI æ ¼å¼æ²¡æœ‰ signature å­—æ®µ

`src/models.py:55`:
```python
class OpenAIChatMessage(BaseModel):
    reasoning_content: Optional[str] = None  # åªæœ‰æ–‡æœ¬ï¼Œæ²¡æœ‰ signatureï¼
```

`src/openai_transfer.py:306-312`:
```python
def _build_message_with_reasoning(role: str, content: str, reasoning_content: str) -> dict:
    message = {"role": role, "content": content}
    if reasoning_content:
        message["reasoning_content"] = reasoning_content  # åªæœ‰æ–‡æœ¬ï¼
    return message
```

#### è¯æ® 3: gcli2api æ£€æµ‹åˆ°ç¼ºå°‘ signature åç¦ç”¨ thinking

`src/antigravity_router.py:1559`:
```python
log.warning("Thinking å·²å¯ç”¨ï¼Œä½†å†å²æ¶ˆæ¯ä¸­æ²¡æœ‰æœ‰æ•ˆçš„ thinking blockï¼ˆåŒ…å« signatureï¼‰ï¼Œç¦ç”¨ thinking æ¨¡å¼ä»¥é¿å… 400 é”™è¯¯")
enable_thinking = False
```

---

## Signature ç¼“å­˜æ–¹æ¡ˆè®¾è®¡

### æ–¹æ¡ˆæ¦‚è¿°

```
å“åº”é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Antigravity è¿”å› thinking + signature                                   â”‚
â”‚     â†“                                                                   â”‚
â”‚ gcli2api ä»£ç†                                                           â”‚
â”‚     â”œâ”€ æå– thinking å†…å®¹å’Œ signature                                    â”‚
â”‚     â”œâ”€ ğŸ’¾ ç¼“å­˜ signatureï¼ˆkey = thinking å†…å®¹çš„å“ˆå¸Œï¼‰                    â”‚
â”‚     â””â”€ è½¬æ¢ä¸º OpenAI æ ¼å¼ï¼ˆreasoning_contentï¼‰                           â”‚
â”‚     â†“                                                                   â”‚
â”‚ è¿”å›ç»™ Cursor                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è¯·æ±‚é˜¶æ®µï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cursor å‘é€è¯·æ±‚ï¼ˆåŒ…å« reasoning_contentï¼‰                                â”‚
â”‚     â†“                                                                   â”‚
â”‚ gcli2api ä»£ç†                                                           â”‚
â”‚     â”œâ”€ æ£€æµ‹åˆ°å†å²æ¶ˆæ¯æœ‰ reasoning_content                                â”‚
â”‚     â”œâ”€ ğŸ”„ ç”¨ reasoning_content çš„å“ˆå¸ŒæŸ¥æ‰¾ç¼“å­˜                            â”‚
â”‚     â”œâ”€ æ¢å¤å¯¹åº”çš„ signature                                              â”‚
â”‚     â””â”€ é‡å»º thinking block + signature                                   â”‚
â”‚     â†“                                                                   â”‚
â”‚ å‘é€ç»™ Antigravityï¼ˆåŒ…å«å®Œæ•´çš„ signatureï¼‰                               â”‚
â”‚     â†“                                                                   â”‚
â”‚ âœ… Claude éªŒè¯ signature é€šè¿‡                                            â”‚
â”‚ âœ… Thinking æ¨¡å¼ä¿æŒå¯ç”¨                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨èå®ç°æ–¹æ¡ˆï¼šåŸºäº Thinking å†…å®¹çš„ç¼“å­˜

#### æ ¸å¿ƒæ•°æ®ç»“æ„

```python
import hashlib
from typing import Dict, Optional
from collections import OrderedDict
import time

class SignatureCache:
    """Thinking Signature ç¼“å­˜ç®¡ç†å™¨"""

    def __init__(self, max_size: int = 10000, ttl_seconds: int = 3600):
        self._cache: OrderedDict[str, tuple[str, float]] = OrderedDict()
        self._max_size = max_size
        self._ttl = ttl_seconds

    def _generate_key(self, thinking_text: str) -> str:
        """ç”Ÿæˆç¼“å­˜ keyï¼ˆåŸºäº thinking å†…å®¹çš„å“ˆå¸Œï¼‰"""
        # å–å‰ 500 ä¸ªå­—ç¬¦ï¼Œé¿å…è¿‡é•¿çš„ thinking å½±å“æ€§èƒ½
        text_prefix = thinking_text[:500] if thinking_text else ""
        return hashlib.md5(text_prefix.encode('utf-8')).hexdigest()

    def cache(self, thinking_text: str, signature: str) -> None:
        """ç¼“å­˜ signature"""
        key = self._generate_key(thinking_text)
        self._cache[key] = (signature, time.time())

        # LRU æ·˜æ±°
        while len(self._cache) > self._max_size:
            self._cache.popitem(last=False)

    def get(self, thinking_text: str) -> Optional[str]:
        """è·å–ç¼“å­˜çš„ signature"""
        key = self._generate_key(thinking_text)
        if key not in self._cache:
            return None

        signature, timestamp = self._cache[key]

        # æ£€æŸ¥ TTL
        if time.time() - timestamp > self._ttl:
            del self._cache[key]
            return None

        # æ›´æ–°è®¿é—®é¡ºåºï¼ˆLRUï¼‰
        self._cache.move_to_end(key)
        return signature

# å…¨å±€ç¼“å­˜å®ä¾‹
signature_cache = SignatureCache()
```

#### å“åº”é˜¶æ®µé›†æˆ

ä¿®æ”¹ `src/anthropic_streaming.py`:

```python
from .signature_cache import signature_cache

def open_thinking_block(self, signature: Optional[str], thinking_text: str = "") -> bytes:
    idx = self._next_index()
    self._current_block_type = "thinking"
    self._current_thinking_signature = signature

    # ğŸ’¾ ç¼“å­˜ signature
    if signature and thinking_text:
        signature_cache.cache(thinking_text, signature)

    block: Dict[str, Any] = {"type": "thinking", "thinking": ""}
    if signature:
        block["signature"] = signature
    # ... å…¶ä½™ä»£ç ä¸å˜
```

#### è¯·æ±‚é˜¶æ®µé›†æˆ

ä¿®æ”¹ `src/converters/message_converter.py`:

```python
from .signature_cache import signature_cache

def openai_messages_to_antigravity_contents(
    messages: List[Any],
    enable_thinking: bool = False,
    tools: Optional[List[Dict[str, Any]]] = None,
) -> List[Dict[str, Any]]:
    """è½¬æ¢ OpenAI æ ¼å¼æ¶ˆæ¯ä¸º Antigravity æ ¼å¼"""

    for msg in messages:
        if msg.get("role") == "assistant":
            reasoning_content = msg.get("reasoning_content")
            if reasoning_content:
                # ğŸ”„ ä»ç¼“å­˜æ¢å¤ signature
                cached_signature = signature_cache.get(reasoning_content)
                if cached_signature:
                    # é‡å»º thinking block
                    thinking_block = {
                        "type": "thinking",
                        "thinking": reasoning_content,
                        "signature": cached_signature
                    }
                    # æ·»åŠ åˆ°æ¶ˆæ¯å†…å®¹ä¸­
                    # ...

    # ... å…¶ä½™è½¬æ¢é€»è¾‘
```

### æŠ€æœ¯å¯è¡Œæ€§è¯„ä¼°

| è¯„ä¼°ç»´åº¦ | è¯„ä¼°ç»“æœ | è¯´æ˜ |
|---------|---------|------|
| **å®ç°å¤æ‚åº¦** | âœ… ä½ | åªéœ€æ·»åŠ ç¼“å­˜é€»è¾‘ï¼Œä¸æ”¹å˜ç°æœ‰æ¶æ„ |
| **æ€§èƒ½å½±å“** | âœ… å¯å¿½ç•¥ | MD5 å“ˆå¸Œå’Œå†…å­˜æŸ¥æ‰¾éƒ½æ˜¯ O(1) æ“ä½œ |
| **å†…å­˜å ç”¨** | âœ… å¯æ§ | è®¾ç½® max_size å’Œ TTL é™åˆ¶ |
| **å¹¶å‘å®‰å…¨** | âš ï¸ éœ€æ³¨æ„ | ä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ•°æ®ç»“æ„æˆ–åŠ é” |
| **åˆ†å¸ƒå¼åœºæ™¯** | âš ï¸ éœ€æ‰©å±• | å¤šå®ä¾‹éœ€å…±äº«ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰ |
| **å…¼å®¹æ€§** | âœ… å®Œå…¨å…¼å®¹ | ä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼Œé€æ˜å¢å¼º |

### é£é™©å’Œé™åˆ¶

1. **å†…å­˜å ç”¨**
   - é£é™©ï¼šå¤§é‡å¯¹è¯å¯èƒ½å ç”¨è¾ƒå¤šå†…å­˜
   - ç¼“è§£ï¼šè®¾ç½® max_sizeï¼ˆå¦‚ 10000ï¼‰å’Œ TTLï¼ˆå¦‚ 1 å°æ—¶ï¼‰

2. **å¹¶å‘å®‰å…¨**
   - é£é™©ï¼šå¤šçº¿ç¨‹è®¿é—®å¯èƒ½å¯¼è‡´ç«æ€æ¡ä»¶
   - ç¼“è§£ï¼šä½¿ç”¨ `threading.Lock` æˆ– `asyncio.Lock`

3. **åˆ†å¸ƒå¼åœºæ™¯**
   - é£é™©ï¼šå¤šä¸ª gcli2api å®ä¾‹æ— æ³•å…±äº«ç¼“å­˜
   - ç¼“è§£ï¼šä½¿ç”¨ Redis ä½œä¸ºå…±äº«ç¼“å­˜

4. **Thinking å†…å®¹å˜åŒ–**
   - é£é™©ï¼šå¦‚æœ Cursor ä¿®æ”¹äº† reasoning_contentï¼Œå“ˆå¸Œä¼šä¸åŒ¹é…
   - ç¼“è§£ï¼šCursor é€šå¸¸ä¸ä¼šä¿®æ”¹å†å²æ¶ˆæ¯å†…å®¹

---

## å®æ–½å»ºè®®

### é˜¶æ®µ 1: åŸºç¡€å®ç°ï¼ˆæ¨èå…ˆåšï¼‰

1. åˆ›å»º `src/signature_cache.py` æ¨¡å—
2. åœ¨å“åº”é˜¶æ®µç¼“å­˜ signature
3. åœ¨è¯·æ±‚é˜¶æ®µæ¢å¤ signature
4. æ·»åŠ æ—¥å¿—å’Œç›‘æ§

### é˜¶æ®µ 2: å¢å¼ºåŠŸèƒ½

1. æ·»åŠ  Redis æ”¯æŒï¼ˆåˆ†å¸ƒå¼åœºæ™¯ï¼‰
2. æ·»åŠ ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
3. æ·»åŠ ç¼“å­˜é¢„çƒ­æœºåˆ¶

### é˜¶æ®µ 3: ä¼˜åŒ–å’Œç›‘æ§

1. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¦‚ä½¿ç”¨æ›´å¿«çš„å“ˆå¸Œç®—æ³•ï¼‰
2. æ·»åŠ å‘Šè­¦æœºåˆ¶ï¼ˆç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ï¼‰
3. æ·»åŠ ç®¡ç†æ¥å£ï¼ˆæ¸…ç†ç¼“å­˜ã€æŸ¥çœ‹ç»Ÿè®¡ï¼‰

---

## ç»“è®º

### ç”¨æˆ·å‡è®¾éªŒè¯

| å‡è®¾ | éªŒè¯ç»“æœ |
|------|---------|
| Antigravity è¿”å›æœ‰æ•ˆçš„ signature | âœ… å·²éªŒè¯ |
| é—®é¢˜æ˜¯ Cursor ä¸¢å¼ƒäº† signature | âœ… å·²éªŒè¯ï¼ˆå®é™…æ˜¯ OpenAI æ ¼å¼æ²¡æœ‰è¿™ä¸ªå­—æ®µï¼‰ |
| å¯ä»¥åœ¨ä»£ç†å±‚ç¼“å­˜ signature | âœ… æŠ€æœ¯å¯è¡Œ |

### æœ€ç»ˆç»“è®º

**ç”¨æˆ·æå‡ºçš„ signature ç¼“å­˜æ–¹æ¡ˆå®Œå…¨å¯è¡Œï¼**

è¿™æ˜¯ä¸€ä¸ªä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥ï¼š
- âœ… ä¿æŒ thinking æ¨¡å¼å¯ç”¨
- âœ… è®©ç”¨æˆ·çœ‹åˆ°æ¨¡å‹çš„æ¨ç†è¿‡ç¨‹
- âœ… ä¸éœ€è¦ Cursor åšä»»ä½•ä¿®æ”¹
- âœ… å¯¹ç°æœ‰åŠŸèƒ½å®Œå…¨é€æ˜

**æ¨èç«‹å³å®æ–½ï¼**

---

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `src/anthropic_streaming.py` | æµå¼å“åº”å¤„ç†ï¼Œsignature ç¼“å­˜å†™å…¥ç‚¹ |
| `src/converters/message_converter.py` | æ¶ˆæ¯è½¬æ¢ï¼Œsignature æ¢å¤ç‚¹ |
| `src/antigravity_router.py` | è¯·æ±‚è·¯ç”±ï¼Œthinking çŠ¶æ€æ£€æµ‹ |
| `src/models.py` | æ•°æ®æ¨¡å‹å®šä¹‰ |

---

## å‚è€ƒèµ„æ–™

1. [Claude Extended Thinking Documentation](https://docs.anthropic.com/en/docs/build-with-claude/extended-thinking)
2. [2026-01-07_Cursorä¸Thinkingæ¨¡å‹å…¼å®¹æ€§ç ”ç©¶æŠ¥å‘Š.md](./2026-01-07_Cursorä¸Thinkingæ¨¡å‹å…¼å®¹æ€§ç ”ç©¶æŠ¥å‘Š.md)
3. gcli2api æºä»£ç åˆ†æ
