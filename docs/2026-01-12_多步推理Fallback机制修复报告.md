# 多步推理 Fallback 机制修复报告

**日期**: 2026-01-12
**作者**: Claude Opus 4.5 (浮浮酱)
**问题类型**: 架构逻辑缺陷
**严重程度**: 严重
**版本**: v3 (第三次修复 - 核心问题)

---

## 问题描述

用户反馈：gcli2api 在为 Cursor 转发 Claude 模型时，多步推理功能失效。即使已经完成了前两次修复（便捷函数迁移代理 + 迁移模式默认启用），问题依然存在。

### 日志表现

```
[ANTIGRAVITY DEBUG] Checking 3 messages for thinking blocks...
[ANTIGRAVITY DEBUG] Message 1 (assistant): content_type=str, content_len=621, has_think_tag=False
[WARNING] [ANTIGRAVITY] Last assistant message does not start with thinking block,
                        cannot find previous thinking block with valid signature.
                        DISABLING thinking mode to avoid 400 error.
```

---

## 根本原因分析

### 核心问题

**Cursor 从不在历史消息中发送 thinking block！**

Cursor 会过滤掉所有 thinking 内容，只在历史消息中保留纯文本响应。因此：

1. `antigravity_router.py` 中的代码遍历历史消息，试图找到 thinking block
2. 但 Cursor 发送的历史消息中**根本没有** thinking block
3. 代码只在找到 thinking block 但 signature 无效时才查询缓存
4. 如果没有 thinking block，fallback 机制被**禁用**，直接关闭 thinking 模式

### 问题代码位置

`gcli2api/src/antigravity_router.py`: 第 1957-1990 行

### 错误的逻辑流程

```
历史消息中没有 thinking block
    ↓
遍历历史消息，找不到任何 thinking block
    ↓
进入 else 分支（第 1957 行）
    ↓
[FIX 2026-01-09] 禁用了 fallback 机制
    ↓
直接禁用 thinking 模式
    ↓
多步推理失效 ❌
```

### 之前为什么禁用 fallback？

[FIX 2026-01-09] 的注释解释了原因：

> 问题：get_last_signature_with_text() 返回的是全局最近缓存的 signature，
> 这个 signature 对应的 thinking 内容可能与当前消息完全无关，
> 导致 Claude API 返回 400 错误：Invalid signature in thinking block

**但这个担忧是错误的！**

`get_last_signature_with_text()` 返回的是 **(signature, thinking_text) 配对**，这两者是一起缓存的，signature 与 thinking_text 始终匹配。只要使用缓存返回的 thinking_text（而不是历史消息中的内容），就不会出现不匹配的问题。

---

## 修复方案

### 修改内容

重新启用 fallback 机制，正确使用 `get_last_signature_with_text()`：

**修改前** (第 1957-1990 行):
```python
else:
    # [FIX 2026-01-09] 禁用不安全的 fallback 机制
    # ... 长注释解释为什么禁用 ...
    log.warning(f"[ANTIGRAVITY] Last assistant message does not start with thinking block, "
               f"cannot find previous thinking block with valid signature. "
               f"DISABLING thinking mode to avoid 400 error.")
    enable_thinking = False
    # 重新清理消息中的 thinking 内容
    messages = strip_thinking_from_openai_messages(messages)
    # 重新转换消息格式（不带 thinking）
    contents = openai_messages_to_antigravity_contents(...)
```

**修改后**:
```python
else:
    # [FIX 2026-01-12] 重新启用 fallback 机制，正确使用缓存
    #
    # 核心理解：Cursor **从不**在历史消息中发送 thinking block！
    # Cursor 会过滤掉 thinking 内容，只发送纯文本响应。
    # 因此，我们必须从缓存中获取 signature 和 thinking text。
    #
    # 关键点：使用缓存返回的 thinking_text，而不是历史消息中的内容！
    cached_result = get_last_signature_with_text()
    if cached_result:
        cached_signature, cached_thinking_text = cached_result
        thinking_part = {
            "text": cached_thinking_text,
            "thought": True,
            "thoughtSignature": cached_signature
        }
        parts.insert(0, thinking_part)
        log.info(f"[ANTIGRAVITY] 从缓存恢复 thinking block (fallback): "
                f"thinking_len={len(cached_thinking_text)}, "
                f"signature_len={len(cached_signature)}")
    else:
        # 缓存为空，确实无法恢复 thinking 模式
        log.warning(f"[ANTIGRAVITY] Last assistant message does not start with thinking block, "
                   f"cache is empty, cannot recover. "
                   f"DISABLING thinking mode to avoid 400 error.")
        enable_thinking = False
        # ... 禁用 thinking 模式的逻辑 ...
```

---

## 修复后的逻辑流程

```
历史消息中没有 thinking block（Cursor 行为）
    ↓
遍历历史消息，找不到任何 thinking block
    ↓
进入 else 分支
    ↓
调用 get_last_signature_with_text() 从缓存获取
    ↓
缓存命中 → 使用缓存的 (signature, thinking_text) 构建 thinking block
    ↓
将 thinking block 插入到 assistant 消息开头
    ↓
thinking 模式保持启用 ✅
    ↓
多步推理正常工作 ✅
```

---

## 三次修复总结

| 修复次数 | 问题 | 修复位置 | 修复内容 |
|---------|------|----------|----------|
| 第一次 | 便捷函数绕过 CacheFacade | `signature_cache.py` 471-623 行 | 为 5 个便捷函数添加迁移模式代理 |
| 第二次 | 迁移模式默认禁用 | `signature_cache.py` 647-677 行 | 修改 `_is_migration_mode()` 默认返回 True |
| 第三次 | Fallback 机制被禁用 | `antigravity_router.py` 1957-1990 行 | 重新启用 fallback，正确使用缓存 |

---

## 验证步骤

1. **重启 gcli2api 服务**
   ```bash
   cd F:\antigravity2api\gcli2api
   python web.py
   ```

2. **检查日志**
   - 第一轮对话：应看到 `迁移模式检查: 环境变量=(未设置), 结果=启用`
   - 第二轮对话：应看到 `从缓存恢复 thinking block (fallback)` 日志
   - **不应该**看到 `DISABLING thinking mode` 的警告

3. **测试多步推理**
   - 在 Cursor 中发起需要多步推理的请求（如使用工具）
   - 确认 Claude 能够正常进行工具调用循环
   - 确认 thinking 模式在多轮对话中保持启用

---

## 备份文件

| 文件 | 位置 |
|------|------|
| antigravity_router.py 备份 | `antigravity_router.py.bak_20260112_111258` |
| 修复脚本 | `scripts/fix_antigravity_router_fallback.py` |

---

## 关键理解

1. **Cursor 的行为**：Cursor 在发送历史消息时会过滤掉所有 thinking 内容，只保留纯文本响应
2. **缓存的作用**：signature 和 thinking_text 必须从缓存中恢复，而不是从历史消息中提取
3. **配对原则**：`get_last_signature_with_text()` 返回的是配对的数据，不会出现不匹配问题

---

*修复完成！请重启服务并验证多步推理功能是否恢复正常喵～* ฅ'ω'ฅ
