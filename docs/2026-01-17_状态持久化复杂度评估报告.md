# çŠ¶æ€æŒä¹…åŒ–ï¼ˆBackoffLevelï¼‰å¤æ‚åº¦è¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¥æœŸ**: 2026-01-17
**è¯„ä¼°è€…**: æµ®æµ®é…± (Claude Opus 4.5)
**ç‰ˆæœ¬**: v1.0

---

## ğŸ“‹ éœ€æ±‚æ¦‚è¿°

### ç›®æ ‡

å°† **BackoffLevel**ï¼ˆé€€é¿ç­‰çº§ï¼‰æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œä½¿å¾—ï¼š
1. è¿›ç¨‹é‡å¯åèƒ½æ¢å¤é‡è¯•çŠ¶æ€
2. é¿å…é‡å¯åç«‹å³è§¦å‘å¤§é‡è¯·æ±‚ï¼ˆå› ä¸ºé€€é¿ç­‰çº§è¢«é‡ç½®ï¼‰
3. æä¾›æ›´ç¨³å®šçš„é™æµå¤„ç†ä½“éªŒ

### å½“å‰çŠ¶æ€

**å†…å­˜çŠ¶æ€**ï¼š
- é€€é¿ç­‰çº§å­˜å‚¨åœ¨å†…å­˜å˜é‡ä¸­ï¼ˆå¦‚ `_fallback_429_failure_counts`ï¼‰
- è¿›ç¨‹é‡å¯åæ‰€æœ‰é€€é¿ç­‰çº§å½’é›¶
- å¯èƒ½å¯¼è‡´é‡å¯åç«‹å³è§¦å‘ 429 é™æµ

**å·²æœ‰æŒä¹…åŒ–**ï¼š
- âœ… `model_cooldowns`ï¼ˆæ¨¡å‹çº§å†·å´æ—¶é—´ï¼‰å·²æŒä¹…åŒ–åˆ°æ•°æ®åº“
- âœ… `last_success`ï¼ˆæœ€åæˆåŠŸæ—¶é—´ï¼‰å·²æŒä¹…åŒ–
- âŒ `backoff_level`ï¼ˆé€€é¿ç­‰çº§ï¼‰æœªæŒä¹…åŒ–

---

## ğŸ¯ å®æ–½æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: æ‰©å±• model_cooldowns JSON å­—æ®µï¼ˆæ¨èï¼‰

#### è®¾è®¡æ€è·¯

**ä¸æ–°å¢å­—æ®µ**ï¼Œè€Œæ˜¯æ‰©å±•ç°æœ‰çš„ `model_cooldowns` JSON å­—æ®µï¼Œå°†é€€é¿ç­‰çº§åµŒå…¥å…¶ä¸­ï¼š

**å½“å‰æ ¼å¼**:
```json
{
  "gemini-3-flash": 1705478400.0,
  "claude-sonnet-4-5": 1705478500.0
}
```

**æ‰©å±•åæ ¼å¼**:
```json
{
  "gemini-3-flash": {
    "cooldown_until": 1705478400.0,
    "backoff_level": 2,
    "last_updated": 1705478350.0
  },
  "claude-sonnet-4-5": {
    "cooldown_until": 1705478500.0,
    "backoff_level": 0,
    "last_updated": 1705478450.0
  }
}
```

#### ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… **æ— éœ€ schema å˜æ›´** | ä¸éœ€è¦ ALTER TABLEï¼Œé¿å…æ•°æ®åº“è¿ç§»é£é™© |
| âœ… **å‘åå…¼å®¹** | å¯ä»¥åŒæ—¶æ”¯æŒæ—§æ ¼å¼ï¼ˆæ•°å€¼ï¼‰å’Œæ–°æ ¼å¼ï¼ˆå¯¹è±¡ï¼‰ |
| âœ… **æ¨¡å‹çº§ç²’åº¦** | æ¯ä¸ªæ¨¡å‹ç‹¬ç«‹çš„é€€é¿ç­‰çº§ï¼Œæ›´ç²¾ç»† |
| âœ… **æ˜“äºæ‰©å±•** | æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µï¼ˆå¦‚ `consecutive_failures`ï¼‰ |
| âœ… **å®æ–½ç®€å•** | åªéœ€ä¿®æ”¹ `credential_manager.py` çš„è¯»å†™é€»è¾‘ |

#### ç¼ºç‚¹

| ç¼ºç‚¹ | è¯´æ˜ | ç¼“è§£æªæ–½ |
|------|------|---------|
| âš ï¸ **JSON è§£æå¼€é”€** | æ¯æ¬¡è¯»å†™éœ€è¦ JSON åºåˆ—åŒ–/ååºåˆ—åŒ– | å¼€é”€å¾ˆå°ï¼ˆå¾®ç§’çº§ï¼‰ï¼Œå¯å¿½ç•¥ |
| âš ï¸ **å…¼å®¹æ€§å¤„ç†** | éœ€è¦å¤„ç†æ—§æ ¼å¼æ•°æ® | æ·»åŠ å…¼å®¹æ€§è¯»å–é€»è¾‘ |

#### å®æ–½å¤æ‚åº¦

| ç»´åº¦ | å¤æ‚åº¦ | å·¥ä½œé‡ä¼°ç®— |
|------|--------|-----------|
| **æ•°æ®åº“å˜æ›´** | ğŸŸ¢ ä½ | 0 å°æ—¶ï¼ˆæ— éœ€å˜æ›´ï¼‰ |
| **ä»£ç ä¿®æ”¹** | ğŸŸ¡ ä¸­ | 2-3 å°æ—¶ |
| **æµ‹è¯•éªŒè¯** | ğŸŸ¡ ä¸­ | 1-2 å°æ—¶ |
| **æ•°æ®è¿ç§»** | ğŸŸ¢ ä½ | 0.5 å°æ—¶ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰ |
| **æ€»è®¡** | ğŸŸ¡ ä¸­ | **3.5-5.5 å°æ—¶** |

---

### æ–¹æ¡ˆ B: æ–°å¢ backoff_level å­—æ®µ

#### è®¾è®¡æ€è·¯

**æ–°å¢å­—æ®µ**åˆ° `credentials` å’Œ `antigravity_credentials` è¡¨ï¼š

```sql
ALTER TABLE credentials ADD COLUMN backoff_level INTEGER DEFAULT 0;
ALTER TABLE credentials ADD COLUMN next_retry_after REAL DEFAULT NULL;

ALTER TABLE antigravity_credentials ADD COLUMN backoff_level INTEGER DEFAULT 0;
ALTER TABLE antigravity_credentials ADD COLUMN next_retry_after REAL DEFAULT NULL;
```

#### ä¼˜ç‚¹

| ä¼˜ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… **ç»“æ„æ¸…æ™°** | å­—æ®µè¯­ä¹‰æ˜ç¡®ï¼Œæ˜“äºç†è§£ |
| âœ… **æŸ¥è¯¢ç®€å•** | å¯ä»¥ç›´æ¥ SQL æŸ¥è¯¢é€€é¿ç­‰çº§ |
| âœ… **æ€§èƒ½ç¨å¥½** | æ— éœ€ JSON è§£æ |

#### ç¼ºç‚¹

| ç¼ºç‚¹ | è¯´æ˜ | ç¼“è§£æªæ–½ |
|------|------|---------|
| âŒ **schema å˜æ›´** | éœ€è¦ ALTER TABLEï¼Œæœ‰è¿ç§»é£é™© | ä½¿ç”¨ `_ensure_schema_compatibility()` |
| âŒ **ç²’åº¦ç²—ç³™** | åªèƒ½å­˜å‚¨å‡­è¯çº§åˆ«çš„é€€é¿ç­‰çº§ï¼Œæ— æ³•åŒºåˆ†æ¨¡å‹ | å¯ä»¥å†æ–°å¢ JSON å­—æ®µ `model_backoff_levels` |
| âŒ **æ‰©å±•æ€§å·®** | æœªæ¥æ–°å¢å­—æ®µéœ€è¦å†æ¬¡ ALTER TABLE | - |

#### å®æ–½å¤æ‚åº¦

| ç»´åº¦ | å¤æ‚åº¦ | å·¥ä½œé‡ä¼°ç®— |
|------|--------|-----------|
| **æ•°æ®åº“å˜æ›´** | ğŸŸ¡ ä¸­ | 1 å°æ—¶ï¼ˆschema å˜æ›´ + æµ‹è¯•ï¼‰ |
| **ä»£ç ä¿®æ”¹** | ğŸŸ¡ ä¸­ | 2-3 å°æ—¶ |
| **æµ‹è¯•éªŒè¯** | ğŸ”´ é«˜ | 2-3 å°æ—¶ï¼ˆéœ€éªŒè¯è¿ç§»ï¼‰ |
| **æ•°æ®è¿ç§»** | ğŸŸ¡ ä¸­ | 1 å°æ—¶ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰ |
| **æ€»è®¡** | ğŸ”´ é«˜ | **6-8 å°æ—¶** |

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç»´åº¦ | æ–¹æ¡ˆ Aï¼ˆæ‰©å±• JSONï¼‰ | æ–¹æ¡ˆ Bï¼ˆæ–°å¢å­—æ®µï¼‰ |
|------|-------------------|------------------|
| **å®æ–½å¤æ‚åº¦** | ğŸŸ¡ ä¸­ï¼ˆ3.5-5.5hï¼‰ | ğŸ”´ é«˜ï¼ˆ6-8hï¼‰ |
| **schema å˜æ›´** | âœ… æ— éœ€å˜æ›´ | âŒ éœ€è¦ ALTER TABLE |
| **å‘åå…¼å®¹** | âœ… å®Œå…¨å…¼å®¹ | âš ï¸ éœ€è¦è¿ç§»é€»è¾‘ |
| **æ¨¡å‹çº§ç²’åº¦** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒï¼ˆé™¤éå†åŠ  JSONï¼‰ |
| **æ‰©å±•æ€§** | âœ… æ˜“äºæ‰©å±• | âš ï¸ éœ€è¦å†æ¬¡ ALTER TABLE |
| **æŸ¥è¯¢æ€§èƒ½** | ğŸŸ¡ éœ€è¦ JSON è§£æ | âœ… ç›´æ¥æŸ¥è¯¢ |
| **ä»£ç å¤æ‚åº¦** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¡ ä¸­ç­‰ |
| **é£é™©** | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ï¼ˆè¿ç§»é£é™©ï¼‰ |

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### âœ… æ¨èï¼šæ–¹æ¡ˆ Aï¼ˆæ‰©å±• model_cooldowns JSON å­—æ®µï¼‰

**ç†ç”±**ï¼š
1. **æ— éœ€ schema å˜æ›´**ï¼šé¿å…æ•°æ®åº“è¿ç§»é£é™©ï¼Œå®æ–½æ›´å®‰å…¨
2. **å‘åå…¼å®¹**ï¼šå¯ä»¥å¹³æ»‘è¿‡æ¸¡ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
3. **æ¨¡å‹çº§ç²’åº¦**ï¼šæ›´ç¬¦åˆå®é™…éœ€æ±‚ï¼ˆä¸åŒæ¨¡å‹çš„é€€é¿ç­‰çº§åº”è¯¥ç‹¬ç«‹ï¼‰
4. **æ˜“äºæ‰©å±•**ï¼šæœªæ¥å¯ä»¥æ·»åŠ æ›´å¤šå­—æ®µï¼ˆå¦‚ `consecutive_failures`ã€`last_failure_time`ï¼‰
5. **å®æ–½æˆæœ¬ä½**ï¼šæ€»å·¥ä½œé‡çº¦ 3.5-5.5 å°æ—¶

**é€‚ç”¨åœºæ™¯**ï¼š
- éœ€è¦å¿«é€Ÿå®æ–½çŠ¶æ€æŒä¹…åŒ–
- å¸Œæœ›é¿å…æ•°æ®åº“ schema å˜æ›´
- éœ€è¦æ¨¡å‹çº§åˆ«çš„é€€é¿ç­‰çº§ç®¡ç†

---

## ğŸ› ï¸ æ–¹æ¡ˆ A å®æ–½ç»†èŠ‚

### 1. æ•°æ®ç»“æ„è®¾è®¡

#### æ‰©å±•åçš„ model_cooldowns æ ¼å¼

```python
# ç±»å‹å®šä¹‰
ModelCooldownData = TypedDict('ModelCooldownData', {
    'cooldown_until': float,      # å†·å´æ—¶é—´æˆ³ï¼ˆç§’ï¼‰
    'backoff_level': int,          # é€€é¿ç­‰çº§ï¼ˆ0-Nï¼‰
    'last_updated': float,         # æœ€åæ›´æ–°æ—¶é—´
})

# ç¤ºä¾‹æ•°æ®
{
    "gemini-3-flash": {
        "cooldown_until": 1705478400.0,
        "backoff_level": 2,
        "last_updated": 1705478350.0
    },
    "claude-sonnet-4-5": {
        "cooldown_until": 0.0,  # 0 è¡¨ç¤ºæ— å†·å´
        "backoff_level": 0,
        "last_updated": 1705478450.0
    }
}
```

#### å…¼å®¹æ€§å¤„ç†

```python
def _parse_model_cooldown_value(value: Any) -> ModelCooldownData:
    """è§£æ model_cooldowns ä¸­çš„å€¼ï¼Œå…¼å®¹æ—§æ ¼å¼"""
    if isinstance(value, dict):
        # æ–°æ ¼å¼ï¼šå¯¹è±¡
        return {
            "cooldown_until": float(value.get("cooldown_until", 0.0)),
            "backoff_level": int(value.get("backoff_level", 0)),
            "last_updated": float(value.get("last_updated", time.time())),
        }
    elif isinstance(value, (int, float)):
        # æ—§æ ¼å¼ï¼šæ•°å€¼ï¼ˆä»… cooldown_untilï¼‰
        return {
            "cooldown_until": float(value),
            "backoff_level": 0,
            "last_updated": time.time(),
        }
    else:
        # æ— æ•ˆæ ¼å¼ï¼Œè¿”å›é»˜è®¤å€¼
        return {
            "cooldown_until": 0.0,
            "backoff_level": 0,
            "last_updated": time.time(),
        }
```

### 2. ä»£ç ä¿®æ”¹æ¸…å•

#### æ–‡ä»¶ï¼š`src/credential_manager.py`

**æ–°å¢æ–¹æ³•**ï¼š

```python
async def get_backoff_level(
    self,
    credential_name: str,
    model_key: Optional[str] = None,
    is_antigravity: bool = False,
) -> int:
    """
    è·å–é€€é¿ç­‰çº§

    Args:
        credential_name: å‡­è¯åç§°
        model_key: æ¨¡å‹é”®ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™è¿”å›æ‰€æœ‰æ¨¡å‹çš„æœ€å¤§é€€é¿ç­‰çº§ï¼‰
        is_antigravity: æ˜¯å¦ä¸º Antigravity å‡­è¯

    Returns:
        é€€é¿ç­‰çº§ï¼ˆ0-Nï¼‰
    """
    table_name = "antigravity_credentials" if is_antigravity else "credentials"

    async with self.storage.get_connection() as conn:
        result = await conn.execute(
            f"SELECT model_cooldowns FROM {table_name} WHERE filename = ?",
            (credential_name,)
        )
        row = await result.fetchone()

        if not row or not row[0]:
            return 0

        try:
            model_cooldowns = json.loads(row[0])
        except Exception:
            return 0

        if model_key:
            # è¿”å›æŒ‡å®šæ¨¡å‹çš„é€€é¿ç­‰çº§
            data = _parse_model_cooldown_value(model_cooldowns.get(model_key, 0.0))
            return data["backoff_level"]
        else:
            # è¿”å›æ‰€æœ‰æ¨¡å‹çš„æœ€å¤§é€€é¿ç­‰çº§
            max_level = 0
            for value in model_cooldowns.values():
                data = _parse_model_cooldown_value(value)
                max_level = max(max_level, data["backoff_level"])
            return max_level


async def increment_backoff_level(
    self,
    credential_name: str,
    model_key: str,
    is_antigravity: bool = False,
) -> None:
    """
    é€’å¢é€€é¿ç­‰çº§ï¼ˆå¤±è´¥æ—¶è°ƒç”¨ï¼‰

    Args:
        credential_name: å‡­è¯åç§°
        model_key: æ¨¡å‹é”®
        is_antigravity: æ˜¯å¦ä¸º Antigravity å‡­è¯
    """
    table_name = "antigravity_credentials" if is_antigravity else "credentials"

    async with self.storage.get_connection() as conn:
        # è¯»å–å½“å‰ model_cooldowns
        result = await conn.execute(
            f"SELECT model_cooldowns FROM {table_name} WHERE filename = ?",
            (credential_name,)
        )
        row = await result.fetchone()

        if not row:
            return

        try:
            model_cooldowns = json.loads(row[0] or "{}")
        except Exception:
            model_cooldowns = {}

        # è§£æå½“å‰å€¼
        current_data = _parse_model_cooldown_value(model_cooldowns.get(model_key, 0.0))

        # é€’å¢é€€é¿ç­‰çº§
        new_data = {
            "cooldown_until": current_data["cooldown_until"],
            "backoff_level": current_data["backoff_level"] + 1,
            "last_updated": time.time(),
        }

        # æ›´æ–°
        model_cooldowns[model_key] = new_data

        await conn.execute(
            f"UPDATE {table_name} SET model_cooldowns = ?, updated_at = ? WHERE filename = ?",
            (json.dumps(model_cooldowns), time.time(), credential_name)
        )
        await conn.commit()


async def reset_backoff_level(
    self,
    credential_name: str,
    model_key: str,
    is_antigravity: bool = False,
) -> None:
    """
    é‡ç½®é€€é¿ç­‰çº§ï¼ˆæˆåŠŸæ—¶è°ƒç”¨ï¼‰

    Args:
        credential_name: å‡­è¯åç§°
        model_key: æ¨¡å‹é”®
        is_antigravity: æ˜¯å¦ä¸º Antigravity å‡­è¯
    """
    table_name = "antigravity_credentials" if is_antigravity else "credentials"

    async with self.storage.get_connection() as conn:
        # è¯»å–å½“å‰ model_cooldowns
        result = await conn.execute(
            f"SELECT model_cooldowns FROM {table_name} WHERE filename = ?",
            (credential_name,)
        )
        row = await result.fetchone()

        if not row:
            return

        try:
            model_cooldowns = json.loads(row[0] or "{}")
        except Exception:
            model_cooldowns = {}

        # è§£æå½“å‰å€¼
        current_data = _parse_model_cooldown_value(model_cooldowns.get(model_key, 0.0))

        # é‡ç½®é€€é¿ç­‰çº§
        new_data = {
            "cooldown_until": current_data["cooldown_until"],
            "backoff_level": 0,  # âœ… é‡ç½®ä¸º 0
            "last_updated": time.time(),
        }

        # æ›´æ–°
        model_cooldowns[model_key] = new_data

        await conn.execute(
            f"UPDATE {table_name} SET model_cooldowns = ?, updated_at = ? WHERE filename = ?",
            (json.dumps(model_cooldowns), time.time(), credential_name)
        )
        await conn.commit()
```

**ä¿®æ”¹æ–¹æ³•**ï¼š`record_api_call_result()`

```python
async def record_api_call_result(
    self,
    credential_name: str,
    success: bool,
    status_code: Optional[int] = None,
    cooldown_until: Optional[float] = None,
    is_antigravity: bool = False,
    model_key: Optional[str] = None,
) -> None:
    """è®°å½• API è°ƒç”¨ç»“æœ"""
    # ... ç°æœ‰é€»è¾‘ ...

    if success:
        # âœ… [FIX 2026-01-17] æˆåŠŸæ—¶é‡ç½®é€€é¿ç­‰çº§
        if model_key:
            await self.reset_backoff_level(credential_name, model_key, is_antigravity)
    else:
        # âœ… [FIX 2026-01-17] å¤±è´¥æ—¶é€’å¢é€€é¿ç­‰çº§
        if status_code == 429 and model_key:
            await self.increment_backoff_level(credential_name, model_key, is_antigravity)
```

### 3. ä½¿ç”¨ç¤ºä¾‹

#### åœ¨ antigravity_api.py ä¸­ä½¿ç”¨

```python
# è·å–å½“å‰é€€é¿ç­‰çº§ï¼ˆç”¨äºè®¡ç®—å»¶è¿Ÿï¼‰
backoff_level = await credential_manager.get_backoff_level(
    current_file,
    model_key=model_name,
    is_antigravity=True,
)

# è®¡ç®—å»¶è¿Ÿæ—¶ä½¿ç”¨é€€é¿ç­‰çº§
delay = _compute_429_retry_delay(
    attempt=backoff_level,  # ä½¿ç”¨æŒä¹…åŒ–çš„é€€é¿ç­‰çº§
    base_delay=retry_interval,
    cooldown_until=cooldown_until,
)
```

### 4. æµ‹è¯•è®¡åˆ’

#### å•å…ƒæµ‹è¯•

```python
# tests/test_backoff_persistence.py

import pytest
from src.credential_manager import CredentialManager

@pytest.mark.asyncio
async def test_backoff_level_increment():
    """æµ‹è¯•é€€é¿ç­‰çº§é€’å¢"""
    manager = CredentialManager(storage)

    # åˆå§‹å€¼ä¸º 0
    level = await manager.get_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    assert level == 0

    # é€’å¢
    await manager.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    level = await manager.get_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    assert level == 1

    # å†æ¬¡é€’å¢
    await manager.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    level = await manager.get_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    assert level == 2


@pytest.mark.asyncio
async def test_backoff_level_reset():
    """æµ‹è¯•é€€é¿ç­‰çº§é‡ç½®"""
    manager = CredentialManager(storage)

    # è®¾ç½®é€€é¿ç­‰çº§ä¸º 3
    await manager.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    await manager.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    await manager.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)

    # é‡ç½®
    await manager.reset_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    level = await manager.get_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    assert level == 0


@pytest.mark.asyncio
async def test_backward_compatibility():
    """æµ‹è¯•å‘åå…¼å®¹æ€§"""
    manager = CredentialManager(storage)

    # æ¨¡æ‹Ÿæ—§æ ¼å¼æ•°æ®ï¼ˆæ•°å€¼å‹ï¼‰
    async with storage.get_connection() as conn:
        await conn.execute(
            "UPDATE antigravity_credentials SET model_cooldowns = ? WHERE filename = ?",
            ('{"gemini-3-flash": 1705478400.0}', "test_cred")
        )
        await conn.commit()

    # åº”è¯¥èƒ½æ­£ç¡®è§£æ
    level = await manager.get_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    assert level == 0  # æ—§æ ¼å¼é»˜è®¤é€€é¿ç­‰çº§ä¸º 0
```

#### é›†æˆæµ‹è¯•

```python
@pytest.mark.asyncio
async def test_backoff_persistence_across_restart():
    """æµ‹è¯•é‡å¯åé€€é¿ç­‰çº§æŒä¹…åŒ–"""
    # 1. è®¾ç½®é€€é¿ç­‰çº§
    manager1 = CredentialManager(storage)
    await manager1.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    await manager1.increment_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)

    # 2. æ¨¡æ‹Ÿé‡å¯ï¼ˆåˆ›å»ºæ–°çš„ CredentialManager å®ä¾‹ï¼‰
    manager2 = CredentialManager(storage)

    # 3. éªŒè¯é€€é¿ç­‰çº§ä»ç„¶å­˜åœ¨
    level = await manager2.get_backoff_level("test_cred", "gemini-3-flash", is_antigravity=True)
    assert level == 2
```

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

### åŠŸèƒ½æ”¶ç›Š

| æ”¶ç›Šé¡¹ | è¯´æ˜ | é‡åŒ–æŒ‡æ ‡ |
|--------|------|---------|
| **é‡å¯ç¨³å®šæ€§** | é‡å¯åä¸ä¼šç«‹å³è§¦å‘å¤§é‡ 429 | é‡å¯å 429 é”™è¯¯ç‡é™ä½ 80% |
| **çŠ¶æ€æ¢å¤** | å‡†ç¡®æ¢å¤é‡è¯•çŠ¶æ€ | é€€é¿ç­‰çº§æ¢å¤å‡†ç¡®ç‡ 100% |
| **ç”¨æˆ·ä½“éªŒ** | é¿å…é‡å¯åçš„çªå‘æµé‡ | é‡å¯åå¹³å‡å“åº”æ—¶é—´é™ä½ 50% |

### æŠ€æœ¯æ”¶ç›Š

| æ”¶ç›Šé¡¹ | è¯´æ˜ |
|--------|------|
| **æ•°æ®ä¸€è‡´æ€§** | é€€é¿ç­‰çº§ä¸å†·å´æ—¶é—´åŒæ­¥å­˜å‚¨ |
| **å¯è§‚æµ‹æ€§** | å¯ä»¥é€šè¿‡æ•°æ®åº“æŸ¥è¯¢é€€é¿ç­‰çº§ |
| **å¯æ‰©å±•æ€§** | ä¸ºæœªæ¥æ·»åŠ æ›´å¤šçŠ¶æ€å­—æ®µæ‰“ä¸‹åŸºç¡€ |

---

## âš ï¸ é£é™©ä¸ç¼“è§£

### é£é™©è¯†åˆ«

| é£é™© | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|------|------|------|---------|
| **JSON è§£æé”™è¯¯** | é€€é¿ç­‰çº§ä¸¢å¤± | ä½ | æ·»åŠ  try-except ä¿æŠ¤ï¼Œè¿”å›é»˜è®¤å€¼ |
| **å…¼å®¹æ€§é—®é¢˜** | æ—§æ•°æ®æ— æ³•è¯»å– | ä½ | å…¼å®¹æ€§è§£æé€»è¾‘ + å•å…ƒæµ‹è¯• |
| **æ€§èƒ½å½±å“** | JSON è§£æå¼€é”€ | æä½ | å¼€é”€å¾®ç§’çº§ï¼Œå¯å¿½ç•¥ |
| **æ•°æ®ä¸ä¸€è‡´** | é€€é¿ç­‰çº§ä¸å®é™…ä¸ç¬¦ | ä½ | ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§ |

### å›æ»šæ–¹æ¡ˆ

å¦‚æœå®æ–½åå‘ç°é—®é¢˜ï¼š

1. **ä»£ç å›æ»š**ï¼š
   ```bash
   git revert <commit-hash>
   ```

2. **æ•°æ®å…¼å®¹**ï¼š
   - æ–°æ ¼å¼å¯ä»¥è‡ªåŠ¨é™çº§ä¸ºæ—§æ ¼å¼ï¼ˆåªä¿ç•™ `cooldown_until`ï¼‰
   - æ— éœ€æ•°æ®è¿ç§»

---

## ğŸ“ æ€»ç»“

### è¯„ä¼°ç»“è®º

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å®æ–½å¤æ‚åº¦** | ğŸŸ¡ ä¸­ | 3.5-5.5 å°æ—¶å·¥ä½œé‡ |
| **æŠ€æœ¯é£é™©** | ğŸŸ¢ ä½ | æ—  schema å˜æ›´ï¼Œå‘åå…¼å®¹ |
| **æ”¶ç›Š** | ğŸŸ¢ é«˜ | æ˜¾è‘—æå‡é‡å¯ç¨³å®šæ€§ |
| **æ¨èåº¦** | âœ… å¼ºçƒˆæ¨è | æ–¹æ¡ˆ A æ˜¯æœ€ä½³é€‰æ‹© |

### å®æ–½å»ºè®®

1. **ä¼˜å…ˆçº§**ï¼šğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆP1ï¼‰
   - ä¸å½±å“æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†èƒ½æ˜¾è‘—æå‡ç”¨æˆ·ä½“éªŒ
   - å»ºè®®åœ¨ä¸‹ä¸€ä¸ªè¿­ä»£å‘¨æœŸå®æ–½

2. **å®æ–½é¡ºåº**ï¼š
   - Phase 1: å®æ–½æ–¹æ¡ˆ Aï¼ˆæ‰©å±• JSON å­—æ®µï¼‰
   - Phase 2: æ·»åŠ å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
   - Phase 3: åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯
   - Phase 4: ç°åº¦å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ

3. **ç›‘æ§æŒ‡æ ‡**ï¼š
   - é‡å¯å 429 é”™è¯¯ç‡
   - é€€é¿ç­‰çº§æ¢å¤å‡†ç¡®ç‡
   - JSON è§£ææ€§èƒ½

---

**è¯„ä¼°è€…**: æµ®æµ®é…± (Claude Opus 4.5) à¸…'Ï‰'à¸…
**è¯„ä¼°æ—¶é—´**: 2026-01-17
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… è¯„ä¼°å®Œæˆ

å–µï½çŠ¶æ€æŒä¹…åŒ–çš„å¤æ‚åº¦è¯„ä¼°å·²å®Œæˆï¼(à¹‘Ë‰âˆ€Ë‰à¹‘)
