# 工具调用卡住问题修复报告

**日期**: 2026-01-07
**修复人**: Claude Opus 4.5 (浮浮酱)
**影响模块**: `httpx_client.py`, `antigravity_anthropic_router.py`

---

## 问题概述

### 问题 1: 工具调用频繁卡住

**现象**:
- Cursor 发起的工具调用经常卡住无响应
- 特别是当上下文接近临界值（如 50K-60K tokens）时更容易发生
- 表现为请求发出后长时间无任何响应

**根因分析**:
在 `src/httpx_client.py` 中，以下三个函数的超时参数默认值为 `None`（无限等待）：

1. `get_streaming_client(timeout: float = None)`
2. `get_streaming_post_context(timeout: float = None)`
3. `create_streaming_client_with_kwargs()` - 内部调用 `get_client_kwargs(timeout=None)`

当后端因上下文过长或其他原因无法响应时，客户端会无限等待，导致工具调用"卡死"。

**修复方案**:
将默认超时从 `None` 改为 `600.0` 秒（10分钟），既能支持 thinking 模型的长时间思考，又避免无限等待。

### 问题 2: 模型降级疑虑（Opus → Sonnet）

**结论**: 代码中 **不存在** Opus → Sonnet 的同池降级逻辑。

经过全面代码审查，`antigravity_anthropic_router.py` 中只存在 **跨池降级**（Claude ↔ Gemini），不存在同池内的模型降级：

```python
# 跨池降级配置 (fallback_manager.py)
CROSS_POOL_FALLBACK = {
    "claude-sonnet-4-20250514": "gemini-2.5-pro",
    "gemini-2.5-pro": "claude-sonnet-4-20250514",
    # ... 其他跨池映射
}
```

如果用户观察到 Opus → Sonnet 的现象，可能的原因：
1. Cursor 客户端自身的模型选择逻辑
2. 用户配置问题
3. 凭证可用性导致的自动切换

### 死代码清理

**发现**: `antigravity_anthropic_router.py` 中存在死代码 `_get_fallback_model` 函数：

```python
def _get_fallback_model(current_model: str) -> str | None:
    """获取降级模型"""
    fallback_list = MODEL_FALLBACK_CHAIN.get(current_model, [])  # ❌ 未定义变量
    return fallback_list[0] if fallback_list else None
```

该函数：
- 使用了未定义的 `MODEL_FALLBACK_CHAIN` 变量
- 从未被调用（实际代码使用 `_get_fallback_models`）
- 已被清理移除

---

## 修复详情

### 修复 1: 流式请求超时机制

**文件**: `src/httpx_client.py`
**备份**: `_archive/backups/httpx_client.py.bak.20260107_211833`

| 位置 | 修改前 | 修改后 |
|------|--------|--------|
| `get_streaming_client` 参数 | `timeout: float = None` | `timeout: float = 600.0` |
| `get_streaming_post_context` 参数 | `timeout: float = None` | `timeout: float = 600.0` |
| `create_streaming_client_with_kwargs` 内部 | `timeout=None` | `timeout=kwargs.pop('timeout', 600.0)` |

**修复脚本**: `fix_streaming_timeout.py`

### 修复 2: 死代码清理

**文件**: `src/antigravity_anthropic_router.py`
**备份**: `_archive/backups/antigravity_anthropic_router.py.bak.20260107_212115`

移除了 4 行死代码（`_get_fallback_model` 函数定义）。

**修复脚本**: `fix_dead_code.py`

---

## 修复脚本使用说明

由于服务运行中文件被占用，使用 Python 脚本进行修改。

### 执行方式

```bash
cd F:\antigravity2api\gcli2api

# 修复流式超时问题
python fix_streaming_timeout.py

# 清理死代码
python fix_dead_code.py
```

### 脚本特性

- UTF-8 编码，兼容中文内容
- 自动创建带时间戳的备份文件
- 精确字符串匹配替换，避免误修改
- 详细的执行日志输出

---

## 验证方法

### 超时机制验证

1. 检查 `httpx_client.py` 中的默认超时值：
   ```python
   # 搜索 "timeout: float = 600.0" 应出现 2 次
   # 搜索 "timeout=kwargs.pop('timeout', 600.0)" 应出现 1 次
   ```

2. 发起长上下文请求，观察是否在 10 分钟后超时（而非无限等待）

### 死代码验证

1. 搜索 `MODEL_FALLBACK_CHAIN`，应无结果
2. 搜索 `_get_fallback_model`，应无结果（只有 `_get_fallback_models` 存在）

---

## 上下文阈值说明

当前系统的上下文处理阈值：

| 阈值 | tokens | 处理策略 |
|------|--------|----------|
| 正常 | < 50,000 | 正常处理 |
| 警告 | 50,000 - 80,000 | 记录警告日志 |
| 临界 | 80,000 - 120,000 | 建议压缩上下文 |
| 超限 | > 120,000 | 返回错误提示，要求压缩 |

当触发超时后，`stream_error_handler.py` 会生成友好的错误提示，指导用户使用 `/summarize` 命令压缩上下文。

---

## 后续建议

1. **监控超时日志**: 关注 `[STREAM STATE]` 和 `[STREAM FALLBACK]` 日志，了解超时发生频率
2. **调整超时值**: 如果 10 分钟仍不够用，可以在调用时显式传入更大的 `timeout` 值
3. **上下文管理**: 建议 Cursor 用户在对话过长时主动使用 `/summarize` 压缩上下文

---

## 相关文件

- `src/httpx_client.py` - HTTP 客户端核心
- `src/antigravity_api.py` - Antigravity API 通信
- `src/stream_error_handler.py` - 流式错误处理和 Fallback
- `src/fallback_manager.py` - 跨池降级配置
- `fix_streaming_timeout.py` - 超时修复脚本
- `fix_dead_code.py` - 死代码清理脚本
