# gcli2api 风控限流模块实现报告

> **日期**: 2026-01-21
> **作者**: 浮浮酱 (Claude Opus 4.5)
> **状态**: ✅ 已完成

## 概述

根据 `docs/2026-01-21 gcli2api风控限流缺口与改进计划.md` 的规划，本次实现了以下风控限流增强模块：

1. **RetryInfo / quotaResetDelay 精确解析** - `retry_utils.py`
2. **统一的限流状态池** - `rate_limit_registry.py`
3. **请求最小间隔 RateLimiter** - `rate_limiter.py`
4. **按状态码细粒度 Retry 策略枚举** - `antigravity_retry_policies.py`

## 新增模块详情

### 1. retry_utils.py

**功能**: 精确解析 Google API 返回的重试延迟信息

**核心函数**:
- `parse_duration_ms(duration_str)`: 解析 Duration 字符串（如 "1.5s", "200ms", "1h16m0.667s"）
- `parse_retry_delay(error_text)`: 从 429 错误 JSON 中提取 RetryInfo.retryDelay 或 metadata.quotaResetDelay
- `parse_retry_delay_seconds(error_text)`: 便捷包装，返回秒而不是毫秒

**参考实现**: `Antigravity-Manager/src-tauri/src/proxy/upstream/retry.rs`

### 2. rate_limit_registry.py

**功能**: 统一管理账号/模型级别的限流状态

**核心类**:
- `RateLimitState`: 单个凭证/模型的限流状态数据结构
- `RateLimitRegistry`: 限流状态注册表，提供 mark/clear/query 接口

**便捷函数**:
- `mark_rate_limited(credential, model, ...)`: 标记限流状态
- `clear_rate_limit(credential, model)`: 清除限流状态
- `is_rate_limited(credential, model)`: 检查是否在限流中

**用途**:
- 账号选择逻辑可以避免选到"刚被限流"的凭证
- Web 控制台可以展示当前限流状态
- 支持统计和清理过期记录

### 3. rate_limiter.py

**功能**: 请求最小间隔防抖，主动削峰

**核心类**:
- `RateLimiter`: 基础速率限制器，确保调用间隔 ≥ N ms
- `KeyedRateLimiter`: 按键分组的限制器，不同账号/模型独立限流
- `AdaptiveRateLimiter`: 自适应限制器，根据成功/失败动态调整间隔

**参考实现**: `Antigravity-Manager/src-tauri/src/proxy/common/rate_limiter.rs`

### 4. antigravity_retry_policies.py

**功能**: 统一的重试策略枚举与决策

**核心类**:
- `RetryStrategy`: 重试策略数据结构，支持 none/fixed/linear/exponential

**核心函数**:
- `determine_retry_strategy(status_code, error_text)`: 根据状态码决定重试策略
- `get_retry_delay_from_error(...)`: 便捷函数，直接计算重试延迟

**策略映射**:
| 状态码 | 策略 | 说明 |
|--------|------|------|
| 429 | exponential (1s-30min) | 限流，指数退避 |
| 429 + CAPACITY_EXHAUSTED | exponential (5s-1h) | 额度耗尽，更长退避 |
| 500/502/503/504/529 | exponential (1s-60s) | 服务端错误 |
| 400 | none | 客户端错误，不重试 |
| 401/403 | none | 认证错误，不重试 |

## antigravity_api.py 集成

### 修改点

1. **导入新模块**:
   ```python
   from .retry_utils import parse_retry_delay_seconds
   from .rate_limit_registry import mark_rate_limited, clear_rate_limit
   from .antigravity_retry_policies import determine_retry_strategy
   from .rate_limiter import get_global_rate_limiter
   ```

2. **增强 `_resolve_429_cooldown_until`**:
   - 优先使用 `parse_retry_delay_seconds()` 精确解析
   - 其次尝试 fetch_quota_info
   - 最后使用阶梯锁定

3. **替换 `_throttle_antigravity_upstream`**:
   - 使用新的 `RateLimiter` 模块

4. **增强 `_record_429_failure`**:
   - 新增 `credential_name`, `error_text`, `cooldown_until` 参数
   - 调用 `mark_rate_limited()` 记录到限流状态池

5. **增强 `_record_success`**:
   - 新增 `credential_name` 参数
   - 调用 `clear_rate_limit()` 清除限流状态

## 测试

新增测试文件: `tests/test_rate_limiting.py`

**测试覆盖**:
- `TestRetryUtils`: 11 个测试用例
- `TestRateLimitRegistry`: 5 个测试用例
- `TestRateLimiter`: 4 个测试用例
- `TestRetryPolicies`: 8 个测试用例

**测试结果**: 28 passed ✅

## 后续工作

根据原计划，以下工作可在后续迭代中完成：

1. **Web 控制台集成**: 在 `web_routes.py` 中添加限流状态查询接口
2. **凭证选择优化**: 在 `credential_manager.py` 中消费限流状态池
3. **Cloudflared 隧道支持**: 可选增强，用于受限网络环境

## 文件清单

| 文件 | 状态 | 说明 |
|------|------|------|
| `src/retry_utils.py` | 新增 | Duration 解析和 RetryInfo 提取 |
| `src/rate_limit_registry.py` | 新增 | 限流状态池管理 |
| `src/rate_limiter.py` | 新增 | 请求防抖 |
| `src/antigravity_retry_policies.py` | 新增 | 重试策略枚举 |
| `src/antigravity_api.py` | 修改 | 集成新模块 |
| `tests/test_rate_limiting.py` | 新增 | 单元测试 |

---

*本报告由浮浮酱 (Claude Opus 4.5) 自动生成*
