# 重构实施计划

**文档编号**: REFACTOR-03
**创建日期**: 2026-01-18
**作者**: 浮浮酱 (Claude Opus 4.5)
**状态**: ✅ 完成

---

## 一、执行摘要

### 1.1 重构目标

将 `unified_gateway_router.py` (3,701 行) 拆分为多个小模块，建立可插拔的网关架构。

### 1.2 工作量估算

| 阶段 | 人工估算 | AI 辅助估算 | Loop 数 |
|------|---------|------------|---------|
| Phase 1: 文件拆分 | 8 天 | 2-3 小时 | 3-4 |
| Phase 2: 接口抽象 | 7 天 | 1.5-2 小时 | 2-3 |
| Phase 3: 完全解耦 | 20 天 | 3-4 小时 | 5-6 |
| **总计** | **35 天** | **6.5-9 小时** | **10-13** |

### 1.3 AI 辅助策略

- **并行子 Agent**: 多个 Agent 同时处理不同模块
- **MCP 工具**: 使用 Code-index-mcp、Serena 等加速代码分析
- **增量验证**: 每个 Loop 完成后立即测试

---

## 二、Phase 1: 文件拆分

### 2.1 目标

将 `unified_gateway_router.py` 从 3,701 行拆分为 ~12 个小文件，每个文件 < 400 行。

### 2.2 Loop 详细计划

#### Loop 1.1: 基础设施准备 (预计 30 分钟)

**目标**: 创建目录结构和基础文件

**步骤**:
1. 创建 `src/gateway/` 目录结构
2. 创建 `__init__.py` 文件
3. 创建空的模块文件占位
4. 验证导入路径正确

**产出**:
```
src/gateway/
├── __init__.py
├── config.py           # 空文件
├── routing.py          # 空文件
├── proxy.py            # 空文件
├── normalization.py    # 空文件
├── tool_loop.py        # 空文件
├── endpoints/
│   ├── __init__.py
│   ├── openai.py       # 空文件
│   ├── anthropic.py    # 空文件
│   └── models.py       # 空文件
├── augment/
│   ├── __init__.py
│   ├── endpoints.py    # 空文件
│   ├── nodes_bridge.py # 空文件
│   └── state.py        # 空文件
└── sse/
    ├── __init__.py
    └── converter.py    # 空文件
```

**验收标准**:
- [ ] 目录结构创建完成
- [ ] 所有 `__init__.py` 文件存在
- [ ] `from src.gateway import *` 不报错

---

#### Loop 1.2: 配置和路由抽取 (预计 45 分钟)

**目标**: 抽取 BACKENDS 配置和路由决策逻辑

**源代码位置**:
- `unified_gateway_router.py:325-370` → `gateway/config.py`
- `unified_gateway_router.py:620-720` → `gateway/routing.py`

**步骤**:
1. 抽取 `BACKENDS` 字典到 `config.py`
2. 抽取 `KIRO_GATEWAY_MODELS` 到 `config.py`
3. 抽取 `RETRY_CONFIG` 到 `config.py`
4. 抽取 `get_backend_for_model()` 到 `routing.py`
5. 抽取 `get_sorted_backends()` 到 `routing.py`
6. 更新 `unified_gateway_router.py` 的导入

**config.py 预期内容**:
```python
# src/gateway/config.py
from typing import Dict, Any, List, Set
import os

# 后端配置
BACKENDS: Dict[str, Dict[str, Any]] = {
    "antigravity": {...},
    "copilot": {...},
    "kiro-gateway": {...},
}

# Kiro Gateway 支持的模型
KIRO_GATEWAY_MODELS: Set[str] = {...}

# 重试配置
RETRY_CONFIG: Dict[str, Any] = {...}

# 可路由模型集合
ROUTABLE_MODELS: Set[str] = {...}
```

**routing.py 预期内容**:
```python
# src/gateway/routing.py
from typing import List, Tuple, Optional
from .config import BACKENDS, KIRO_GATEWAY_MODELS

def get_sorted_backends() -> List[Tuple[str, dict]]:
    """按优先级排序返回可用后端"""
    ...

def get_backend_for_model(model: str) -> Optional[Tuple[str, dict]]:
    """根据模型名称选择最佳后端"""
    ...
```

**验收标准**:
- [ ] `config.py` 包含所有配置常量
- [ ] `routing.py` 包含路由决策函数
- [ ] 原文件导入新模块后功能正常
- [ ] 单元测试通过

---

#### Loop 1.3: 请求规范化抽取 (预计 45 分钟)

**目标**: 抽取请求规范化逻辑

**源代码位置**:
- `unified_gateway_router.py:450-620` → `gateway/normalization.py`

**步骤**:
1. 抽取 `normalize_tool_choice()` 函数
2. 抽取 `normalize_tools()` 函数
3. 抽取 `normalize_request_body()` 函数
4. 抽取 `_build_openai_messages_from_bugment()` 函数
5. 处理 Augment 相关的条件导入
6. 更新原文件导入

**normalization.py 预期内容**:
```python
# src/gateway/normalization.py
from typing import Dict, Any, List, Optional

def normalize_tool_choice(tool_choice: Any) -> Optional[Dict[str, Any]]:
    """规范化工具选择参数"""
    ...

def normalize_tools(tools: List[Dict]) -> List[Dict]:
    """规范化工具定义"""
    ...

def normalize_request_body(body: Dict[str, Any]) -> Dict[str, Any]:
    """规范化请求体"""
    ...
```

**验收标准**:
- [ ] 所有规范化函数抽取完成
- [ ] Augment 条件导入正确处理
- [ ] 原文件功能正常

---

#### Loop 1.4: 代理请求抽取 (预计 60 分钟)

**目标**: 抽取代理请求处理逻辑

**源代码位置**:
- `unified_gateway_router.py:720-900` → `gateway/proxy.py`

**步骤**:
1. 抽取 `proxy_request_to_backend()` 函数
2. 抽取 `proxy_streaming_request_with_timeout()` 函数
3. 抽取 `proxy_streaming_request()` 函数
4. 抽取 `route_request_with_fallback()` 函数
5. 处理 `antigravity_service` 直调依赖
6. 更新原文件导入

**关键依赖处理**:
```python
# 当前硬编码的直调
if backend_key == "antigravity" and endpoint == "/chat/completions":
    from src.services.antigravity_service import handle_openai_chat_completions
    resp = await handle_openai_chat_completions(body=body, headers=headers)

# 重构后使用依赖注入
class ProxyHandler:
    def __init__(self, local_handler: Optional[Callable] = None):
        self._local_handler = local_handler

    async def proxy_request(self, backend_key: str, endpoint: str, ...):
        if self._local_handler and backend_key == "antigravity":
            return await self._local_handler(body=body, headers=headers)
        ...
```

**验收标准**:
- [ ] 代理函数抽取完成
- [ ] 依赖注入模式实现
- [ ] 流式响应正常工作
- [ ] 降级逻辑正常工作

---

#### Loop 1.5: 端点拆分 (预计 60 分钟)

**目标**: 将 API 端点拆分到独立文件

**源代码位置**:
- `unified_gateway_router.py:900-1200` → `gateway/endpoints/`

**步骤**:
1. 抽取 `/v1/models` 到 `endpoints/models.py`
2. 抽取 `/v1/chat/completions` 到 `endpoints/openai.py`
3. 抽取 `/v1/messages` 到 `endpoints/anthropic.py`
4. 抽取 `/v1/messages/count_tokens` 到 `endpoints/anthropic.py`
5. 创建端点注册机制
6. 更新原文件

**endpoints/__init__.py 预期内容**:
```python
# src/gateway/endpoints/__init__.py
from fastapi import APIRouter
from .openai import router as openai_router
from .anthropic import router as anthropic_router
from .models import router as models_router

def create_gateway_router() -> APIRouter:
    """创建网关路由器"""
    router = APIRouter(prefix="/gateway")
    router.include_router(models_router)
    router.include_router(openai_router)
    router.include_router(anthropic_router)
    return router
```

**验收标准**:
- [ ] 所有端点拆分完成
- [ ] 路由注册机制工作正常
- [ ] API 功能无回归

---

#### Loop 1.6: Augment 模块拆分 (预计 90 分钟)

**目标**: 将 Augment/Bugment 相关代码拆分到独立模块

**源代码位置**:
- `unified_gateway_router.py:370-450` → `gateway/augment/state.py`
- `unified_gateway_router.py:1200-1600` → `gateway/augment/nodes_bridge.py`
- `unified_gateway_router.py:1600-2500` → `gateway/augment/endpoints.py`

**步骤**:
1. 创建 `BugmentStateManager` 单例类
2. 抽取 `_BUGMENT_TOOL_STATE` 和 `_BUGMENT_CONVERSATION_STATE`
3. 抽取 `stream_openai_with_nodes_bridge()` 函数
4. 抽取 Augment 端点
5. 抽取 Bugment 端点
6. 更新原文件

**state.py 预期内容**:
```python
# src/gateway/augment/state.py
from typing import Dict, Any, Optional
import time

class BugmentStateManager:
    """Bugment 状态管理器 (单例模式)"""
    _instance: Optional["BugmentStateManager"] = None

    def __init__(self):
        self._tool_state: Dict[str, Dict[str, Any]] = {}
        self._conversation_state: Dict[str, Dict[str, Any]] = {}
        self._tool_state_ttl = 60 * 30  # 30 分钟
        self._conversation_state_ttl = 60 * 60  # 1 小时

    @classmethod
    def get_instance(cls) -> "BugmentStateManager":
        if cls._instance is None:
            cls._instance = cls()
        return cls._instance

    def get_tool_state(self, key: str) -> Optional[Dict[str, Any]]:
        ...

    def set_tool_state(self, key: str, value: Dict[str, Any]) -> None:
        ...

    def cleanup_expired(self) -> None:
        ...
```

**验收标准**:
- [ ] 状态管理器单例实现
- [ ] Augment 端点正常工作
- [ ] Bugment 端点正常工作
- [ ] 状态 TTL 清理正常

---

#### Loop 1.7: SSE 转换和工具循环 (预计 45 分钟)

**目标**: 抽取 SSE 转换和工具循环逻辑

**源代码位置**:
- `unified_gateway_router.py:100-320` → `gateway/tool_loop.py`
- `unified_gateway_router.py:2500-3000` → `gateway/sse/converter.py`

**步骤**:
1. 抽取 `stream_openai_with_tool_loop()` 到 `tool_loop.py`
2. 抽取 `convert_sse_to_augment_ndjson()` 到 `sse/converter.py`
3. 处理相关辅助函数
4. 更新原文件

**验收标准**:
- [ ] 工具循环功能正常
- [ ] SSE 转换功能正常
- [ ] 流式响应无中断

---

#### Loop 1.8: 清理和验证 (预计 30 分钟)

**目标**: 清理原文件，完成 Phase 1 验收

**步骤**:
1. 删除原文件中已抽取的代码
2. 更新所有导入语句
3. 运行完整测试套件
4. 验证 API 功能
5. 更新文档

**验收标准**:
- [ ] `unified_gateway_router.py` < 300 行
- [ ] 所有测试通过
- [ ] API 功能无回归
- [ ] 文档更新完成

---

### 2.3 Phase 1 总验收标准

| 指标 | 目标 | 验证方法 |
|------|------|---------|
| 原文件行数 | < 300 行 | `wc -l unified_gateway_router.py` |
| 新模块数量 | 12 个 | `ls src/gateway/**/*.py \| wc -l` |
| 测试通过率 | 100% | `pytest tests/` |
| API 功能 | 无回归 | 手动测试 + 集成测试 |

---

## 三、Phase 2: 接口抽象

### 3.1 目标

定义可插拔的 `GatewayBackend` Protocol 接口，实现后端注册中心。

### 3.2 Loop 详细计划

#### Loop 2.1: 定义 Backend Protocol (预计 45 分钟)

**目标**: 定义后端接口协议

**产出**:
```python
# src/gateway/backends/interface.py
from typing import Protocol, Any, AsyncIterator, Optional
from dataclasses import dataclass

@dataclass
class BackendConfig:
    name: str
    base_url: str
    priority: int
    models: list[str]
    enabled: bool = True
    timeout: float = 30.0

class GatewayBackend(Protocol):
    """网关后端接口协议"""

    @property
    def name(self) -> str:
        """后端名称"""
        ...

    @property
    def config(self) -> BackendConfig:
        """后端配置"""
        ...

    async def is_available(self) -> bool:
        """检查后端是否可用"""
        ...

    async def supports_model(self, model: str) -> bool:
        """检查是否支持指定模型"""
        ...

    async def handle_request(
        self,
        endpoint: str,
        body: dict,
        headers: dict,
        stream: bool = False
    ) -> Any:
        """处理请求"""
        ...

    async def handle_streaming_request(
        self,
        endpoint: str,
        body: dict,
        headers: dict
    ) -> AsyncIterator[bytes]:
        """处理流式请求"""
        ...
```

**验收标准**:
- [ ] Protocol 定义完成
- [ ] 类型检查通过
- [ ] 文档注释完整

---

#### Loop 2.2: 实现后端注册中心 (预计 60 分钟)

**目标**: 实现 `GatewayRegistry` 注册中心

**产出**:
```python
# src/gateway/backends/registry.py
from typing import Dict, List, Optional, Type
from .interface import GatewayBackend, BackendConfig

class GatewayRegistry:
    """网关后端注册中心"""
    _instance: Optional["GatewayRegistry"] = None

    def __init__(self):
        self._backends: Dict[str, GatewayBackend] = {}

    @classmethod
    def get_instance(cls) -> "GatewayRegistry":
        if cls._instance is None:
            cls._instance = cls()
        return cls._instance

    def register(self, backend: GatewayBackend) -> None:
        """注册后端"""
        self._backends[backend.name] = backend

    def unregister(self, name: str) -> None:
        """注销后端"""
        self._backends.pop(name, None)

    def get(self, name: str) -> Optional[GatewayBackend]:
        """获取后端"""
        return self._backends.get(name)

    def get_all(self) -> List[GatewayBackend]:
        """获取所有后端"""
        return list(self._backends.values())

    def get_sorted_by_priority(self) -> List[GatewayBackend]:
        """按优先级排序获取后端"""
        return sorted(
            self._backends.values(),
            key=lambda b: b.config.priority
        )

    async def get_backend_for_model(self, model: str) -> Optional[GatewayBackend]:
        """根据模型选择后端"""
        for backend in self.get_sorted_by_priority():
            if await backend.is_available() and await backend.supports_model(model):
                return backend
        return None
```

**验收标准**:
- [ ] 注册中心实现完成
- [ ] 单例模式正确
- [ ] 优先级排序正确

---

#### Loop 2.3: 实现具体后端 (预计 90 分钟)

**目标**: 实现 3 个具体后端类

**产出**:
```python
# src/gateway/backends/antigravity.py
class AntigravityBackend(GatewayBackend):
    """Antigravity 后端实现"""
    ...

# src/gateway/backends/copilot.py
class CopilotBackend(GatewayBackend):
    """Copilot 后端实现"""
    ...

# src/gateway/backends/kiro.py
class KiroGatewayBackend(GatewayBackend):
    """Kiro Gateway 后端实现"""
    ...
```

**验收标准**:
- [ ] 3 个后端实现完成
- [ ] 符合 Protocol 接口
- [ ] 功能与原实现一致

---

#### Loop 2.4: 配置外部化 (预计 45 分钟)

**目标**: 将配置从代码中抽取到外部文件

**产出**:
```yaml
# config/gateway.yaml
backends:
  antigravity:
    enabled: true
    priority: 1
    base_url: ${ANTIGRAVITY_ENDPOINT}
    models: ["*"]
    timeout: 30

  copilot:
    enabled: ${COPILOT_ENABLED:false}
    priority: 2
    base_url: ${COPILOT_ENDPOINT}
    models:
      - gpt-4
      - gpt-4-turbo
    timeout: 60

  kiro-gateway:
    enabled: ${KIRO_GATEWAY_ENABLED:false}
    priority: 3
    base_url: ${KIRO_GATEWAY_ENDPOINT}
    models: ${KIRO_GATEWAY_MODELS}
    timeout: 120
```

**验收标准**:
- [ ] YAML 配置文件创建
- [ ] 环境变量支持
- [ ] 配置加载正确

---

### 3.3 Phase 2 总验收标准

| 指标 | 目标 | 验证方法 |
|------|------|---------|
| Protocol 定义 | 完成 | 类型检查 |
| 注册中心 | 实现 | 单元测试 |
| 后端实现 | 3 个 | 功能测试 |
| 配置外部化 | 完成 | 配置加载测试 |

---

## 四、Phase 3: 完全解耦

### 4.1 目标

使所有自研功能可独立启用/禁用，实现完全解耦。

### 4.2 Loop 详细计划

#### Loop 3.1: IDE 兼容层解耦 (预计 60 分钟)

**目标**: 使 `ide_compat/` 可独立启用/禁用

**步骤**:
1. 定义 `IDECompatMiddleware` 接口
2. 实现功能开关
3. 添加配置项
4. 更新文档

**验收标准**:
- [ ] 可通过配置禁用
- [ ] 禁用后不影响其他功能
- [ ] 有独立的单元测试

---

#### Loop 3.2: Augment 兼容层解耦 (预计 60 分钟)

**目标**: 使 `augment_compat/` 可独立启用/禁用

**步骤**:
1. 定义 `AugmentCompatMiddleware` 接口
2. 实现功能开关
3. 添加配置项
4. 更新文档

**验收标准**:
- [ ] 可通过配置禁用
- [ ] 禁用后不影响其他功能
- [ ] 有独立的单元测试

---

#### Loop 3.3: 签名缓存系统解耦 (预计 90 分钟)

**目标**: 使签名缓存系统可独立启用/禁用

**步骤**:
1. 定义 `SignatureCacheInterface` 接口
2. 实现空实现 (NoOpCache)
3. 实现功能开关
4. 添加配置项
5. 更新文档

**验收标准**:
- [ ] 可通过配置禁用
- [ ] 禁用后使用 NoOpCache
- [ ] 有独立的单元测试

---

#### Loop 3.4: 降级管理解耦 (预计 45 分钟)

**目标**: 使降级管理可独立配置

**步骤**:
1. 定义 `FallbackStrategy` 接口
2. 实现多种降级策略
3. 添加配置项
4. 更新文档

**验收标准**:
- [ ] 可配置降级策略
- [ ] 支持自定义策略
- [ ] 有独立的单元测试

---

#### Loop 3.5: 热修复模块整理 (预计 60 分钟)

**目标**: 整理 `patch_*.py` 模块

**步骤**:
1. 分类所有 patch 模块
2. 确定哪些可以合并到主代码
3. 确定哪些需要保留为热修复
4. 更新文档

**验收标准**:
- [ ] patch 模块分类完成
- [ ] 可合并的已合并
- [ ] 保留的有清晰文档

---

#### Loop 3.6: 集成测试和文档 (预计 90 分钟)

**目标**: 完成集成测试和文档更新

**步骤**:
1. 编写集成测试
2. 测试各种配置组合
3. 更新 README
4. 更新 API 文档
5. 更新部署文档

**验收标准**:
- [ ] 集成测试覆盖率 > 80%
- [ ] 所有文档更新完成
- [ ] 部署指南完整

---

### 4.3 Phase 3 总验收标准

| 指标 | 目标 | 验证方法 |
|------|------|---------|
| IDE 兼容层 | 可独立禁用 | 配置测试 |
| Augment 兼容层 | 可独立禁用 | 配置测试 |
| 签名缓存 | 可独立禁用 | 配置测试 |
| 降级管理 | 可配置策略 | 配置测试 |
| 测试覆盖率 | > 80% | pytest --cov |
| 文档完整性 | 100% | 人工审查 |

---

## 五、风险管理

### 5.1 高风险操作

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 流式响应中断 | 用户体验受损 | 每个 Loop 后测试流式响应 |
| 状态丢失 | 工具循环失败 | 状态管理器单例模式 |
| 签名缓存失效 | IDE 400 错误 | 保持向后兼容 |
| 导入循环 | 启动失败 | 延迟导入 |

### 5.2 回滚计划

每个 Loop 完成后:
1. 创建 Git 标签: `refactor/phase{N}/loop{M}`
2. 运行完整测试套件
3. 如失败，回滚到上一个标签

```bash
# 回滚命令
git checkout refactor/phase1/loop2  # 回滚到 Loop 2
```

---

## 六、进度跟踪

### 6.1 Phase 1 进度

| Loop | 状态 | 开始时间 | 完成时间 | 备注 |
|------|------|---------|---------|------|
| 1.1 基础设施 | ⏳ 待开始 | | | |
| 1.2 配置路由 | ⏳ 待开始 | | | |
| 1.3 请求规范化 | ⏳ 待开始 | | | |
| 1.4 代理请求 | ⏳ 待开始 | | | |
| 1.5 端点拆分 | ⏳ 待开始 | | | |
| 1.6 Augment 模块 | ⏳ 待开始 | | | |
| 1.7 SSE 工具循环 | ⏳ 待开始 | | | |
| 1.8 清理验证 | ⏳ 待开始 | | | |

### 6.2 Phase 2 进度

| Loop | 状态 | 开始时间 | 完成时间 | 备注 |
|------|------|---------|---------|------|
| 2.1 Backend Protocol | ⏳ 待开始 | | | |
| 2.2 注册中心 | ⏳ 待开始 | | | |
| 2.3 后端实现 | ⏳ 待开始 | | | |
| 2.4 配置外部化 | ⏳ 待开始 | | | |

### 6.3 Phase 3 进度

| Loop | 状态 | 开始时间 | 完成时间 | 备注 |
|------|------|---------|---------|------|
| 3.1 IDE 兼容层 | ⏳ 待开始 | | | |
| 3.2 Augment 兼容层 | ⏳ 待开始 | | | |
| 3.3 签名缓存 | ⏳ 待开始 | | | |
| 3.4 降级管理 | ⏳ 待开始 | | | |
| 3.5 热修复整理 | ⏳ 待开始 | | | |
| 3.6 集成测试 | ⏳ 待开始 | | | |

---

## 七、附录

### 7.1 命令速查

```bash
# 创建目录结构
mkdir -p src/gateway/{endpoints,augment,sse,backends}

# 运行测试
pytest tests/ -v

# 检查代码行数
wc -l src/unified_gateway_router.py
wc -l src/gateway/**/*.py

# 创建 Git 标签
git tag -a refactor/phase1/loop1 -m "Phase 1 Loop 1 完成"

# 回滚
git checkout refactor/phase1/loop1
```

### 7.2 文件模板

```python
# src/gateway/module_template.py
"""
模块名称

功能描述...
"""
from typing import ...

__all__ = ["..."]

# 实现代码...
```

---

**文档结束**

返回: [00_README.md](./00_README.md)
