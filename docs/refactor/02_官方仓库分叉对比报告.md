# å®˜æ–¹ä»“åº“åˆ†å‰å¯¹æ¯”æŠ¥å‘Š

**æ–‡æ¡£ç¼–å·**: REFACTOR-02
**åˆ›å»ºæ—¥æœŸ**: 2026-01-18
**ä½œè€…**: æµ®æµ®é…± (Claude Opus 4.5)
**çŠ¶æ€**: âœ… å®Œæˆ

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

### 1.1 å¯¹æ¯”æ¦‚è¿°

| æŒ‡æ ‡ | gcli2api_official | gcli2api (æˆ‘ä»¬çš„åˆ†æ”¯) | å·®å¼‚ |
|------|------------------|---------------------|------|
| æ€»ä»£ç è¡Œæ•° | ~12,000 è¡Œ | ~49,300 è¡Œ | **+37,300 è¡Œ (+310%)** |
| Python æ–‡ä»¶æ•° | 32 ä¸ª | 104 ä¸ª | **+72 ä¸ª** |
| æ ¸å¿ƒè·¯ç”±æ–‡ä»¶ | æ— ç»Ÿä¸€ç½‘å…³ | `unified_gateway_router.py` (3,701è¡Œ) | å®Œå…¨æ–°å¢ |
| æ¶æ„æ¨¡å¼ | å•åç«¯ | å¤šåç«¯ç½‘å…³ | é‡å¤§å˜æ›´ |

### 1.2 ç»“è®º

æˆ‘ä»¬çš„åˆ†æ”¯åœ¨å®˜æ–¹åŸºç¡€ä¸Šå¢åŠ äº† **310%** çš„ä»£ç é‡ï¼Œä¸»è¦ç”¨äº:
1. ç»Ÿä¸€ç½‘å…³è·¯ç”± (å¤šåç«¯æ”¯æŒ)
2. IDE å…¼å®¹å±‚ (Cursor/Augment/Windsurf)
3. æ€ç»´ç­¾åç¼“å­˜ç³»ç»Ÿ
4. é™çº§å’Œæ•…éšœè½¬ç§»æœºåˆ¶

---

## äºŒã€æ–‡ä»¶ç»“æ„å¯¹æ¯”

### 2.1 å®˜æ–¹ä»“åº“ç»“æ„ (gcli2api_official)

```
gcli2api_official/
â”œâ”€â”€ web.py                          # FastAPI å…¥å£
â”œâ”€â”€ config.py                       # åŸºç¡€é…ç½®
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ antigravity_api.py          # æ ¸å¿ƒ API (~800è¡Œ)
â”‚   â”œâ”€â”€ antigravity_router.py       # OpenAI æ ¼å¼è·¯ç”± (~600è¡Œ)
â”‚   â”œâ”€â”€ antigravity_anthropic_router.py  # Anthropic æ ¼å¼è·¯ç”± (~500è¡Œ)
â”‚   â”œâ”€â”€ anthropic_converter.py      # Anthropic æ ¼å¼è½¬æ¢
â”‚   â”œâ”€â”€ anthropic_streaming.py      # æµå¼å“åº”å¤„ç†
â”‚   â”œâ”€â”€ credential_manager.py       # å‡­è¯ç®¡ç†
â”‚   â”œâ”€â”€ models.py                   # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ utils.py                    # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ auth.py                     # è®¤è¯
â”‚   â”œâ”€â”€ web_routes.py               # Web è·¯ç”±
â”‚   â””â”€â”€ converters/                 # æ ¼å¼è½¬æ¢å™¨
â”‚       â”œâ”€â”€ message_converter.py
â”‚       â”œâ”€â”€ tool_converter.py
â”‚       â””â”€â”€ model_config.py
â”œâ”€â”€ test/                           # æµ‹è¯•æ–‡ä»¶
â””â”€â”€ front/                          # å‰ç«¯æ–‡ä»¶
```

**ç‰¹ç‚¹**:
- å•ä¸€åç«¯æ¶æ„
- èŒè´£æ˜ç¡®åˆ†ç¦»
- ä»£ç é‡é€‚ä¸­

### 2.2 æˆ‘ä»¬çš„åˆ†æ”¯ç»“æ„ (gcli2api)

```
gcli2api/
â”œâ”€â”€ web.py                          # FastAPI å…¥å£ (å¢å¼º)
â”œâ”€â”€ config.py                       # é…ç½® (å¢å¼º)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ unified_gateway_router.py   # ğŸ”´ ç»Ÿä¸€ç½‘å…³è·¯ç”± (3,701è¡Œ) [æ–°å¢]
â”‚   â”œâ”€â”€ antigravity_api.py          # æ ¸å¿ƒ API (å¢å¼º)
â”‚   â”œâ”€â”€ antigravity_router.py       # OpenAI æ ¼å¼è·¯ç”± (å¢å¼º)
â”‚   â”œâ”€â”€ antigravity_anthropic_router.py  # Anthropic æ ¼å¼è·¯ç”± (å¢å¼º)
â”‚   â”œâ”€â”€ anthropic_converter.py      # Anthropic æ ¼å¼è½¬æ¢ (å¢å¼º)
â”‚   â”œâ”€â”€ anthropic_streaming.py      # æµå¼å“åº”å¤„ç† (å¢å¼º, 664è¡Œ)
â”‚   â”œâ”€â”€ credential_manager.py       # å‡­è¯ç®¡ç† (å¢å¼º)
â”‚   â”œâ”€â”€ signature_cache.py          # ğŸŸ¢ æ€ç»´ç­¾åç¼“å­˜ (1,304è¡Œ) [æ–°å¢]
â”‚   â”œâ”€â”€ sse_collector.py            # ğŸŸ¢ SSE æ”¶é›†å™¨ (362è¡Œ) [æ–°å¢]
â”‚   â”œâ”€â”€ fallback_manager.py         # ğŸŸ¢ é™çº§ç®¡ç† (618è¡Œ) [æ–°å¢]
â”‚   â”œâ”€â”€ quota_protection.py         # ğŸŸ¢ é…é¢ä¿æŠ¤ [æ–°å¢]
â”‚   â”œâ”€â”€ smart_warmup.py             # ğŸŸ¢ æ™ºèƒ½é¢„çƒ­ [æ–°å¢]
â”‚   â”œâ”€â”€ context_truncation.py       # ğŸŸ¢ ä¸Šä¸‹æ–‡æˆªæ–­ [æ–°å¢]
â”‚   â”œâ”€â”€ ide_compat/                 # ğŸŸ¢ IDE å…¼å®¹å±‚ (2,484è¡Œ) [æ–°å¢]
â”‚   â”‚   â”œâ”€â”€ client_detector.py      # å®¢æˆ·ç«¯æ£€æµ‹ (305è¡Œ)
â”‚   â”‚   â”œâ”€â”€ sanitizer.py            # æ¶ˆæ¯å‡€åŒ– (608è¡Œ)
â”‚   â”‚   â”œâ”€â”€ middleware.py           # ä¸­é—´ä»¶ (386è¡Œ)
â”‚   â”‚   â”œâ”€â”€ hash_cache.py           # å†…å®¹å“ˆå¸Œç¼“å­˜ (620è¡Œ)
â”‚   â”‚   â””â”€â”€ state_manager.py        # SCID çŠ¶æ€æœº (534è¡Œ)
â”‚   â”œâ”€â”€ augment_compat/             # ğŸŸ¢ Augment å…¼å®¹å±‚ (1,929è¡Œ) [æ–°å¢]
â”‚   â”‚   â”œâ”€â”€ types.py                # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ ndjson.py               # NDJSON æµåè®®
â”‚   â”‚   â”œâ”€â”€ nodes_bridge.py         # èŠ‚ç‚¹è½¬æ¢
â”‚   â”‚   â””â”€â”€ tools_bridge.py         # å·¥å…·è½¬æ¢
â”‚   â”œâ”€â”€ cache/                      # ğŸŸ¢ ç­¾åç¼“å­˜ç³»ç»Ÿ (7,709è¡Œ) [æ–°å¢]
â”‚   â”‚   â”œâ”€â”€ cache_interface.py
â”‚   â”‚   â”œâ”€â”€ memory_cache.py
â”‚   â”‚   â”œâ”€â”€ signature_database.py
â”‚   â”‚   â””â”€â”€ migration/
â”‚   â”œâ”€â”€ converters/                 # æ ¼å¼è½¬æ¢å™¨ (å¢å¼º)
â”‚   â”‚   â”œâ”€â”€ message_converter.py    # æ¶ˆæ¯æ ¼å¼è½¬æ¢ (å¢å¼º)
â”‚   â”‚   â”œâ”€â”€ tool_converter.py       # å·¥å…·æ ¼å¼è½¬æ¢ (å¢å¼º)
â”‚   â”‚   â”œâ”€â”€ model_config.py         # æ¨¡å‹é…ç½® (å¢å¼º)
â”‚   â”‚   â”œâ”€â”€ thoughtSignature_fix.py # ğŸŸ¢ æ€ç»´ç­¾åä¿®å¤ [æ–°å¢]
â”‚   â”‚   â”œâ”€â”€ signature_recovery.py   # ğŸŸ¢ ç­¾åæ¢å¤ [æ–°å¢]
â”‚   â”‚   â””â”€â”€ tool_loop_recovery.py   # ğŸŸ¢ å·¥å…·å¾ªç¯æ¢å¤ [æ–°å¢]
â”‚   â”œâ”€â”€ services/                   # ğŸŸ¢ æœåŠ¡å±‚ [æ–°å¢]
â”‚   â”‚   â””â”€â”€ antigravity_service.py  # å†…éƒ¨è°ƒç”¨é€‚é…
â”‚   â”œâ”€â”€ api/                        # ğŸŸ¢ API å±‚ [æ–°å¢]
â”‚   â””â”€â”€ patch_*.py                  # ğŸŸ¢ çƒ­ä¿®å¤æ¨¡å— (å¤šä¸ª) [æ–°å¢]
â”œâ”€â”€ tests/                          # æµ‹è¯•æ–‡ä»¶ (å¢å¼º)
â”œâ”€â”€ docs/                           # æ–‡æ¡£ (å¤§é‡æ–°å¢)
â””â”€â”€ scripts/                        # è„šæœ¬ [æ–°å¢]
```

---

## ä¸‰ã€åŠŸèƒ½å·®å¼‚åˆ†æ

### 3.1 æˆ‘ä»¬åˆ†æ”¯ç‹¬æœ‰çš„åŠŸèƒ½æ¨¡å—

| æ¨¡å— | ä»£ç è¡Œæ•° | åŠŸèƒ½æè¿° | ä¸å®˜æ–¹è€¦åˆåº¦ |
|------|---------|---------|------------|
| `unified_gateway_router.py` | 3,701 è¡Œ | ç»Ÿä¸€ç½‘å…³è·¯ç”±ï¼Œå¤šåç«¯æ”¯æŒ | ğŸ”´ é«˜ |
| `ide_compat/` | 2,484 è¡Œ | IDE å®¢æˆ·ç«¯å…¼å®¹å±‚ | ğŸŸ¢ ä½ |
| `augment_compat/` | 1,929 è¡Œ | Augment NDJSON åè®®æ”¯æŒ | ğŸŸ¢ ä½ |
| `cache/` | 7,709 è¡Œ | æ€ç»´ç­¾åç¼“å­˜ç³»ç»Ÿ | ğŸŸ¡ ä¸­ |
| `signature_cache.py` | 1,304 è¡Œ | ç­¾åç¼“å­˜æ ¸å¿ƒ | ğŸŸ¡ ä¸­ |
| `fallback_manager.py` | 618 è¡Œ | é™çº§å’Œæ•…éšœè½¬ç§» | ğŸŸ¡ ä¸­ |
| `sse_collector.py` | 362 è¡Œ | SSE æµæ”¶é›†å™¨ | ğŸŸ¢ ä½ |
| `quota_protection.py` | ~300 è¡Œ | é…é¢ä¿æŠ¤ | ğŸŸ¡ ä¸­ |
| `smart_warmup.py` | ~200 è¡Œ | æ™ºèƒ½é¢„çƒ­ | ğŸŸ¡ ä¸­ |
| `context_truncation.py` | ~400 è¡Œ | ä¸Šä¸‹æ–‡æˆªæ–­ | ğŸŸ¢ ä½ |
| `converters/ç­¾åç›¸å…³` | ~600 è¡Œ | ç­¾åä¿®å¤/æ¢å¤ | ğŸŸ¡ ä¸­ |
| `patch_*.py` çƒ­ä¿®å¤ | ~1,500 è¡Œ | å„ç±»çƒ­ä¿®å¤ | ğŸ”´ é«˜ |
| **æ€»è®¡** | **~21,107 è¡Œ** | | |

### 3.2 å®˜æ–¹æ¨¡å—å¢å¼ºå¯¹æ¯”

| æ¨¡å— | å®˜æ–¹è¡Œæ•° | æˆ‘ä»¬è¡Œæ•° | å¢é‡ | å¢å¼ºå†…å®¹ |
|------|---------|---------|------|---------|
| `antigravity_api.py` | ~800 | ~1,200 | +400 | å¤šåç«¯æ”¯æŒã€é™çº§é€»è¾‘ |
| `antigravity_router.py` | ~600 | ~1,800 | +1,200 | ç½‘å…³é›†æˆã€å·¥å…·å¤„ç† |
| `antigravity_anthropic_router.py` | ~500 | ~1,500 | +1,000 | æ€ç»´æ¨¡å¼ã€ç­¾åå¤„ç† |
| `anthropic_converter.py` | ~400 | ~800 | +400 | ç­¾åæ³¨å…¥ã€æ ¼å¼å…¼å®¹ |
| `anthropic_streaming.py` | ~300 | ~664 | +364 | æµå¼ç­¾åå¤„ç† |
| `credential_manager.py` | ~300 | ~600 | +300 | å¤šåç«¯å‡­è¯ã€é™çº§ |
| `converters/` | ~600 | ~1,500 | +900 | æ€ç»´ç­¾åã€å·¥å…·å¾ªç¯ |
| **æ€»è®¡** | **~3,500** | **~8,064** | **+4,564** | |

---

## å››ã€åç«¯æ¶æ„å·®å¼‚

### 4.1 å®˜æ–¹æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   web.py        â”‚
                    â”‚  (FastAPI)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
              â–¼              â–¼              â–¼
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚  OpenAI   â”‚  â”‚ Anthropic â”‚  â”‚   Web     â”‚
      â”‚  Router   â”‚  â”‚  Router   â”‚  â”‚  Routes   â”‚
      â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚              â”‚
            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ Antigravity   â”‚
           â”‚    API        â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚  Credential   â”‚
           â”‚   Manager     â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**: å•ä¸€åç«¯ï¼Œç›´æ¥è°ƒç”¨

### 4.2 æˆ‘ä»¬çš„æ¶æ„

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   web.py        â”‚
                    â”‚  (FastAPI)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                        â”‚                        â”‚
    â–¼                        â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenAI  â”‚          â”‚   Unified     â”‚          â”‚Anthropicâ”‚
â”‚ Router  â”‚          â”‚   Gateway     â”‚          â”‚ Router  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚   Router      â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚               â”‚  (3,701è¡Œ)    â”‚               â”‚
     â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
     â”‚                       â”‚                       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚IDE Compat â”‚      â”‚  Augment  â”‚      â”‚ Signature â”‚
   â”‚  Layer    â”‚      â”‚  Compat   â”‚      â”‚  Cache    â”‚
   â”‚ (2,484è¡Œ) â”‚      â”‚ (1,929è¡Œ) â”‚      â”‚ (9,013è¡Œ) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚Antigravityâ”‚      â”‚  Copilot  â”‚      â”‚   Kiro    â”‚
   â”‚ Backend   â”‚      â”‚  Backend  â”‚      â”‚  Gateway  â”‚
   â”‚(Priority1)â”‚      â”‚(Priority2)â”‚      â”‚(Priority3)â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Fallback  â”‚      â”‚  Quota    â”‚      â”‚  Smart    â”‚
   â”‚ Manager   â”‚      â”‚Protection â”‚      â”‚  Warmup   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**: å¤šåç«¯ç½‘å…³ï¼Œå¸¦å…¼å®¹å±‚å’Œç¼“å­˜ç³»ç»Ÿ

---

## äº”ã€å…³é”®æ–‡ä»¶å¯¹æ¯”

### 5.1 unified_gateway_router.py (æˆ‘ä»¬ç‹¬æœ‰)

| è¡Œå·èŒƒå›´ | åŠŸèƒ½æ¨¡å— | æè¿° |
|---------|---------|------|
| 1-70 | å¯¼å…¥å’Œé…ç½® | æ ‡å‡†åº“ã€FastAPIã€Augment æ¡ä»¶å¯¼å…¥ |
| 71-100 | æ¨¡å‹è·¯ç”±é…ç½® | ROUTABLE_MODELS, USE_PATTERN |
| 100-320 | å·¥å…·å¾ªç¯å¤„ç† | stream_openai_with_tool_loop() |
| 325-370 | åç«¯é…ç½® | BACKENDS å­—å…¸ã€KIRO_GATEWAY_MODELS |
| 370-450 | Bugment çŠ¶æ€ | _BUGMENT_TOOL_STATE, _BUGMENT_CONVERSATION_STATE |
| 450-620 | è¯·æ±‚è§„èŒƒåŒ– | normalize_request_body(), normalize_tools() |
| 620-720 | è·¯ç”±é€»è¾‘ | get_backend_for_model(), get_sorted_backends() |
| 720-900 | ä»£ç†è¯·æ±‚ | proxy_request_to_backend(), route_request_with_fallback() |
| 900-1200 | Gateway ç«¯ç‚¹ | /v1/models, /v1/chat/completions, /v1/messages |
| 1200-1600 | Augment å…¼å®¹ | stream_openai_with_nodes_bridge() |
| 1600-2000 | Bugment ç«¯ç‚¹ | /get-models, /usage/api/get-models |
| 2000-2500 | Augment Router | /chat-stream ç­‰æ— å‰ç¼€ç«¯ç‚¹ |
| 2500-3000 | SSE è½¬æ¢ | convert_sse_to_augment_ndjson() |
| 3000-3701 | è¾…åŠ©åŠŸèƒ½ | ä½™é¢æŸ¥è¯¢ã€å¥åº·æ£€æŸ¥ |

### 5.2 æ ¸å¿ƒå·®å¼‚: åç«¯é…ç½®

**å®˜æ–¹**: æ— åç«¯é…ç½®æ¦‚å¿µï¼Œç›´æ¥è°ƒç”¨ Antigravity API

**æˆ‘ä»¬çš„å®ç°**:
```python
# src/unified_gateway_router.py:325-370
BACKENDS = {
    "antigravity": {
        "base_url": ANTIGRAVITY_ENDPOINT,
        "priority": 1,
        "models": ["*"],  # æ”¯æŒæ‰€æœ‰æ¨¡å‹
        "enabled": True,
    },
    "copilot": {
        "base_url": COPILOT_ENDPOINT,
        "priority": 2,
        "models": ["gpt-4", "gpt-4-turbo", ...],
        "enabled": COPILOT_ENABLED,
    },
    "kiro-gateway": {
        "base_url": KIRO_GATEWAY_ENDPOINT,
        "priority": 3,
        "models": KIRO_GATEWAY_MODELS,
        "enabled": KIRO_GATEWAY_ENABLED,
    },
}
```

---

## å…­ã€åŒæ­¥éš¾åº¦è¯„ä¼°

### 6.1 å¯ç›´æ¥åŒæ­¥çš„æ¨¡å— (ä½é£é™©)

| æ¨¡å— | åŸå›  |
|------|------|
| `models.py` | æ•°æ®æ¨¡å‹ï¼Œé€šå¸¸åªå¢ä¸æ”¹ |
| `auth.py` | è®¤è¯é€»è¾‘ï¼Œå˜åŒ–å°‘ |
| `utils.py` | å·¥å…·å‡½æ•°ï¼Œå¯åˆå¹¶ |
| `web_routes.py` | Web è·¯ç”±ï¼Œå¯åˆå¹¶ |
| `front/` | å‰ç«¯æ–‡ä»¶ï¼Œå¯ç›´æ¥è¦†ç›– |

### 6.2 éœ€è°¨æ…åŒæ­¥çš„æ¨¡å— (ä¸­ç­‰é£é™©)

| æ¨¡å— | é£é™©ç‚¹ |
|------|--------|
| `antigravity_api.py` | æˆ‘ä»¬æ·»åŠ äº†å¤šåç«¯æ”¯æŒå’Œé™çº§é€»è¾‘ |
| `credential_manager.py` | æˆ‘ä»¬æ·»åŠ äº†å¤šåç«¯å‡­è¯ç®¡ç† |
| `anthropic_converter.py` | æˆ‘ä»¬æ·»åŠ äº†ç­¾åæ³¨å…¥é€»è¾‘ |
| `converters/` | æˆ‘ä»¬æ·»åŠ äº†å¤§é‡å…¼å®¹æ€§å¤„ç† |

### 6.3 ä¸åº”åŒæ­¥çš„æ¨¡å— (æˆ‘ä»¬ç‹¬æœ‰)

| æ¨¡å— | åŸå›  |
|------|------|
| `unified_gateway_router.py` | å®Œå…¨è‡ªç ” |
| `ide_compat/` | å®Œå…¨è‡ªç ” |
| `augment_compat/` | å®Œå…¨è‡ªç ” |
| `cache/` | å®Œå…¨è‡ªç ” |
| `signature_cache.py` | å®Œå…¨è‡ªç ” |
| `fallback_manager.py` | å®Œå…¨è‡ªç ” |
| `patch_*.py` | å®Œå…¨è‡ªç ” |

---

## ä¸ƒã€ä¸Šæ¸¸åŒæ­¥ç­–ç•¥å»ºè®®

### 7.1 æ¨èç­–ç•¥: é€‰æ‹©æ€§åˆå¹¶

```bash
# 1. æ·»åŠ å®˜æ–¹ä»“åº“ä¸ºè¿œç¨‹
git remote add official https://github.com/xxx/gcli2api.git

# 2. è·å–å®˜æ–¹æ›´æ–°
git fetch official

# 3. åˆ›å»ºå¯¹æ¯”åˆ†æ”¯
git checkout -b sync/official-YYYYMMDD official/main

# 4. é€‰æ‹©æ€§åˆå¹¶å®‰å…¨æ¨¡å—
git checkout master
git checkout sync/official-YYYYMMDD -- src/models.py
git checkout sync/official-YYYYMMDD -- src/auth.py
git checkout sync/official-YYYYMMDD -- src/utils.py
git checkout sync/official-YYYYMMDD -- front/

# 5. æ‰‹åŠ¨åˆå¹¶æœ‰å†²çªçš„æ¨¡å—
# ä½¿ç”¨ diff å·¥å…·æ¯”è¾ƒå˜åŒ–ï¼Œæ‰‹åŠ¨åˆå¹¶
```

### 7.2 ä¸æ¨èç­–ç•¥

âŒ `git merge official/main` - ä¼šå¯¼è‡´å¤§é‡å†²çª
âŒ `git rebase official/main` - ä¼šæ‰“ä¹±æˆ‘ä»¬çš„æäº¤å†å²
âŒ å¼ºåˆ¶è¦†ç›– - ä¼šä¸¢å¤±æˆ‘ä»¬çš„è‡ªç ”åŠŸèƒ½

---

## å…«ã€é‡æ„ååŒæ­¥é¢„æœŸ

### 8.1 é‡æ„å®Œæˆåçš„ç›®å½•ç»“æ„

```
gcli2api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ [å®˜æ–¹æ ¸å¿ƒæ¨¡å—]           # å¯ä¸å®˜æ–¹ä¿æŒåŒæ­¥
â”‚   â”‚   â”œâ”€â”€ antigravity_api.py
â”‚   â”‚   â”œâ”€â”€ credential_manager.py
â”‚   â”‚   â”œâ”€â”€ models.py
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â””â”€â”€ gateway/                  # ğŸŸ¢ ç‹¬ç«‹çš„ç½‘å…³æ¨¡å—
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ config.py
â”‚       â”œâ”€â”€ routing.py
â”‚       â”œâ”€â”€ proxy.py
â”‚       â”œâ”€â”€ endpoints/
â”‚       â”œâ”€â”€ augment/
â”‚       â””â”€â”€ sse/
â”‚
â”œâ”€â”€ src/ide_compat/               # ğŸŸ¢ ç‹¬ç«‹çš„ IDE å…¼å®¹å±‚
â”œâ”€â”€ src/augment_compat/           # ğŸŸ¢ ç‹¬ç«‹çš„ Augment å…¼å®¹å±‚
â”œâ”€â”€ src/cache/                    # ğŸŸ¢ ç‹¬ç«‹çš„ç­¾åç¼“å­˜ç³»ç»Ÿ
â””â”€â”€ ...
```

### 8.2 é‡æ„ååŒæ­¥èƒ½åŠ›

| åœºæ™¯ | éš¾åº¦ | è¯´æ˜ |
|------|-----|------|
| å®˜æ–¹æ ¸å¿ƒæ¨¡å—æ›´æ–° | ğŸŸ¢ ä½ | å¯ç›´æ¥åˆå¹¶æˆ–è¦†ç›– |
| å®˜æ–¹æ–°å¢åŠŸèƒ½ | ğŸŸ¡ ä¸­ | éœ€è¯„ä¼°æ˜¯å¦ä¸ç½‘å…³å†²çª |
| å®˜æ–¹ API å˜æ›´ | ğŸŸ¡ ä¸­ | éœ€æ›´æ–°ç½‘å…³é€‚é…å±‚ |
| å®˜æ–¹æ¶æ„é‡æ„ | ğŸ”´ é«˜ | éœ€è¦é‡æ–°è¯„ä¼°é›†æˆç­–ç•¥ |

---

## ä¹ã€é™„å½•

### 9.1 ä»£ç è¡Œæ•°ç»Ÿè®¡å‘½ä»¤

```bash
# ç»Ÿè®¡ Python æ–‡ä»¶è¡Œæ•°
find . -name "*.py" -not -path "./.venv/*" | xargs wc -l

# ç»Ÿè®¡ç‰¹å®šç›®å½•
wc -l src/unified_gateway_router.py
wc -l src/ide_compat/*.py
wc -l src/augment_compat/*.py
wc -l src/cache/*.py
```

### 9.2 æ–‡ä»¶å·®å¼‚å¯¹æ¯”å‘½ä»¤

```bash
# å¯¹æ¯”ä¸¤ä¸ªä»“åº“çš„æ–‡ä»¶ç»“æ„
diff -rq gcli2api/src gcli2api_official/src

# å¯¹æ¯”ç‰¹å®šæ–‡ä»¶
diff gcli2api/src/antigravity_api.py gcli2api_official/src/antigravity_api.py
```

---

**æ–‡æ¡£ç»“æŸ**

ä¸‹ä¸€æ­¥: é˜…è¯» [03_é‡æ„å®æ–½è®¡åˆ’.md](./03_é‡æ„å®æ–½è®¡åˆ’.md)
