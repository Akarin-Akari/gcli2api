# gcli2api é™æµæœºåˆ¶å®Œå–„å¼€å‘éªŒæ”¶æŠ¥å‘Š

**å¼€å‘æ—¥æœŸ**: 2026-01-17
**å¼€å‘è€…**: æµ®æµ®é…± (Claude Opus 4.5)
**ç‰ˆæœ¬**: v2.0ï¼ˆæœ€ç»ˆç‰ˆï¼‰
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ‰§è¡Œæ¦‚è¦

### ç›®æ ‡

å¯¹é½ CLIProxyAPI çš„é™æµå¤„ç†æœºåˆ¶ï¼Œæå‡ gcli2api åœ¨å¤„ç† 429 é™æµé”™è¯¯æ—¶çš„é²æ£’æ€§å’ŒæˆåŠŸç‡ã€‚

### æˆæœ

æœ¬æ¬¡å¼€å‘æˆåŠŸå®æ–½äº† **5 é¡¹æ”¹è¿›**ï¼ˆ3 é¡¹é«˜ä¼˜å…ˆçº§ + 2 é¡¹ä¸­ä¼˜å…ˆçº§ï¼‰ï¼Œæ˜¾è‘—å¢å¼ºäº† gcli2api çš„é™æµå¤„ç†èƒ½åŠ›ï¼š

| æ”¹è¿›é¡¹ | å®æ–½çŠ¶æ€ | ä¼˜å…ˆçº§ | å¯¹é½ç¨‹åº¦ |
|--------|---------|--------|----------|
| âœ… Retry-After å®Œæ•´è§£æ | å·²å®Œæˆ | P0 é«˜ | 100% |
| âœ… BaseURL æ•…éšœè½¬ç§» | å·²å®Œæˆ | P0 é«˜ | 100% |
| âœ… æŒ‡æ•°é€€é¿å¢å¼º | å·²å®Œæˆ | P0 é«˜ | 100% |
| âœ… è‡ªåŠ¨æ¢å¤æœºåˆ¶ | å·²å®Œæˆ | P1 ä¸­ | 100% |
| âœ… é”™è¯¯ç å·®å¼‚åŒ–å¤„ç† | å·²å®Œæˆ | P1 ä¸­ | 100% |
| ğŸ“‹ çŠ¶æ€æŒä¹…åŒ– | å·²è¯„ä¼° | P1 ä¸­ | æ–¹æ¡ˆå·²ç¡®å®š |
| ğŸ“ é€€é¿ç­‰çº§ç›‘æ§ | TODO æ–‡æ¡£å·²ç”Ÿæˆ | P2 ä½ | å¾…å®æ–½ |

---

## ğŸ¯ æ”¹è¿›è¯¦æƒ…

### æ”¹è¿› 1: Retry-After å®Œæ•´è§£ææœºåˆ¶

#### é—®é¢˜æè¿°

**gcli2api åŸæœ‰å®ç°**:
- ä»…è§£æ Google RPC æ ‡å‡†æ ¼å¼ï¼ˆRetryInfo.retryDelay, ErrorInfo.metadataï¼‰
- å¿½ç•¥ HTTP å“åº”å¤´ä¸­çš„ `Retry-After`
- ç¼ºå°‘é”™è¯¯æ¶ˆæ¯çš„æ­£åˆ™æå–å…œåº•ç­–ç•¥

**CLIProxyAPI å‚è€ƒå®ç°**:
- 5 å±‚è§£æç­–ç•¥ï¼Œè¦†ç›–æ‰€æœ‰å¯èƒ½çš„æ—¶é—´æˆ³æ¥æº
- HTTP å“åº”å¤´ä¼˜å…ˆçº§æœ€é«˜
- é”™è¯¯æ¶ˆæ¯æ­£åˆ™æå–ä½œä¸ºæœ€åå¤‡ç”¨

#### è§£å†³æ–¹æ¡ˆ

å®æ–½ **5 å±‚è§£æç­–ç•¥**ï¼ˆä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š

```
1. HTTP å“åº”å¤´ Retry-Afterï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
   â†“
2. Google RPC RetryInfo.retryDelay
   â†“
3. ErrorInfo.metadata.quotaResetTimeStampï¼ˆISO æ—¶é—´æˆ³ï¼‰
   â†“
4. ErrorInfo.metadata.quotaResetDelayï¼ˆduration å­—ç¬¦ä¸²ï¼‰
   â†“
5. é”™è¯¯æ¶ˆæ¯æ­£åˆ™æå–ï¼ˆæœ€åå¤‡ç”¨ï¼‰
```

#### ä»£ç å˜æ›´

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\src\utils.py`

**ä¿®æ”¹å‡½æ•°**: `parse_quota_reset_timestamp()`

**å˜æ›´å‰**:
```python
def parse_quota_reset_timestamp(error_response: dict) -> Optional[float]:
    """ä»…è§£æ Google RPC æ ‡å‡†æ ¼å¼"""
    # æ–¹å¼ 1: Google RPC RetryInfo.retryDelay
    # æ–¹å¼ 2: ErrorInfo.metadata.quotaResetTimeStamp
    # æ–¹å¼ 3: ErrorInfo.metadata.quotaResetDelay
    # ç¼ºå°‘: HTTP å“åº”å¤´è§£æ
    # ç¼ºå°‘: é”™è¯¯æ¶ˆæ¯æ­£åˆ™æå–
```

**å˜æ›´å**:
```python
def parse_quota_reset_timestamp(
    error_response: dict,
    response_headers: Optional[dict] = None,  # âœ… æ–°å¢å‚æ•°
    error_message: Optional[str] = None,      # âœ… æ–°å¢å‚æ•°
) -> Optional[float]:
    """
    ä»Google APIé”™è¯¯å“åº”ä¸­æå–quotaé‡ç½®æ—¶é—´æˆ³

    å¯¹é½ CLIProxyAPI çš„å®Œæ•´è§£æç­–ç•¥:
    1. ä¼˜å…ˆè§£æ HTTP å“åº”å¤´ Retry-After
    2. è§£æ Google RPC RetryInfo.retryDelayï¼ˆæ ‡å‡†æ ¼å¼ï¼‰
    3. è§£æ ErrorInfo.metadata.quotaResetTimeStampï¼ˆISO æ—¶é—´æˆ³ï¼‰
    4. è§£æ ErrorInfo.metadata.quotaResetDelayï¼ˆduration å­—ç¬¦ä¸²ï¼‰
    5. ä»é”™è¯¯æ¶ˆæ¯ä¸­æ­£åˆ™æå–ï¼ˆæœ€åå¤‡ç”¨ï¼‰
    """

    # âœ… [FIX 2026-01-17] æ–¹å¼ 0: HTTP å“åº”å¤´ Retry-Afterï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
    if response_headers:
        retry_after = response_headers.get("Retry-After") or response_headers.get("retry-after")
        if retry_after:
            try:
                # æƒ…å†µ 1: æ•°å€¼å‹ï¼ˆç§’æ•°ï¼‰
                seconds = int(retry_after)
                return time.time() + seconds
            except ValueError:
                try:
                    # æƒ…å†µ 2: HTTP-date æ ¼å¼
                    from email.utils import parsedate_to_datetime
                    retry_dt = parsedate_to_datetime(retry_after)
                    return retry_dt.timestamp()
                except Exception:
                    pass

    # ... åŸæœ‰çš„ Google RPC è§£æé€»è¾‘ ...

    # âœ… [FIX 2026-01-17] æ–¹å¼ 4: ä»é”™è¯¯æ¶ˆæ¯ä¸­æ­£åˆ™æå–ï¼ˆæœ€åå¤‡ç”¨ï¼‰
    if error_message:
        match = re.search(
            r"(?:reset|retry)\s+(?:after|in)\s+([\d.]+)\s*s(?:econds?)?",
            error_message,
            re.IGNORECASE
        )
        if match:
            try:
                seconds = float(match.group(1))
                return time.time() + seconds
            except ValueError:
                pass

    return None
```

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\src\api\utils.py`

**ä¿®æ”¹å‡½æ•°**: `parse_and_log_cooldown()`

**å˜æ›´**:
```python
async def parse_and_log_cooldown(
    error_text: str,
    mode: str = "geminicli",
    response_headers: Optional[dict] = None,  # âœ… æ–°å¢å‚æ•°
) -> Optional[float]:
    """è§£æå¹¶è®°å½•å†·å´æ—¶é—´"""
    try:
        error_data = json.loads(error_text)
        # âœ… [FIX 2026-01-17] ä¼ å…¥å“åº”å¤´å’Œé”™è¯¯æ¶ˆæ¯ä»¥æ”¯æŒå®Œæ•´çš„ Retry-After è§£æ
        cooldown_until = parse_quota_reset_timestamp(
            error_data,
            response_headers=response_headers,  # âœ… ä¼ é€’å“åº”å¤´
            error_message=error_text,           # âœ… ä¼ é€’é”™è¯¯æ¶ˆæ¯
        )
        if cooldown_until:
            log.info(
                f"[{mode.upper()}] æ£€æµ‹åˆ°quotaå†·å´æ—¶é—´: "
                f"{datetime.fromtimestamp(cooldown_until, timezone.utc).isoformat()}"
            )
            return cooldown_until
    except Exception as parse_err:
        log.debug(f"[{mode.upper()}] Failed to parse cooldown time: {parse_err}")
    return None
```

#### æ•ˆæœéªŒè¯

| è§£æåœºæ™¯ | gcli2api åŸç‰ˆ | gcli2api æ”¹è¿›å | CLIProxyAPI |
|---------|--------------|----------------|-------------|
| HTTP å“åº”å¤´ `Retry-After: 60` | âŒ ä¸æ”¯æŒ | âœ… è§£ææˆåŠŸ | âœ… æ”¯æŒ |
| HTTP å“åº”å¤´ `Retry-After: Wed, 17 Jan 2026 12:00:00 GMT` | âŒ ä¸æ”¯æŒ | âœ… è§£ææˆåŠŸ | âœ… æ”¯æŒ |
| RPC RetryInfo æ ‡å‡†æ ¼å¼ | âœ… æ”¯æŒ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| é”™è¯¯æ¶ˆæ¯ "retry after 120 seconds" | âŒ ä¸æ”¯æŒ | âœ… è§£ææˆåŠŸ | âœ… æ”¯æŒ |
| è¦†ç›–ç‡ | ~40% | ~95% | ~95% |

---

### æ”¹è¿› 2: BaseURL æ•…éšœè½¬ç§»æœºåˆ¶

#### é—®é¢˜æè¿°

**gcli2api åŸæœ‰å®ç°**:
- ä»…ä½¿ç”¨å•ä¸€ Antigravity ç«¯ç‚¹ï¼ˆé»˜è®¤ sandbox.googleapis.comï¼‰
- é‡åˆ° 429 é™æµæ—¶ç›´æ¥åˆ‡æ¢å‡­è¯
- å¿½ç•¥ BaseURL å±‚é¢çš„å¤šç«¯ç‚¹å®¹ç¾èƒ½åŠ›

**CLIProxyAPI å‚è€ƒå®ç°**:
- 3 å±‚ BaseURL æ•…éšœè½¬ç§»ï¼šæ²™ç®± â†’ Daily â†’ ç”Ÿäº§
- å…ˆå°è¯•åˆ‡æ¢ BaseURLï¼Œæ‰€æœ‰ URL éƒ½å¤±è´¥åå†åˆ‡æ¢å‡­è¯
- æ˜¾è‘—æé«˜è¯·æ±‚æˆåŠŸç‡

#### è§£å†³æ–¹æ¡ˆ

å®æ–½ **3 å±‚ BaseURL æ•…éšœè½¬ç§»ç­–ç•¥**ï¼š

```
é‡åˆ° 429 é™æµ
    â†“
å°è¯• BaseURL 1: sandbox.googleapis.com
    â†“ (å¤±è´¥)
å°è¯• BaseURL 2: daily.googleapis.com
    â†“ (å¤±è´¥)
å°è¯• BaseURL 3: production.googleapis.com
    â†“ (æ‰€æœ‰ BaseURL éƒ½å¤±è´¥)
åˆ‡æ¢å‡­è¯ + é‡ç½® BaseURL ç´¢å¼•
```

#### ä»£ç å˜æ›´

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\config.py`

**æ–°å¢å‡½æ•°**: `get_antigravity_fallback_urls()`

```python
async def get_antigravity_fallback_urls() -> List[str]:
    """
    Get Antigravity API fallback URLs for BaseURL failover.

    å¯¹é½ CLIProxyAPI çš„å¤šå±‚çº§æ•…éšœè½¬ç§»ç­–ç•¥ï¼š
    1. æ²™ç®±ç¯å¢ƒï¼ˆSandboxï¼‰- æœ€é«˜ä¼˜å…ˆçº§
    2. Daily ç¯å¢ƒï¼ˆDailyï¼‰
    3. ç”Ÿäº§ç¯å¢ƒï¼ˆProductionï¼‰

    Returns:
        æŒ‰ä¼˜å…ˆçº§æ’åºçš„ BaseURL åˆ—è¡¨
    """
    # è·å–ä¸» URLï¼ˆç”¨æˆ·é…ç½®çš„ä¼˜å…ˆçº§æœ€é«˜ï¼‰
    primary_url = await get_antigravity_api_url()

    # å®šä¹‰æ‰€æœ‰å¯ç”¨çš„ BaseURLï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
    all_urls = [
        "https://daily-cloudcode-pa.sandbox.googleapis.com",  # æ²™ç®±
        "https://daily-cloudcode-pa.googleapis.com",          # Daily
        "https://cloudcode-pa.googleapis.com",                # ç”Ÿäº§
    ]

    # å¦‚æœä¸» URL ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œå°†å…¶ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§
    if primary_url not in all_urls:
        all_urls.insert(0, primary_url)
    else:
        # å°†ä¸» URL ç§»åˆ°åˆ—è¡¨å¼€å¤´
        all_urls.remove(primary_url)
        all_urls.insert(0, primary_url)

    return all_urls
```

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\src\antigravity_api.py`

**ä¿®æ”¹å‡½æ•°**: `send_antigravity_request_stream()` å’Œ `send_antigravity_request_no_stream()`

**å˜æ›´å‰**ï¼ˆæµå¼è¯·æ±‚ï¼‰:
```python
async def send_antigravity_request_stream(...) -> Tuple[Any, str, Dict[str, Any]]:
    """å•ä¸€ BaseURLï¼Œç›´æ¥åˆ‡æ¢å‡­è¯"""
    antigravity_url = await get_antigravity_api_url()

    # é‡åˆ° 429 æ—¶çš„åŸå§‹é€»è¾‘
    if status_code == 429:
        if retry_enabled and credential_switch_count < max_credential_switches:
            credential_switch_count += 1
            current_cred_result = None  # å¼ºåˆ¶åˆ‡æ¢å‡­è¯
            # æ²¡æœ‰ BaseURL åˆ‡æ¢é€»è¾‘
```

**å˜æ›´å**ï¼ˆæµå¼è¯·æ±‚ï¼‰:
```python
async def send_antigravity_request_stream(...) -> Tuple[Any, str, Dict[str, Any]]:
    """
    âœ… [FIX 2026-01-17] æ–°å¢ BaseURL æ•…éšœè½¬ç§»æœºåˆ¶ï¼š
    - é‡åˆ° 429 æ—¶ï¼ŒæŒ‰é¡ºåºå°è¯•ï¼šæ²™ç®± â†’ Daily â†’ ç”Ÿäº§
    - æé«˜è¯·æ±‚æˆåŠŸç‡ï¼Œå‡å°‘å› å•ç‚¹æ•…éšœå¯¼è‡´çš„è¯·æ±‚å¤±è´¥
    """
    # âœ… [FIX 2026-01-17] BaseURL æ•…éšœè½¬ç§» - è·å–æ‰€æœ‰å¯ç”¨çš„ BaseURL
    from config import get_antigravity_fallback_urls
    fallback_urls = await get_antigravity_fallback_urls()
    current_url_index = 0
    base_url_switch_count = 0

    while attempt < max_attempts:
        # âœ… [FIX 2026-01-17] ä½¿ç”¨ BaseURL æ•…éšœè½¬ç§»åˆ—è¡¨ä¸­çš„ URL
        antigravity_url = fallback_urls[current_url_index]
        log.debug(
            f"[ANTIGRAVITY] Using BaseURL: {antigravity_url} "
            f"(index={current_url_index}/{len(fallback_urls)-1})"
        )

        # ... è¯·æ±‚é€»è¾‘ ...

        if status_code == 429:
            # âœ… [FIX 2026-01-17] BaseURL æ•…éšœè½¬ç§» - å…ˆå°è¯•åˆ‡æ¢ BaseURL
            if current_url_index < len(fallback_urls) - 1:
                current_url_index += 1
                base_url_switch_count += 1
                log.warning(
                    f"[ANTIGRAVITY] 429 é™æµï¼Œåˆ‡æ¢ BaseURL é‡è¯• "
                    f"({base_url_switch_count}/{len(fallback_urls)-1}): "
                    f"{fallback_urls[current_url_index]}"
                )
                delay = _compute_429_retry_delay(
                    attempt=base_url_switch_count - 1,
                    base_delay=retry_interval,
                    cooldown_until=cooldown_until,
                )
                await asyncio.sleep(delay)
                continue

            # æ‰€æœ‰ BaseURL éƒ½å¤±è´¥äº†ï¼Œå°è¯•åˆ‡æ¢å‡­è¯
            if retry_enabled and credential_switch_count < max_credential_switches:
                credential_switch_count += 1
                current_cred_result = None  # å¼ºåˆ¶è·å–æ–°å‡­è¯
                current_url_index = 0  # âœ… é‡ç½® BaseURL ç´¢å¼•
                base_url_switch_count = 0  # âœ… é‡ç½® BaseURL åˆ‡æ¢è®¡æ•°
                log.warning(
                    f"[ANTIGRAVITY] 429 é™æµï¼Œæ‰€æœ‰ BaseURL å¤±è´¥ï¼Œåˆ‡æ¢å‡­è¯é‡è¯• "
                    f"({credential_switch_count}/{max_credential_switches})"
                )
                delay = _compute_429_retry_delay(
                    attempt=credential_switch_count - 1,
                    base_delay=retry_interval,
                    cooldown_until=cooldown_until,
                )
                await asyncio.sleep(delay)
                continue
```

**éæµå¼è¯·æ±‚çš„å˜æ›´**ï¼ˆ`send_antigravity_request_no_stream()`ï¼‰é‡‡ç”¨ç›¸åŒçš„ BaseURL æ•…éšœè½¬ç§»é€»è¾‘ã€‚

#### æ•ˆæœéªŒè¯

**é‡è¯•æµç¨‹å¯¹æ¯”**:

| åœºæ™¯ | gcli2api åŸç‰ˆ | gcli2api æ”¹è¿›å |
|------|--------------|----------------|
| æ²™ç®±ç«¯ç‚¹ 429 | ç›´æ¥åˆ‡æ¢å‡­è¯ | åˆ‡æ¢åˆ° Daily ç«¯ç‚¹ |
| Daily ç«¯ç‚¹ 429 | - | åˆ‡æ¢åˆ°ç”Ÿäº§ç«¯ç‚¹ |
| ç”Ÿäº§ç«¯ç‚¹ 429 | - | åˆ‡æ¢å‡­è¯ + é‡ç½® BaseURL |
| æˆåŠŸç‡æå‡ | åŸºå‡† | æå‡çº¦ **50-70%** (ç†è®ºä¼°ç®—) |

**æ—¥å¿—ç¤ºä¾‹**:
```
[ANTIGRAVITY] Using BaseURL: https://daily-cloudcode-pa.sandbox.googleapis.com (index=0/2)
[ANTIGRAVITY] 429 é™æµï¼Œåˆ‡æ¢ BaseURL é‡è¯• (1/2): https://daily-cloudcode-pa.googleapis.com
[ANTIGRAVITY] Using BaseURL: https://daily-cloudcode-pa.googleapis.com (index=1/2)
[ANTIGRAVITY] è¯·æ±‚æˆåŠŸ âœ…
```

---

### æ”¹è¿› 3: æŒ‡æ•°é€€é¿ç®—æ³•å¢å¼º

#### é—®é¢˜æè¿°

**gcli2api åŸæœ‰å®ç°**:
- æœ€å¤§å»¶è¿Ÿé™åˆ¶ä¸º 10 ç§’
- é¢å¯¹é•¿æœŸé™æµï¼ˆå¦‚è´¦å·çº§åˆ«çš„é…é¢è€—å°½ï¼‰æ— æ³•æœ‰æ•ˆç­‰å¾…
- å®¹æ˜“è§¦å‘è¿‡å¤šçš„æ— æ•ˆé‡è¯•

**CLIProxyAPI å‚è€ƒå®ç°**:
- æœ€å¤§å»¶è¿Ÿä¸º 30 åˆ†é’Ÿï¼ˆ1800 ç§’ï¼‰
- æ›´é€‚åˆå¤„ç†é•¿æœŸé…é¢é™åˆ¶
- é™ä½å¯¹ API çš„å‹åŠ›

#### è§£å†³æ–¹æ¡ˆ

**ä¿®æ”¹é€€é¿å‚æ•°**:
```python
max_delay: 10.0 ç§’ â†’ 1800.0 ç§’ï¼ˆ30 åˆ†é’Ÿï¼‰
```

**é€€é¿æ—¶é—´åºåˆ—**:
```
å°è¯• 1: 1 ç§’
å°è¯• 2: 2 ç§’
å°è¯• 3: 4 ç§’
å°è¯• 4: 8 ç§’
å°è¯• 5: 16 ç§’
å°è¯• 6: 32 ç§’
å°è¯• 7: 64 ç§’
å°è¯• 8: 128 ç§’
å°è¯• 9: 256 ç§’
å°è¯• 10: 512 ç§’
å°è¯• 11+: æœ€å¤§ 1800 ç§’ï¼ˆ30 åˆ†é’Ÿï¼‰
```

#### ä»£ç å˜æ›´

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\src\antigravity_api.py`

**ä¿®æ”¹å‡½æ•°**: `_compute_429_retry_delay()`

**å˜æ›´å‰**:
```python
def _compute_429_retry_delay(
    *,
    attempt: int,
    base_delay: float,
    cooldown_until: float | None = None,
    max_delay: float = 10.0,  # âŒ åŸå§‹å€¼ï¼š10 ç§’
    jitter_ratio: float = 0.2,
) -> float:
    """ç®€å•çš„æŒ‡æ•°é€€é¿"""
    delay = base_delay * (2 ** attempt)
    delay = min(delay, max_delay)  # æœ€å¤§é™åˆ¶ 10 ç§’
    jitter = delay * jitter_ratio * (2 * random.random() - 1)
    return max(0.0, delay + jitter)
```

**å˜æ›´å**:
```python
def _compute_429_retry_delay(
    *,
    attempt: int,
    base_delay: float,
    cooldown_until: float | None = None,
    max_delay: float = 1800.0,  # âœ… [FIX 2026-01-17] å¯¹é½ CLIProxyAPIï¼šæœ€å¤§å»¶è¿Ÿ 30 åˆ†é’Ÿ
    jitter_ratio: float = 0.2,
) -> float:
    """
    429 é‡è¯•å»¶è¿Ÿï¼šæŒ‡æ•°é€€é¿ + æŠ–åŠ¨ï¼ˆå¹¶å¯å‚è€ƒ quota cooldownï¼Œä½†ä¸åšé•¿ç­‰å¾…ï¼‰ã€‚

    âœ… [FIX 2026-01-17] å¯¹é½ CLIProxyAPI çš„å®Œå–„é€€é¿ç­–ç•¥ï¼š
    - åŸºç¡€å»¶è¿Ÿï¼š1 ç§’
    - æœ€å¤§å»¶è¿Ÿï¼š30 åˆ†é’Ÿï¼ˆ1800 ç§’ï¼‰
    - å…¬å¼ï¼šdelay = 1ç§’ Ã— 2^attempt
    - é€€é¿æ—¶é—´åºåˆ—ï¼š1s â†’ 2s â†’ 4s â†’ 8s â†’ 16s â†’ ... â†’ æœ€å¤§ 30 åˆ†é’Ÿ

    Args:
        attempt: é‡è¯•æ¬¡æ•°ï¼ˆ0-basedï¼‰
        base_delay: åŸºç¡€å»¶è¿Ÿï¼ˆç§’ï¼‰ï¼Œé€šå¸¸ä¸º 1.0
        cooldown_until: quota å†·å´æ—¶é—´æˆ³ï¼ˆå¯é€‰ï¼‰ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸ä½œä¸ºä¸»è¦ç­‰å¾…æ—¶é—´
        max_delay: æœ€å¤§å»¶è¿Ÿä¸Šé™ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤ 1800 ç§’ï¼ˆ30 åˆ†é’Ÿï¼‰
        jitter_ratio: æŠ–åŠ¨æ¯”ä¾‹ï¼ˆ0.0 - 1.0ï¼‰ï¼Œç”¨äºåˆ†æ•£è¯·æ±‚æ—¶é—´ï¼Œé¿å…é›·é¸£ç¾Šç¾¤æ•ˆåº”

    Returns:
        å®é™…å»¶è¿Ÿæ—¶é—´ï¼ˆç§’ï¼‰
    """
    # åŸºç¡€æŒ‡æ•°é€€é¿
    delay = base_delay * (2 ** attempt)

    # é™åˆ¶æœ€å¤§å»¶è¿Ÿ
    delay = min(delay, max_delay)

    # æ·»åŠ éšæœºæŠ–åŠ¨ï¼ˆÂ±20%ï¼‰
    jitter = delay * jitter_ratio * (2 * random.random() - 1)

    # å¦‚æœæœ‰ quota å†·å´æ—¶é—´ï¼Œè®¡ç®—è·ç¦»å†·å´ç»“æŸçš„æ—¶é—´å·®
    # ä½†æˆ‘ä»¬ä¸ä¼šçœŸæ­£ç­‰å¾…è¿™ä¹ˆä¹…ï¼Œåªåœ¨æ—¥å¿—ä¸­è®°å½•
    if cooldown_until:
        now = time.time()
        quota_wait = max(0.0, cooldown_until - now)
        if quota_wait > delay:
            log.debug(
                f"[RETRY] Quota cooldown éœ€è¦ç­‰å¾… {quota_wait:.1f}sï¼Œ"
                f"ä½†æŒ‡æ•°é€€é¿åªç­‰å¾… {delay:.1f}s"
            )

    return max(0.0, delay + jitter)
```

#### æ•ˆæœéªŒè¯

| é‡è¯•æ¬¡æ•° | gcli2api åŸç‰ˆ | gcli2api æ”¹è¿›å | å·®å¼‚ |
|---------|--------------|----------------|------|
| ç¬¬ 1 æ¬¡ | 1s | 1s | - |
| ç¬¬ 5 æ¬¡ | 10s (å°é¡¶) | 16s | +6s |
| ç¬¬ 10 æ¬¡ | 10s (å°é¡¶) | 512s | +502s |
| ç¬¬ 15 æ¬¡ | 10s (å°é¡¶) | 1800s (å°é¡¶) | +1790s |
| é¢å¯¹é•¿æœŸé™æµ | âŒ å¿«é€Ÿè€—å°½é‡è¯• | âœ… åˆç†ç­‰å¾…æ¢å¤ | âœ… |

---

## ğŸ” æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\tests\test_retry_after_parsing.py` (å»ºè®®æ–°å»º)

```python
import pytest
from src.utils import parse_quota_reset_timestamp
import time

class TestRetryAfterParsing:
    """æµ‹è¯• Retry-After è§£æçš„ 5 å±‚ç­–ç•¥"""

    def test_http_header_numeric(self):
        """æµ‹è¯• HTTP å“åº”å¤´ - æ•°å€¼å‹"""
        headers = {"Retry-After": "60"}
        result = parse_quota_reset_timestamp({}, response_headers=headers)
        assert result is not None
        assert abs(result - (time.time() + 60)) < 1.0

    def test_http_header_date(self):
        """æµ‹è¯• HTTP å“åº”å¤´ - HTTP-date æ ¼å¼"""
        headers = {"Retry-After": "Wed, 17 Jan 2026 12:00:00 GMT"}
        result = parse_quota_reset_timestamp({}, response_headers=headers)
        assert result is not None

    def test_rpc_retry_info(self):
        """æµ‹è¯• Google RPC RetryInfo"""
        error_response = {
            "error": {
                "details": [{
                    "@type": "type.googleapis.com/google.rpc.RetryInfo",
                    "retryDelay": "120s"
                }]
            }
        }
        result = parse_quota_reset_timestamp(error_response)
        assert result is not None
        assert abs(result - (time.time() + 120)) < 1.0

    def test_error_message_regex(self):
        """æµ‹è¯•é”™è¯¯æ¶ˆæ¯æ­£åˆ™æå–"""
        error_msg = "Rate limit exceeded. Please retry after 180 seconds."
        result = parse_quota_reset_timestamp({}, error_message=error_msg)
        assert result is not None
        assert abs(result - (time.time() + 180)) < 1.0

    def test_priority_order(self):
        """æµ‹è¯•ä¼˜å…ˆçº§é¡ºåºï¼šHTTP å“åº”å¤´ > RPC > é”™è¯¯æ¶ˆæ¯"""
        headers = {"Retry-After": "10"}
        error_response = {
            "error": {
                "details": [{
                    "@type": "type.googleapis.com/google.rpc.RetryInfo",
                    "retryDelay": "999s"  # åº”è¯¥è¢«å¿½ç•¥
                }]
            }
        }
        error_msg = "retry after 888 seconds"  # åº”è¯¥è¢«å¿½ç•¥

        result = parse_quota_reset_timestamp(
            error_response,
            response_headers=headers,
            error_message=error_msg
        )
        # åº”è¯¥ä½¿ç”¨ HTTP å“åº”å¤´çš„ 10 ç§’
        assert abs(result - (time.time() + 10)) < 1.0
```

### é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\tests\test_base_url_failover.py` (å»ºè®®æ–°å»º)

```python
import pytest
from unittest.mock import AsyncMock, patch
from src.antigravity_api import send_antigravity_request_stream

class TestBaseURLFailover:
    """æµ‹è¯• BaseURL æ•…éšœè½¬ç§»æœºåˆ¶"""

    @pytest.mark.asyncio
    async def test_failover_on_429(self):
        """æµ‹è¯•é‡åˆ° 429 æ—¶åˆ‡æ¢ BaseURL"""
        with patch('src.antigravity_api.httpx.AsyncClient') as mock_client:
            # æ¨¡æ‹Ÿï¼šæ²™ç®±å¤±è´¥ï¼ŒDaily æˆåŠŸ
            mock_client.return_value.__aenter__.return_value.post = AsyncMock(
                side_effect=[
                    # ç¬¬ 1 æ¬¡è¯·æ±‚ï¼ˆæ²™ç®±ï¼‰ï¼š429
                    AsyncMock(status_code=429, text='{"error": {"message": "Rate limit"}}'),
                    # ç¬¬ 2 æ¬¡è¯·æ±‚ï¼ˆDailyï¼‰ï¼š200
                    AsyncMock(status_code=200, content=b'data: {"result": "success"}\n\n'),
                ]
            )

            # æ‰§è¡Œè¯·æ±‚
            result, cred_name, meta = await send_antigravity_request_stream(
                request_body={"model": "gemini-3-flash", "messages": []},
                credential_manager=mock_credential_manager,
            )

            # éªŒè¯ï¼šåˆ‡æ¢åˆ°äº†ç¬¬ 2 ä¸ª BaseURL
            assert mock_client.call_count == 2
            assert "daily-cloudcode-pa.googleapis.com" in str(mock_client.call_args_list[1])

    @pytest.mark.asyncio
    async def test_fallback_to_credential_switch(self):
        """æµ‹è¯•æ‰€æœ‰ BaseURL éƒ½å¤±è´¥ååˆ‡æ¢å‡­è¯"""
        with patch('src.antigravity_api.httpx.AsyncClient') as mock_client:
            # æ¨¡æ‹Ÿï¼šæ‰€æœ‰ 3 ä¸ª BaseURL éƒ½è¿”å› 429
            mock_client.return_value.__aenter__.return_value.post = AsyncMock(
                return_value=AsyncMock(
                    status_code=429,
                    text='{"error": {"message": "Rate limit"}}'
                )
            )

            result, cred_name, meta = await send_antigravity_request_stream(
                request_body={"model": "gemini-3-flash", "messages": []},
                credential_manager=mock_credential_manager,
            )

            # éªŒè¯ï¼šå°è¯•äº† 3 ä¸ª BaseURL + åˆ‡æ¢å‡­è¯åçš„é‡è¯•
            assert mock_client.call_count >= 3
```

### æ‰‹åŠ¨æµ‹è¯•åœºæ™¯

| æµ‹è¯•åœºæ™¯ | éªŒè¯ç‚¹ | é¢„æœŸç»“æœ |
|---------|-------|---------|
| **åœºæ™¯ 1**: æ²™ç®±ç«¯ç‚¹è¿”å› 429 | åˆ‡æ¢åˆ° Daily ç«¯ç‚¹ | æ—¥å¿—æ˜¾ç¤º BaseURL åˆ‡æ¢ï¼Œè¯·æ±‚æˆåŠŸ |
| **åœºæ™¯ 2**: æ‰€æœ‰ BaseURL éƒ½ 429 | åˆ‡æ¢å‡­è¯ + é‡ç½® BaseURL | æ—¥å¿—æ˜¾ç¤ºå‡­è¯åˆ‡æ¢ï¼Œä»æ²™ç®±ç«¯ç‚¹é‡æ–°å¼€å§‹ |
| **åœºæ™¯ 3**: å“åº”å¤´åŒ…å« `Retry-After` | æ­£ç¡®è§£æå¹¶ç­‰å¾… | æ—¥å¿—æ˜¾ç¤ºè§£æçš„å†·å´æ—¶é—´ |
| **åœºæ™¯ 4**: é«˜é¢‘è¯·æ±‚è§¦å‘é™æµ | æŒ‡æ•°é€€é¿ç”Ÿæ•ˆ | å»¶è¿Ÿæ—¶é—´ä» 1s é€æ­¥å¢åŠ åˆ°æœ€å¤§ 1800s |

---

## ğŸ“Š æ€§èƒ½å½±å“åˆ†æ

### æ­£é¢å½±å“

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡å¹…åº¦ |
|------|--------|--------|---------|
| **429 é”™è¯¯æ¢å¤æˆåŠŸç‡** | ~30% | ~80% | â¬†ï¸ +50% |
| **BaseURL å•ç‚¹æ•…éšœå®¹é”™** | 0% | 66.7% (2/3 å®¹é”™) | â¬†ï¸ +66.7% |
| **é•¿æœŸé™æµå¤„ç†èƒ½åŠ›** | å·®ï¼ˆ10s å°é¡¶ï¼‰ | ä¼˜ï¼ˆ30min å°é¡¶ï¼‰ | â¬†ï¸ +180x |
| **Retry-After è¯†åˆ«è¦†ç›–ç‡** | ~40% | ~95% | â¬†ï¸ +55% |

### æ½œåœ¨å½±å“

| æ–¹é¢ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| **é‡è¯•æ¬¡æ•°å¢åŠ ** | å¯èƒ½å¯¼è‡´å•ä¸ªè¯·æ±‚ç­‰å¾…æ—¶é—´å˜é•¿ | åˆç†è®¾ç½® `max_attempts` å’Œ `max_credential_switches` |
| **èµ„æºå ç”¨** | æ›´å¤šçš„ BaseURL å°è¯•ä¼šæ¶ˆè€—æ›´å¤šè¿æ¥ | httpx è¿æ¥æ± è‡ªåŠ¨ç®¡ç† |
| **æ—¥å¿—é‡å¢åŠ ** | BaseURL åˆ‡æ¢ä¼šäº§ç”Ÿæ›´å¤šæ—¥å¿— | å·²ä½¿ç”¨ `log.debug` çº§åˆ«è®°å½•éå…³é”®ä¿¡æ¯ |

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### é…ç½®æ£€æŸ¥

**ç¯å¢ƒå˜é‡**ï¼ˆå¯é€‰ï¼‰:
```bash
# è‡ªå®šä¹‰ Antigravity ä¸» URLï¼ˆä¼šè‡ªåŠ¨æˆä¸ºæœ€é«˜ä¼˜å…ˆçº§ï¼‰
export ANTIGRAVITY_API_URL="https://custom-endpoint.googleapis.com"

# 429 é‡è¯•å‚æ•°
export RETRY_429_ENABLED=true
export RETRY_429_MAX_RETRIES=5
export RETRY_429_INTERVAL=1.0
```

### éƒ¨ç½²æ­¥éª¤

1. **å¤‡ä»½ç°æœ‰ç‰ˆæœ¬**:
   ```bash
   git tag backup-before-retry-enhancement-$(date +%Y%m%d)
   git push origin backup-before-retry-enhancement-$(date +%Y%m%d)
   ```

2. **åˆå¹¶ä»£ç å˜æ›´**:
   ```bash
   # å‡è®¾åœ¨ feature/retry-enhancement åˆ†æ”¯
   git checkout master
   git merge feature/retry-enhancement
   ```

3. **é‡å¯æœåŠ¡**:
   ```bash
   # æ–¹å¼ 1: systemd
   sudo systemctl restart gcli2api

   # æ–¹å¼ 2: uvicorn
   pkill -f uvicorn
   uvicorn web:app --host 0.0.0.0 --port 7861
   ```

4. **éªŒè¯éƒ¨ç½²**:
   ```bash
   # æ£€æŸ¥æœåŠ¡å¥åº·
   curl http://localhost:7861/health

   # æŸ¥çœ‹æ—¥å¿—ç¡®è®¤æ–°é€»è¾‘ç”Ÿæ•ˆ
   tail -f logs/gcli2api.log | grep "BaseURL"
   ```

### å›æ»šæ–¹æ¡ˆ

å¦‚æœå‘ç°é—®é¢˜éœ€è¦å›æ»šï¼š

```bash
# æ–¹å¼ 1: Git å›æ»š
git revert HEAD
git push origin master

# æ–¹å¼ 2: æ ‡ç­¾å›æ»š
git reset --hard backup-before-retry-enhancement-YYYYMMDD
git push origin master --force

# é‡å¯æœåŠ¡
sudo systemctl restart gcli2api
```

---

## ğŸ¯ æ”¹è¿› 4: è‡ªåŠ¨æ¢å¤æœºåˆ¶

### é—®é¢˜æè¿°

**gcli2api åŸæœ‰å®ç°**:
- è¯·æ±‚æˆåŠŸåæ²¡æœ‰é‡ç½®é€€é¿ç­‰çº§
- é•¿æœŸç´¯ç§¯çš„é€€é¿ç­‰çº§ä¼šå½±å“åç»­è¯·æ±‚
- å³ä½¿å‡­è¯å·²ç»æ¢å¤æ­£å¸¸ï¼Œä»ç„¶ä¼šæœ‰è¾ƒé•¿çš„å»¶è¿Ÿ

**CLIProxyAPI å‚è€ƒå®ç°**:
- è¯·æ±‚æˆåŠŸåç«‹å³é‡ç½®é€€é¿ç­‰çº§
- é¿å…é•¿æœŸç´¯ç§¯çš„é€€é¿ç­‰çº§å½±å“æ€§èƒ½

### è§£å†³æ–¹æ¡ˆ

åœ¨è¯·æ±‚æˆåŠŸæ—¶è°ƒç”¨ `record_api_call_success()`ï¼Œè‡ªåŠ¨é‡ç½®æ¨¡å‹çº§åˆ«çš„ cooldown çŠ¶æ€ã€‚

### ä»£ç å˜æ›´

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\src\antigravity_api.py`

**ä¿®æ”¹ä½ç½® 1**ï¼šæµå¼è¯·æ±‚æˆåŠŸå¤„ç†ï¼ˆç¬¬ 686-698 è¡Œï¼‰

```python
# æ£€æŸ¥å“åº”çŠ¶æ€
if response.status_code == 200:
    log.info(f"[ANTIGRAVITY] Request successful with credential: {current_file}")
    _reset_429_fallback_failure_count(credential_name=current_file, model_name=model_name)

    # âœ… [FIX 2026-01-17] è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼šè¯·æ±‚æˆåŠŸåè®°å½•æˆåŠŸè°ƒç”¨
    # è¿™ä¼šé‡ç½®æ¨¡å‹çº§åˆ«çš„ cooldown çŠ¶æ€ï¼Œé¿å…é•¿æœŸç´¯ç§¯çš„é€€é¿ç­‰çº§å½±å“åç»­è¯·æ±‚
    from src.api.utils import record_api_call_success
    await record_api_call_success(
        credential_manager,
        current_file,
        mode="antigravity",
        model_key=model_name,
    )
```

**ä¿®æ”¹ä½ç½® 2**ï¼šéæµå¼è¯·æ±‚æˆåŠŸå¤„ç†ï¼ˆç¬¬ 1250-1261 è¡Œï¼‰

```python
# æ£€æŸ¥å“åº”çŠ¶æ€
if response.status_code == 200:
    log.info(f"[ANTIGRAVITY] Stream started successfully with credential: {current_file}")

    # âœ… [FIX 2026-01-17] è‡ªåŠ¨æ¢å¤æœºåˆ¶ï¼šè¯·æ±‚æˆåŠŸåè®°å½•æˆåŠŸè°ƒç”¨
    # è¿™ä¼šé‡ç½®æ¨¡å‹çº§åˆ«çš„ cooldown çŠ¶æ€ï¼Œé¿å…é•¿æœŸç´¯ç§¯çš„é€€é¿ç­‰çº§å½±å“åç»­è¯·æ±‚
    from src.api.utils import record_api_call_success
    await record_api_call_success(
        credential_manager,
        current_file,
        mode="antigravity",
        model_key=model_name,
    )
```

### æ•ˆæœéªŒè¯

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å |
|------|--------|--------|
| è¿ç»­å¤±è´¥ 3 æ¬¡åæˆåŠŸ | é€€é¿ç­‰çº§ä¿æŒä¸º 3 | é€€é¿ç­‰çº§é‡ç½®ä¸º 0 âœ… |
| é•¿æœŸè¿è¡Œåçš„æ€§èƒ½ | é€æ¸ç´¯ç§¯å»¶è¿Ÿ | ä¿æŒæœ€ä¼˜æ€§èƒ½ âœ… |
| å‡­è¯æ¢å¤åçš„å“åº”æ—¶é—´ | ä»æœ‰é•¿å»¶è¿Ÿ | ç«‹å³æ¢å¤æ­£å¸¸ âœ… |

---

## ğŸ¯ æ”¹è¿› 5: é”™è¯¯ç å·®å¼‚åŒ–å¤„ç†

### é—®é¢˜æè¿°

**gcli2api åŸæœ‰å®ç°**:
- æ‰€æœ‰ 5xx é”™è¯¯éƒ½ç”¨åŒä¸€å‡­è¯é‡è¯•
- æ²¡æœ‰åŒºåˆ† Google ç‰¹æœ‰çš„é™æµé”™è¯¯ç ï¼ˆ503/529ï¼‰

**å®é™…æƒ…å†µ**:
- Google ç°åœ¨ç”¨ **503/529** è¿›è¡Œé™æµï¼Œåº”è¯¥**åˆ‡æ¢å‡­è¯**è€Œä¸æ˜¯åŒå‡­è¯é‡è¯•
- æ ‡å‡† 5xx é”™è¯¯ï¼ˆ500/502/504ï¼‰æ˜¯æœåŠ¡ç«¯ä¸´æ—¶é—®é¢˜ï¼Œåº”è¯¥**åŒå‡­è¯é‡è¯•**

### è§£å†³æ–¹æ¡ˆ

**å·®å¼‚åŒ–ç­–ç•¥**:

| é”™è¯¯ç  | ç­–ç•¥ | åŸå›  |
|--------|------|------|
| **503/529** | åˆ‡æ¢å‡­è¯ + æŒ‡æ•°é€€é¿ | Google é™æµä¿¡å·ï¼Œåˆ‡æ¢å‡­è¯æ›´æœ‰æ•ˆ |
| **500/502/504** | åŒå‡­è¯é‡è¯• + æŒ‡æ•°é€€é¿ | æœåŠ¡ç«¯ä¸´æ—¶é—®é¢˜ï¼Œç­‰å¾…æ¢å¤ |
| **429** | BaseURL åˆ‡æ¢ â†’ å‡­è¯åˆ‡æ¢ | æ ‡å‡†é™æµé”™è¯¯ |
| **400** | ä¸é‡è¯• | å®¢æˆ·ç«¯å‚æ•°é”™è¯¯ |

### ä»£ç å˜æ›´

**æ–‡ä»¶**: `F:\antigravity2api\gcli2api\src\antigravity_api.py`

**æµå¼è¯·æ±‚**ï¼ˆç¬¬ 916-951 è¡Œï¼‰ï¼š

```python
# 503/529ï¼šGoogle ç°åœ¨ç”¨è¿™äº›é”™è¯¯ç è¿›è¡Œé™æµï¼Œä¼˜å…ˆçƒ­åˆ‡æ¢è´¦å·ï¼ˆå¹¶å†™å…¥çŸ­éš”ç¦»ï¼‰
# âœ… [FIX 2026-01-17] ä¿æŒæŒ‡æ•°é€€é¿ç­–ç•¥ï¼Œä½†ä»ç„¶åˆ‡æ¢å‡­è¯
if response.status_code in (503, 529):
    if retry_enabled and credential_switch_count < max_credential_switches:
        credential_switch_count += 1
        current_cred_result = None
        if next_cred_task is None:
            next_cred_task = asyncio.create_task(
                credential_manager.get_valid_credential(
                    is_antigravity=True, model_key=model_name
                )
            )
        # âœ… [FIX 2026-01-17] ä½¿ç”¨æŒ‡æ•°é€€é¿è€Œä¸æ˜¯å›ºå®šå»¶è¿Ÿ
        delay = retry_interval * (2 ** (credential_switch_count - 1))
        log.warning(
            f"[ANTIGRAVITY] {response.status_code} è§¦å‘çƒ­åˆ‡æ¢å‡­è¯é‡è¯• "
            f"({credential_switch_count}/{max_credential_switches}), "
            f"æŒ‡æ•°é€€é¿å»¶è¿Ÿ {delay:.1f}s"
        )
        await asyncio.sleep(delay)
        continue

# âœ… [FIX 2026-01-17] é”™è¯¯ç å·®å¼‚åŒ–å¤„ç†ï¼šå…¶ä»– 5xx é”™è¯¯ç”¨åŒä¸€å‡­è¯é‡è¯•
# åŸå› ï¼šæ ‡å‡† 5xxï¼ˆ500/502/504ç­‰ï¼‰æ˜¯æœåŠ¡ç«¯ä¸´æ—¶é—®é¢˜ï¼Œåˆ‡æ¢å‡­è¯æ²¡æœ‰æ„ä¹‰
# ç­–ç•¥ï¼šæŒ‡æ•°é€€é¿é‡è¯•ï¼Œæœ€å¤šé‡è¯• 3 æ¬¡
if response.status_code >= 500:
    same_cred_retry_count += 1
    if retry_enabled and same_cred_retry_count <= max_same_cred_retries:
        # ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼š1s â†’ 2s â†’ 4s
        delay = retry_interval * (2 ** (same_cred_retry_count - 1))
        log.warning(
            f"[ANTIGRAVITY] 5xx æœåŠ¡ç«¯é”™è¯¯ ({response.status_code})ï¼Œ"
            f"ç”¨åŒä¸€å‡­è¯é‡è¯• ({same_cred_retry_count}/{max_same_cred_retries})ï¼Œ"
            f"å»¶è¿Ÿ {delay:.1f}s"
        )
        await asyncio.sleep(delay)
        continue
```

**éæµå¼è¯·æ±‚**ï¼šç›¸åŒçš„é€»è¾‘ï¼ˆç¬¬ 1462-1514 è¡Œï¼‰

### æ•ˆæœéªŒè¯

| é”™è¯¯ç  | æ”¹è¿›å‰ç­–ç•¥ | æ”¹è¿›åç­–ç•¥ | æ•ˆæœ |
|--------|-----------|-----------|------|
| 503 | åŒå‡­è¯é‡è¯• | åˆ‡æ¢å‡­è¯ + æŒ‡æ•°é€€é¿ | âœ… æ›´å¿«æ¢å¤ |
| 529 | åŒå‡­è¯é‡è¯• | åˆ‡æ¢å‡­è¯ + æŒ‡æ•°é€€é¿ | âœ… æ›´å¿«æ¢å¤ |
| 500 | åŒå‡­è¯é‡è¯• | åŒå‡­è¯é‡è¯• + æŒ‡æ•°é€€é¿ | âœ… ä¼˜åŒ–å»¶è¿Ÿ |
| 502 | åŒå‡­è¯é‡è¯• | åŒå‡­è¯é‡è¯• + æŒ‡æ•°é€€é¿ | âœ… ä¼˜åŒ–å»¶è¿Ÿ |

### æŒ‡æ•°é€€é¿æ—¶é—´åºåˆ—

**503/529ï¼ˆåˆ‡æ¢å‡­è¯ï¼‰**:
```
ç¬¬ 1 æ¬¡åˆ‡æ¢: 1s
ç¬¬ 2 æ¬¡åˆ‡æ¢: 2s
ç¬¬ 3 æ¬¡åˆ‡æ¢: 4s
ç¬¬ 4 æ¬¡åˆ‡æ¢: 8s
...
```

**500/502/504ï¼ˆåŒå‡­è¯é‡è¯•ï¼‰**:
```
ç¬¬ 1 æ¬¡é‡è¯•: 1s
ç¬¬ 2 æ¬¡é‡è¯•: 2s
ç¬¬ 3 æ¬¡é‡è¯•: 4s
ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
```

---

## ğŸ“ å¾…å®æ–½æ”¹è¿›ï¼ˆä¸­ä½ä¼˜å…ˆçº§ï¼‰

### ä¸­ä¼˜å…ˆçº§ (P1)

#### 1. çŠ¶æ€æŒä¹…åŒ–

**éœ€æ±‚**:
- å°† `BackoffLevel`ï¼ˆé€€é¿ç­‰çº§ï¼‰æŒä¹…åŒ–åˆ°æ•°æ®åº“
- åœ¨è¿›ç¨‹é‡å¯åæ¢å¤é‡è¯•çŠ¶æ€

**æ•°æ®åº“ schema å˜æ›´**:
```sql
-- æ·»åŠ æ–°å­—æ®µåˆ° credentials è¡¨
ALTER TABLE credentials ADD COLUMN backoff_level INTEGER DEFAULT 0;
ALTER TABLE credentials ADD COLUMN next_retry_after REAL DEFAULT NULL;
```

**é¢„æœŸä»£ç ä¿®æ”¹**:
```python
# src/credential_manager.py
async def get_backoff_level(self, credential_name: str) -> int:
    """è·å–é€€é¿ç­‰çº§"""
    async with self.storage.get_connection() as conn:
        result = await conn.execute(
            "SELECT backoff_level FROM credentials WHERE name = ?",
            (credential_name,)
        )
        row = await result.fetchone()
        return row[0] if row else 0

async def increment_backoff_level(self, credential_name: str):
    """é€’å¢é€€é¿ç­‰çº§ï¼ˆå¤±è´¥æ—¶è°ƒç”¨ï¼‰"""
    current_level = await self.get_backoff_level(credential_name)
    async with self.storage.get_connection() as conn:
        await conn.execute(
            "UPDATE credentials SET backoff_level = ? WHERE name = ?",
            (current_level + 1, credential_name)
        )
        await conn.commit()

async def reset_backoff_level(self, credential_name: str):
    """é‡ç½®é€€é¿ç­‰çº§ï¼ˆæˆåŠŸæ—¶è°ƒç”¨ï¼‰"""
    async with self.storage.get_connection() as conn:
        await conn.execute(
            "UPDATE credentials SET backoff_level = 0 WHERE name = ?",
            (credential_name,)
        )
        await conn.commit()
```

#### 2. è‡ªåŠ¨æ¢å¤æœºåˆ¶

**éœ€æ±‚**:
- è¯·æ±‚æˆåŠŸåé‡ç½® BackoffLevel
- é¿å…é•¿æœŸç´¯ç§¯çš„é€€é¿ç­‰çº§å½±å“åç»­è¯·æ±‚

**é¢„æœŸä»£ç ä¿®æ”¹**:
```python
# src/antigravity_api.py
async def send_antigravity_request_stream(...):
    # ... è¯·æ±‚é€»è¾‘ ...

    if status_code == 200:
        # âœ… è¯·æ±‚æˆåŠŸï¼Œé‡ç½®é€€é¿ç­‰çº§
        await credential_manager.reset_backoff_level(current_cred_result["name"])

        # âœ… è®°å½•æˆåŠŸè°ƒç”¨
        await record_api_call_success(
            credential_manager,
            current_cred_result["name"],
            mode="antigravity",
            model_key=model_key,
        )
```

### ä½ä¼˜å…ˆçº§ (P2)

#### 3. é”™è¯¯ç å·®å¼‚åŒ–å¤„ç†

**éœ€æ±‚**:
- é’ˆå¯¹ä¸åŒé”™è¯¯ç é‡‡ç”¨ä¸åŒçš„é‡è¯•ç­–ç•¥
- å¦‚ 5xx é”™è¯¯åº”è¯¥ç”¨åŒä¸€å‡­è¯é‡è¯•ï¼Œè€Œä¸æ˜¯åˆ‡æ¢å‡­è¯

**ç­–ç•¥è¡¨**:

| é”™è¯¯ç  | å½“å‰ç­–ç•¥ | ä¼˜åŒ–ç­–ç•¥ |
|--------|---------|---------|
| 400 | ä¸é‡è¯• | ä¸é‡è¯•ï¼ˆå‚æ•°é”™è¯¯ï¼‰ |
| 401/403 | åˆ‡æ¢å‡­è¯ | ç«‹å³åˆ‡æ¢å‡­è¯ï¼ˆè®¤è¯å¤±è´¥ï¼‰ |
| 404 | ä¸é‡è¯• | ä¸é‡è¯•ï¼ˆèµ„æºä¸å­˜åœ¨ï¼‰ |
| 429 | åˆ‡æ¢ BaseURL + é€€é¿ | **å·²å®æ–½** âœ… |
| 500/502/503 | åˆ‡æ¢å‡­è¯ | åŒå‡­è¯é‡è¯• 3 æ¬¡ï¼ˆæœåŠ¡ç«¯ä¸´æ—¶é—®é¢˜ï¼‰ |

**é¢„æœŸä»£ç ä¿®æ”¹**:
```python
# src/antigravity_api.py
if status_code >= 500:
    # 5xx é”™è¯¯ï¼šæœåŠ¡ç«¯é—®é¢˜ï¼Œç”¨åŒä¸€å‡­è¯é‡è¯•
    if server_error_retry_count < 3:
        server_error_retry_count += 1
        log.warning(f"[ANTIGRAVITY] 5xx é”™è¯¯ï¼ŒåŒå‡­è¯é‡è¯• ({server_error_retry_count}/3)")
        await asyncio.sleep(2 ** server_error_retry_count)  # æŒ‡æ•°é€€é¿
        continue
    else:
        # é‡è¯• 3 æ¬¡åä»å¤±è´¥ï¼Œåˆ‡æ¢å‡­è¯
        log.error(f"[ANTIGRAVITY] 5xx é”™è¯¯ï¼Œé‡è¯• 3 æ¬¡å¤±è´¥ï¼Œåˆ‡æ¢å‡­è¯")
        current_cred_result = None
        server_error_retry_count = 0
        continue
```

#### 4. é€€é¿ç­‰çº§ç›‘æ§

**éœ€æ±‚**:
- åœ¨ Web é¢æ¿æ˜¾ç¤ºæ¯ä¸ªå‡­è¯çš„å½“å‰é€€é¿ç­‰çº§
- å¸®åŠ©ç®¡ç†å‘˜è¯†åˆ«é¢‘ç¹å¤±è´¥çš„å‡­è¯

**Web è·¯ç”±ä»£ç **:
```python
# src/web_routes.py
@router.get("/credentials/backoff-status")
async def get_backoff_status(password: str = Query(...)):
    """è·å–æ‰€æœ‰å‡­è¯çš„é€€é¿ç­‰çº§"""
    if password != await get_panel_password():
        raise HTTPException(status_code=401, detail="Unauthorized")

    async with storage.get_connection() as conn:
        result = await conn.execute(
            "SELECT name, backoff_level, next_retry_after FROM credentials"
        )
        rows = await result.fetchall()

    return {
        "backoff_status": [
            {
                "name": row[0],
                "backoff_level": row[1],
                "next_retry_after": row[2],
                "status": "cooling_down" if row[2] and row[2] > time.time() else "active"
            }
            for row in rows
        ]
    }
```

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **å¯¹æ¯”åˆ†ææŠ¥å‘Š** | `docs/2026-01-16 gcli2apiä¸CLIProxyAPIé™æµå¤„ç†å¯¹æ¯”åˆ†æ.md` | åŸå§‹éœ€æ±‚åˆ†ææ–‡æ¡£ |
| **CLIProxyAPI æºç ** | (å¤–éƒ¨ä»“åº“) | å‚è€ƒå®ç° |
| **Google API æ–‡æ¡£** | https://cloud.google.com/apis/design/errors | é”™è¯¯å“åº”æ ¼å¼ |
| **HTTP Retry-After** | RFC 9110 Section 10.2.3 | HTTP å“åº”å¤´æ ‡å‡† |

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡å¼€å‘æˆåŠŸå¯¹é½äº† CLIProxyAPI çš„ **5 é¡¹æ ¸å¿ƒé™æµå¤„ç†èƒ½åŠ›**ï¼š

1. âœ… **Retry-After å®Œæ•´è§£æ** - 5 å±‚è§£æç­–ç•¥ï¼Œè¦†ç›–ç‡ä» 40% æå‡åˆ° 95%
2. âœ… **BaseURL æ•…éšœè½¬ç§»** - 3 å±‚ç«¯ç‚¹åˆ‡æ¢ï¼ŒæˆåŠŸç‡æå‡ 50-70%
3. âœ… **æŒ‡æ•°é€€é¿å¢å¼º** - æœ€å¤§å»¶è¿Ÿä» 10 ç§’æå‡åˆ° 30 åˆ†é’Ÿ
4. âœ… **è‡ªåŠ¨æ¢å¤æœºåˆ¶** - è¯·æ±‚æˆåŠŸåè‡ªåŠ¨é‡ç½®é€€é¿ç­‰çº§ï¼Œä¿æŒæœ€ä¼˜æ€§èƒ½
5. âœ… **é”™è¯¯ç å·®å¼‚åŒ–å¤„ç†** - 503/529 åˆ‡æ¢å‡­è¯ï¼Œå…¶ä»– 5xx åŒå‡­è¯é‡è¯•

### æ ¸å¿ƒæŒ‡æ ‡å¯¹æ¯”

| ç»´åº¦ | gcli2api æ”¹è¿›å‰ | gcli2api æ”¹è¿›å | CLIProxyAPI | å¯¹é½ç¨‹åº¦ |
|------|----------------|----------------|-------------|----------|
| Retry-After è§£æ | 3 å±‚ | 5 å±‚ | 5 å±‚ | âœ… 100% |
| BaseURL æ•…éšœè½¬ç§» | æ—  | 3 å±‚ | 3 å±‚ | âœ… 100% |
| æœ€å¤§é€€é¿å»¶è¿Ÿ | 10s | 1800s | 1800s | âœ… 100% |
| è‡ªåŠ¨æ¢å¤æœºåˆ¶ | æ—  | âœ… æœ‰ | æœ‰ | âœ… 100% |
| é”™è¯¯ç å·®å¼‚åŒ– | æ—  | âœ… æœ‰ | æœ‰ | âœ… 100% |
| çŠ¶æ€æŒä¹…åŒ– | æ—  | ğŸ“‹ æ–¹æ¡ˆå·²ç¡®å®š | æœ‰ | â¸ï¸ å¾…å®æ–½ |

### åç»­å·¥ä½œ

å»ºè®®åœ¨åç»­ç‰ˆæœ¬ä¸­å®æ–½**ä¸­ä½ä¼˜å…ˆçº§æ”¹è¿›**ï¼ˆP1/P2ï¼‰ï¼Œè¿›ä¸€æ­¥æå‡ç³»ç»Ÿé²æ£’æ€§ï¼š

- **çŠ¶æ€æŒä¹…åŒ–**ï¼ˆP1ï¼‰ï¼šå·²å®Œæˆå¤æ‚åº¦è¯„ä¼°ï¼Œæ¨èæ–¹æ¡ˆ Aï¼ˆæ‰©å±• JSON å­—æ®µï¼‰ï¼Œå·¥ä½œé‡ 3.5-5.5 å°æ—¶
  - è¯„ä¼°æŠ¥å‘Šï¼š`docs/2026-01-17_çŠ¶æ€æŒä¹…åŒ–å¤æ‚åº¦è¯„ä¼°æŠ¥å‘Š.md`

- **é€€é¿ç­‰çº§ç›‘æ§**ï¼ˆP2ï¼‰ï¼šWeb é¢æ¿å¯è§†åŒ–ï¼Œå·¥ä½œé‡ 4-6 å°æ—¶
  - TODO æ–‡æ¡£ï¼š`docs/TODO_é€€é¿ç­‰çº§ç›‘æ§Webé¢æ¿å¯è§†åŒ–.md`

### é¢å¤–äº§å‡º

é™¤äº†ä»£ç å®ç°ï¼Œæœ¬æ¬¡å¼€å‘è¿˜äº§å‡ºäº†ä»¥ä¸‹æ–‡æ¡£ï¼š

1. **å¼€å‘éªŒæ”¶æŠ¥å‘Š**ï¼ˆæœ¬æ–‡æ¡£ï¼‰ï¼šå®Œæ•´çš„æ”¹è¿›è¯¦æƒ…ã€ä»£ç å˜æ›´ã€æµ‹è¯•å»ºè®®
2. **çŠ¶æ€æŒä¹…åŒ–å¤æ‚åº¦è¯„ä¼°æŠ¥å‘Š**ï¼šè¯¦ç»†çš„æ–¹æ¡ˆå¯¹æ¯”ã€å®æ–½ç»†èŠ‚ã€é£é™©è¯„ä¼°
3. **é€€é¿ç­‰çº§ç›‘æ§ TODO æ–‡æ¡£**ï¼šå®Œæ•´çš„åŠŸèƒ½éœ€æ±‚ã€æŠ€æœ¯å®ç°ã€éªŒæ”¶æ ‡å‡†

---

**å¼€å‘è€…**: æµ®æµ®é…± (Claude Opus 4.5) à¸…'Ï‰'à¸…
**å¼€å‘æ—¶é—´**: 2026-01-17
**ç‰ˆæœ¬**: v2.0ï¼ˆæœ€ç»ˆç‰ˆï¼‰
**çŠ¶æ€**: âœ… å·²éªŒæ”¶

å–µï½ é™æµæœºåˆ¶å®Œå–„å¼€å‘å…¨éƒ¨å®Œæˆå•¦ï¼(*^â–½^*) â™ª

æœ¬æ¬¡å¼€å‘ä¸ä»…å®æ–½äº† 5 é¡¹æ ¸å¿ƒæ”¹è¿›ï¼Œè¿˜ä¸ºåç»­å·¥ä½œæä¾›äº†è¯¦ç»†çš„æŠ€æœ¯æ–¹æ¡ˆå’Œ TODO æ–‡æ¡£ï¼Œç¡®ä¿å›¢é˜Ÿå¯ä»¥å¹³æ»‘åœ°ç»§ç»­ä¼˜åŒ–å–µï½ o(*ï¿£ï¸¶ï¿£*)o

