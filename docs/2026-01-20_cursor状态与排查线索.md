# 2026-01-20 Cursor 通过 gcli2api 网关无思考现状与排查线索

## 现状速记
- 场景：Cursor 命中旧网关 `src/unified_gateway_router.py` 的 `/gateway/v1/chat/completions`（别名 `/v1/chat/completions`）。`IDECompatMiddleware` 只拦截 `/antigravity/v1/messages` 和 `/v1/messages`，因此 Cursor 请求绕过了中间件。
- 回滚后症状：Cursor 已经“不会思考”（无 thinking 块输出），但请求仍走旧网关。
- 近期改动（已在工作区）：
  - `src/ide_compat/sanitizer.py`：历史 assistant 消息的 thinking blocks 直接删除，仅对最近 2 条 assistant 消息尝试签名恢复；失败则降级为 text。目的是避免历史签名失效导致 400。
  - `src/unified_gateway_router.py`：去掉“提取历史签名灌缓存”，仅扫描最新 assistant 消息的 thinking 签名传给 sanitizer，并据此决定 `thinking_enabled`。
- 工作区依然有大量改动（gateway 重构等）未清理，分支 `master...origin/official [ahead 24]`。

## 猜测可能原因（为何没有思考）
1) **thinking 被在入口层就判定为 false**  
   - `chat_completions` 中 `thinking_enabled = body.get("thinking") is not None`；若 Cursor 未带 `thinking` 配置，且历史消息被净化掉 thinking，则 `sanitize_messages` 可能返回 `final_thinking_enabled=False`，随即移除 `body["thinking"]`。
2) **历史净化导致“无思考可触发”**  
   - 如果最近 2 条 assistant 里也没有 thinking 块（或被降级为 text），sanitizer 会把 thinking 视为关闭，后续路由也不会请求带思考的模型。
3) **模型映射/路由未选用思考模型**  
   - 若请求的 `model` 未映射到 `claude-*-thinking` 或被路由到不支持思考的后端，thinking 自然不会返回。
4) **Header/开关禁用思考**  
   - 旧逻辑仍有 `x-disable-thinking-signature` 等开关；若被误触，可能关闭思考或签名处理。
5) **下游变换层丢弃 thinking**  
   - `message_converter.py` / `anthropic_streaming.py` 如有残留 strip/thoughtSignature 兼容问题，可能在下游把 thinking 剥离。

## 建议优先排查的对象与日志
1) **入口请求体与日志**  
   - 打印 `normalize_request_body` 结果和 `thinking` 字段；确认 `model`、`thinking` 是否被带入。  
   - 关键日志：`[SCID] Thinking blocks scan`、`[SANITIZER] Protected assistant message indices`、`[SANITIZER] 消息净化完成 ... thinking_enabled=...->...`
2) **sanitizer 结果**  
   - 检查最后 2 条 assistant 是否保留 thinking；确认是否被降级为 text。  
   - 如果 `final_thinking_enabled` 为 False，会删除 `body["thinking"]`。
3) **模型路由**  
   - 确认 `model` 是否命中思考模型直通或映射；避免落到不支持 thinking 的后端。
4) **下游转换/流式层**  
   - `src/converters/message_converter.py`、`src/anthropic_streaming.py` 是否还存在 strip/签名兼容路径会移除 thinking。
5) **开关/Header**  
   - 检查是否有 `x-disable-thinking-signature`、`x-signature-*` 等被带入请求。

## 快速复现脚本（手动）
```bash
curl -X POST http://127.0.0.1:7861/gateway/v1/chat/completions \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-3.5-sonnet",  // 如需思考，换成 claude-sonnet-4.5-thinking 或映射
    "stream": true,
    "thinking": {"budget_tokens": 1024},
    "messages": [
      {"role": "user", "content": "测试思考输出"}
    ]
  }'
```
观察返回是否含 `thinking` 块；配合日志确认 `thinking_enabled` 状态。

## 交接建议
- 保持现有代码不再改动，先用上述日志与 curl 复现，确认是“入口判断/净化关闭 thinking”还是“模型路由不支持”。
- 若确认需要保留历史少量 thinking，可把 sanitizer 的“保护数量”从 2 条提升为 4 条，但仍不要尝试恢复更早的签名。
