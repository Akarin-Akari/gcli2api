# 2026-01-12 上游同步完成报告

## 1. 概述
本次同步主要针对 upstream `su-kaka/gcli2api` 的关键修复和功能增强，同时保留了本地特有的 Auto-Stream Conversion 架构。

## 2. 变更详情

### 2.1 [Fix] 移除 `_clean_tools_for_gemini`
- **文件**: `src/gcli_chat_api.py`
- **原因**: 该函数会导致 Gemini MCP 工具调用陷入无限递归。
- **操作**: 彻底移除了该函数及其调用代码。

### 2.2 [Feat] 支持 `tool_choice`
- **文件**: `src/anthropic_converter.py`, `src/antigravity_api.py`
- **内容**: 
    - 实现了 `convert_tool_choice_to_tool_config` 函数。
    - 支持 Anthropic 的 `auto`, `any`, `tool` 模式映射到 Gemini 的 `toolConfig`。
    - 更新 `build_antigravity_request_body` 以接收和应用 `tool_config`。

### 2.3 [Feat] 确认 `count_tokens` 接口
- **文件**: `src/antigravity_anthropic_router.py`
- **状态**: 经核查，该接口已存在于代码中，且与 `token_estimator.py` 的签名匹配 (`estimate_input_tokens(payload)`)。无需额外操作。

### 2.4 [Skip] 跳过重试逻辑同步
- **原因**: 本地 `antigravity_api.py` 已升级为支持 **Auto-Stream Conversion** 的高级重试逻辑（包含流式资源管理、跨池降级、MODEL_CAPACITY_EXHAUSTED 检测）。
- **决策**: 保留本地更优的实现，忽略上游针对旧版代码的 `DISABLE_ERROR_CODES` 修复。

## 3. 验证结果
- **代码静态检查**: 无语法错误。
- **接口一致性**: `count_tokens` 签名匹配。
- **功能完备性**: `tool_choice` 转换逻辑覆盖了所有标准模式。

## 4. 下一步
- 重启服务以应用更改。
- 监控 Gemini MCP 调用是否恢复正常。
