# 上下文截断问题三次修复报告

**日期**: 2026-01-12
**版本**: v1.5 (追加 tool_converter.py 下限保护修复)
**作者**: 浮浮酱 (Claude Opus 4.5)

---

## 1. 问题背景

### 1.1 历史修复回顾

在 2026-01-10 ~ 2026-01-12 期间，针对上下文截断问题进行了多次修复：

| 修复日期 | 问题 | 修复位置 | 状态 |
|----------|------|----------|------|
| 2026-01-10 | tiktoken 未安装 | .venv 环境 | ✅ 已修复 |
| 2026-01-10 | 安全边际过高 | context_truncation.py | ✅ 已修复 |
| 2026-01-11 | thinking=True 输出空间不足 | tool_converter.py | ✅ 已修复 |
| 2026-01-11 | thinking=False 无下限保护 | anthropic_converter.py | ❌ 无效！ |
| 2026-01-12 | max_tokens=None 缺少默认值 | anthropic_converter.py | ❌ 无效！ |

### 1.2 遗留问题

用户反馈：即使执行了所有修复，输出仍然被截断为 4096 tokens：

```
promptTokenCount: 81,690
candidatesTokenCount: 4,096
finishReason: MAX_TOKENS
日志: thinking=False, output=4,096 (没有出现我们添加的日志！)
```

**关键线索**：日志中没有出现 `maxOutputTokens 低于下限` 或 `max_tokens 未指定，使用默认值` 的日志。

---

## 2. 问题分析

### 2.1 深度调试过程

通过 Sequential Thinking 工具进行了至少 10 种可能性的分析：

1. ❌ 服务没重启 → 用户确认已重启
2. ❌ Python 缓存问题 → .pyc 不影响源码修改
3. ❌ 代码语法错误 → 脚本执行成功
4. ❌ 日志级别过滤 → log.info 应该可见
5. ❌ 上游 API 限制 → 不是 API 问题
6. ❌ 文件权限问题 → 脚本可以正常写入
7. ❌ 多个同名文件 → 只有一个 anthropic_converter.py
8. ❌ 条件分支跳过 → 添加了 else 分支
9. ❓ 代码路径问题 → **重点排查！**
10. ❓ 使用了错误的函数 → **真正的根因！**

### 2.2 关键发现

通过分析 `antigravity_router.py` 的导入和调用链，发现了真正的问题：

**`antigravity_router.py:58`**:
```python
from src.converters.tool_converter import generate_generation_config
```

**`antigravity_router.py:2030`**:
```python
generation_config = generate_generation_config(parameters, enable_thinking, actual_model)
```

**结论**：`antigravity_router.py` 使用的是 `tool_converter.py` 中的 `generate_generation_config`，**不是** `anthropic_converter.py` 中的 `build_generation_config`！

### 2.3 问题6 根因：修改了错误的文件

之前的修复（问题4、问题5）都在 `anthropic_converter.py` 中进行，但这个文件的函数根本不被 `antigravity_router.py` 使用！

**请求处理流程**：
```
客户端请求 → antigravity_router.py → tool_converter.generate_generation_config() → 下游 API
                                           ↑
                                    这才是真正使用的函数！
```

**之前错误的理解**：
```
客户端请求 → anthropic_converter.build_generation_config() → ...
                        ↑
               修改了这个，但它根本没被调用！
```

### 2.4 tool_converter.py 原始代码问题

**文件**: `src/converters/tool_converter.py:459-467`

```python
max_tokens = parameters.get("max_tokens")
if max_tokens is not None:
    # 添加上限保护，防止过大的 max_tokens 导致 429 错误
    if isinstance(max_tokens, int) and max_tokens > MAX_ALLOWED_TOKENS:
        log.warning(...)
        max_tokens = MAX_ALLOWED_TOKENS
    config_dict["maxOutputTokens"] = max_tokens  # ❌ 没有下限保护！
else:
    config_dict["maxOutputTokens"] = DEFAULT_MAX_OUTPUT_TOKENS
```

**问题**：当 `max_tokens` 不为 None 时（如客户端传 4096），只有上限保护，没有下限保护！

---

## 3. 修复方案

### 3.1 修复问题6：在 tool_converter.py 添加下限保护

**文件**: `gcli2api/src/converters/tool_converter.py:468-474`

**修改后**:
```python
max_tokens = parameters.get("max_tokens")
if max_tokens is not None:
    # 添加上限保护，防止过大的 max_tokens 导致 429 错误
    if isinstance(max_tokens, int) and max_tokens > MAX_ALLOWED_TOKENS:
        log.warning(
            f"[ANTIGRAVITY] maxOutputTokens 超过上限: {max_tokens} -> {MAX_ALLOWED_TOKENS}"
        )
        max_tokens = MAX_ALLOWED_TOKENS

    # [FIX 2026-01-12] 添加下限保护，防止客户端传来过小的 max_tokens 导致输出被截断
    # 这是之前修复都不生效的真正根因：antigravity_router 使用的是这个函数，不是 anthropic_converter 的！
    if isinstance(max_tokens, int) and max_tokens < MIN_OUTPUT_TOKENS:
        log.info(
            f"[ANTIGRAVITY] maxOutputTokens 低于下限: {max_tokens} -> {MIN_OUTPUT_TOKENS}"
        )
        max_tokens = MIN_OUTPUT_TOKENS

    config_dict["maxOutputTokens"] = max_tokens
else:
    # 设置默认值，确保有足够的输出空间
    config_dict["maxOutputTokens"] = DEFAULT_MAX_OUTPUT_TOKENS
```

---

## 4. 修复效果

### 4.1 修复前后对比

| 场景 | 客户端 max_tokens | 修复前 | 修复后 |
|------|-------------------|--------|--------|
| Cursor 默认 | 4,096 | 4,096（被截断）| **16,384** |
| Claude CLI | 8,192 | 8,192 | **16,384** |
| 自定义客户端 | 2,048 | 2,048（严重截断）| **16,384** |
| 未传参数 | None | 32,768 | 32,768 |

### 4.2 预期日志输出

修复生效后，日志应显示：
```
[INFO] [ANTIGRAVITY] maxOutputTokens 低于下限: 4096 -> 16384
```

---

## 5. 文件变更清单

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/converters/tool_converter.py` | 修改 | **关键修复** - 添加 max_tokens 下限保护 |
| `scripts/fix_tool_converter_floor.py` | 新增 | tool_converter.py 下限保护修复脚本 |

---

## 6. 经验教训

### 6.1 调试方法论

1. **追踪完整调用链**：修复代码前，必须确认代码是否真的被调用
2. **日志验证**：添加日志后如果没看到输出，说明代码路径有问题
3. **深度思考**：当修复"不生效"时，不要只想代码问题，要想路径问题

### 6.2 代码架构问题

项目中存在两个功能类似但用途不同的函数：
- `anthropic_converter.build_generation_config()` - 可能用于特定场景
- `tool_converter.generate_generation_config()` - 被 antigravity_router 主路由使用

**建议**：统一这两个函数，或者在文档中明确说明各自的使用场景。

---

## 7. 后续步骤

### 7.1 立即执行

1. **重启服务**：使修改生效
   ```bash
   cd F:/antigravity2api/gcli2api
   # 停止当前服务后重新启动
   ```

### 7.2 验证修复

1. 观察日志中是否出现 `maxOutputTokens 低于下限: 4096 -> 16384`
2. 测试长对话和 MD 文档写入，确认输出不再被截断

---

## 8. 总结

本次修复解决了之前所有修复都不生效的根本原因：

| 问题 | 根因 | 修复方案 | 状态 |
|------|------|----------|------|
| 问题1-5 修复无效 | 修改了错误的文件 | 在 tool_converter.py 添加下限保护 | ✅ 已修复 |

**核心教训**：修复代码前，必须追踪完整的调用链，确认代码确实会被执行！

---

*浮浮酱出品，必属精品喵～* ≡ω≡

