# 2026-01-08 上下文长度阈值修复报告

## 问题描述

### 现象

在 Cursor 中使用工具写 md 文档时，当上下文过长时，API 直接返回 400 错误：

```json
{"type":"error","error":{"type":"invalid_request_error","message":"Prompt is too long"}}
```

而不是触发本地的上下文长度检查并建议用户使用 `/summarize` 命令。

### 问题分析

| 阈值 | 原始值 | API 实际限制 | 问题 |
|------|--------|--------------|------|
| CONTEXT_WARNING_THRESHOLD | 80000 | - | 警告阈值 |
| CONTEXT_CRITICAL_THRESHOLD | 120000 | ~100K | **太高！API 在 ~100K 就报错** |

**根本原因**：本地的 `CONTEXT_CRITICAL_THRESHOLD = 120000` 设置过高，无法在 API 返回 "Prompt is too long" 错误之前捕获过长的上下文。

## 修复方案

### 修改位置

**文件**: `gcli2api/src/antigravity_router.py` 第 1903-1905 行

### 修改内容

```python
# 修复前
CONTEXT_WARNING_THRESHOLD = 80000   # 80K tokens - 警告阈值
CONTEXT_CRITICAL_THRESHOLD = 120000  # 120K tokens - 拒绝阈值

# 修复后
# [FIX 2026-01-08] 降低阈值以在 API 报错 "Prompt is too long" 之前捕获
CONTEXT_WARNING_THRESHOLD = 60000   # 60K tokens - 警告阈值，记录日志
CONTEXT_CRITICAL_THRESHOLD = 90000  # 90K tokens - 拒绝阈值，返回错误（API 限制约 100K）
```

## 预期效果

### 修复前

| 估算 tokens | 行为 |
|-------------|------|
| 60K-80K | 无警告 |
| 80K-100K | 警告日志 |
| 100K+ | **API 返回 400 错误** (用户看到原始错误) |
| 120K+ | 本地拒绝 (永远不会触发) |

### 修复后

| 估算 tokens | 行为 |
|-------------|------|
| 60K-90K | 警告日志，建议使用 /summarize |
| 90K+ | **本地拒绝**，返回友好错误消息，建议使用 /summarize |

## 错误消息改进

修复后，当上下文过长时，用户会看到友好的错误消息：

```
Context length limit exceeded. Your conversation has approximately X tokens,
which exceeds the limit of 90,000 tokens.

To resolve this issue:
1. Use the /summarize command in Cursor to compress the conversation history
2. Or start a new chat session
3. Or reduce the number of files and tool results in context

This limit exists to prevent API errors and ensure reliable responses.
```

## 备份文件

- `antigravity_router.py.bak.20260108_081511`

## 补丁脚本

- `patch_context_threshold.py` - 上下文长度阈值修复补丁

## 完整修复清单（2026-01-08）

| 修复 | 文件 | 补丁脚本 | 状态 |
|------|------|----------|------|
| Anthropic 格式基础 max_tokens 保护 | `antigravity_anthropic_router.py` | `patch_max_tokens.py` | ✅ 已完成 |
| Anthropic 格式 thinking 保护 | `antigravity_anthropic_router.py` | `patch_thinking_budget.py` | ✅ 已完成 |
| OpenAI 格式完整 max_tokens 保护 | `antigravity_router.py` | `patch_openai_max_tokens.py` | ✅ 已完成 |
| 上下文长度阈值修复 | `antigravity_router.py` | `patch_context_threshold.py` | ✅ 已完成 |

## 遵循原则

- **KISS**: 简单的阈值调整
- **用户体验优先**: 在 API 报错前捕获，返回友好消息
- **可观测性**: 详细的日志记录

## 后续建议

1. **重启服务**：应用补丁后需要重启 gcli2api 服务
2. **观察日志**：检查上下文长度警告是否正常工作
3. **监控 400 错误**：观察修复后是否还有 "Prompt is too long" 错误

## 关联问题

1. **MAX_TOKENS 导致输出截断** - ✅ 已修复（OpenAI + Anthropic 格式）
2. **工具调用时卡住** - ✅ 已修复（max_tokens 保护）
3. **"Prompt is too long" 400 错误** - ✅ 已修复（本报告）
