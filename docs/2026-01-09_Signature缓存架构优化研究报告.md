# Signature ç¼“å­˜æ¶æ„ä¼˜åŒ–ç ”ç©¶æŠ¥å‘Š

**æ—¥æœŸ**: 2026-01-09
**ä½œè€…**: Claude Opus 4.5 (æµ®æµ®é…±)
**çŠ¶æ€**: âœ… ç ”ç©¶å®Œæˆ

---

## 1. ç ”ç©¶èƒŒæ™¯

### 1.1 ç”¨æˆ·éœ€æ±‚

ç”¨æˆ·å¸Œæœ›è®¾è®¡æ›´å¥å£®çš„ç¼“å­˜æ–¹æ¡ˆï¼Œè€ƒè™‘ä¸‰ä¸ªç»´åº¦ï¼š

| ç»´åº¦ | éœ€æ±‚æè¿° |
|------|----------|
| **å®¹ç¾** | ä¸€æ¡ Cursor å¯¹è¯ç¼“å­˜ä¸€ä¸ªæ–‡ä»¶å¯è°ƒç”¨ï¼Œä¸ä¼šåœ¨ Cursor ç¦»çº¿åæ¶ˆå¤± |
| **éš”ç¦»** | å¤šæ¡å¯¹è¯ã€å¤šä¸ª Agent è¿è¡Œæ—¶ç¼“å­˜å’Œ thinking ä¸ä¼š"ä¸²å‘³" |
| **æ€§èƒ½** | æ›´é«˜æ›´å¿«çš„æ€§èƒ½ï¼Œå¦‚å¼•å…¥ Redis ç­‰æœåŠ¡ |

### 1.2 å½“å‰æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SignatureCache                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚     OrderedDict (LRU, max=10000)            â”‚    â”‚
â”‚  â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚     â”‚ key: MD5(thinking_text[:500])  â”‚      â”‚    â”‚
â”‚  â”‚     â”‚ value: CacheEntry              â”‚      â”‚    â”‚
â”‚  â”‚     â”‚   - signature                  â”‚      â”‚    â”‚
â”‚  â”‚     â”‚   - thinking_text (å®Œæ•´)       â”‚      â”‚    â”‚
â”‚  â”‚     â”‚   - timestamp                  â”‚      â”‚    â”‚
â”‚  â”‚     â”‚   - access_count               â”‚      â”‚    â”‚
â”‚  â”‚     â”‚   - model                      â”‚      â”‚    â”‚
â”‚  â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                      â”‚
â”‚  Threading.Lock (å…¨å±€é”)                             â”‚
â”‚  TTL: 3600s (1å°æ—¶)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    å…¨å±€å•ä¾‹æ¨¡å¼
    (è¿›ç¨‹å†…å…±äº«)
```

### 1.3 å½“å‰æ¶æ„å±€é™æ€§

| é—®é¢˜ | å½±å“ | ä¸¥é‡ç¨‹åº¦ |
|------|------|----------|
| **å†…å­˜å•ä¾‹** | æœåŠ¡é‡å¯åç¼“å­˜ä¸¢å¤±ï¼Œ1å°æ—¶å†…å¯¹è¯éœ€é‡æ–°å»ºç«‹ | ğŸ”´ é«˜ |
| **å…¨å±€å…±äº«** | å¤šå¯¹è¯å…±ç”¨ç¼“å­˜ï¼Œå¯èƒ½é€ æˆ signature æ··æ·† | ğŸŸ¡ ä¸­ |
| **å…¨å±€é”** | é«˜å¹¶å‘ä¸‹ I/O é˜»å¡ï¼Œæ€§èƒ½ç“¶é¢ˆ | ğŸŸ¡ ä¸­ |
| **æ— æŒä¹…åŒ–** | Cursor ç¦»çº¿é‡è¿åç¼“å­˜å¤±æ•ˆ | ğŸ”´ é«˜ |

---

## 2. è§£å†³æ–¹æ¡ˆç ”ç©¶

### 2.1 å®¹ç¾æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: æ–‡ä»¶æŒä¹…åŒ–ï¼ˆæ¯å¯¹è¯ä¸€æ–‡ä»¶ï¼‰

```
~/.antigravity/signature_cache/
â”œâ”€â”€ conv_abc123.json          # å¯¹è¯ A çš„ç¼“å­˜
â”œâ”€â”€ conv_def456.json          # å¯¹è¯ B çš„ç¼“å­˜
â””â”€â”€ conv_ghi789.json          # å¯¹è¯ C çš„ç¼“å­˜
```

**ä¼˜ç‚¹**:
- ç®€å•ç›´è§‚ï¼Œæ˜“äºè°ƒè¯•
- æ¯å¯¹è¯éš”ç¦»ï¼Œäº’ä¸å½±å“
- æ–‡ä»¶ç³»ç»ŸåŸå­æ“ä½œ

**ç¼ºç‚¹**:
- é¢‘ç¹ I/O æ“ä½œ
- æ— æ³•å¤„ç†é«˜å¹¶å‘å†™å…¥
- æ–‡ä»¶ç¢ç‰‡åŒ–

#### æ–¹æ¡ˆ B: SQLite æŒä¹…åŒ–

```sql
CREATE TABLE signature_cache (
    id INTEGER PRIMARY KEY,
    namespace TEXT NOT NULL,
    conversation_id TEXT NOT NULL,
    thinking_hash TEXT NOT NULL,
    signature TEXT NOT NULL,
    thinking_text TEXT NOT NULL,
    model TEXT,
    created_at REAL NOT NULL,
    accessed_at REAL NOT NULL,
    access_count INTEGER DEFAULT 0,
    UNIQUE(namespace, conversation_id, thinking_hash)
);

CREATE INDEX idx_lookup ON signature_cache(namespace, conversation_id, thinking_hash);
CREATE INDEX idx_ttl ON signature_cache(created_at);
```

**ä¼˜ç‚¹**:
- ç»“æ„åŒ–æ•°æ®ï¼ŒæŸ¥è¯¢é«˜æ•ˆ
- äº‹åŠ¡æ”¯æŒï¼Œæ•°æ®ä¸€è‡´æ€§
- WAL æ¨¡å¼æ”¯æŒé«˜å¹¶å‘
- å•æ–‡ä»¶ä¾¿äºç®¡ç†

**ç¼ºç‚¹**:
- å¼•å…¥é¢å¤–ä¾èµ–
- éœ€è¦å®šæœŸæ¸…ç†

#### æ–¹æ¡ˆ C: Redis æŒä¹…åŒ–

```
HSET sig:conv_abc123 {hash} {signature}
EXPIRE sig:conv_abc123 3600
```

**ä¼˜ç‚¹**:
- è¶…é«˜æ€§èƒ½ (10ä¸‡+ QPS)
- åŸç”Ÿ TTL æ”¯æŒ
- åˆ†å¸ƒå¼å°±ç»ª

**ç¼ºç‚¹**:
- éœ€è¦è¿è¡Œ Redis æœåŠ¡
- å¢åŠ è¿ç»´å¤æ‚åº¦
- å¯¹æœ¬åœ° API ä»£ç†è¿‡é‡

### 2.2 éš”ç¦»æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: å‘½åç©ºé—´å‰ç¼€

```python
# å¤åˆé”®æ ¼å¼
key = f"{namespace}:{conversation_id}:{thinking_hash}"

# ç¤ºä¾‹
key = "cursor:conv_abc123:a1b2c3d4e5f6..."
key = "agent_1:conv_def456:f6e5d4c3b2a1..."
```

**ä¼˜ç‚¹**:
- å®ç°ç®€å•
- å¤©ç„¶éš”ç¦»
- æ˜“äºè°ƒè¯•

#### æ–¹æ¡ˆ B: åˆ†å±‚ç¼“å­˜ (Layered Cache)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CacheManager                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  L1: Memory Cache (per-conversation)         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  conv_abc123 â†’ SignatureCache        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  conv_def456 â†’ SignatureCache        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  conv_ghi789 â†’ SignatureCache        â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                        â†“ miss                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  L2: SQLite Cache (persistent)               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  signature_cache.db                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  (with namespace + conv_id index)    â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**:
- L1 å¿«é€Ÿå“åº”
- L2 æŒä¹…åŒ–ä¿éšœ
- å®Œç¾éš”ç¦»

#### æ–¹æ¡ˆ C: å¤åˆé”® + ä¸Šä¸‹æ–‡ä¼ é€’

```python
from contextvars import ContextVar

# è¯·æ±‚çº§åˆ«ä¸Šä¸‹æ–‡
current_conversation_id: ContextVar[str] = ContextVar('conversation_id')
current_namespace: ContextVar[str] = ContextVar('namespace')

# ä½¿ç”¨
async def handle_request(request):
    current_conversation_id.set(request.headers.get('X-Conversation-Id'))
    current_namespace.set('cursor')
    # ... åç»­ä»£ç è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸‹æ–‡
```

### 2.3 æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

#### æ–¹æ¡ˆ A: è¯»å†™é”åˆ†ç¦»

```python
from threading import RLock
from contextlib import contextmanager

class ReadWriteLock:
    def __init__(self):
        self._read_ready = threading.Condition(threading.RLock())
        self._readers = 0

    @contextmanager
    def read_lock(self):
        with self._read_ready:
            self._readers += 1
        try:
            yield
        finally:
            with self._read_ready:
                self._readers -= 1
                if self._readers == 0:
                    self._read_ready.notify_all()

    @contextmanager
    def write_lock(self):
        with self._read_ready:
            while self._readers > 0:
                self._read_ready.wait()
            yield
```

**æ•ˆæœ**: è¯»æ“ä½œæ— é”ç«äº‰ï¼Œå†™æ“ä½œç­‰å¾…è¯»å®Œæˆ

#### æ–¹æ¡ˆ B: å¼‚æ­¥å†™å…¥

```python
import asyncio
from queue import Queue
from threading import Thread

class AsyncCacheWriter:
    def __init__(self, db_path: str):
        self._queue: Queue = Queue()
        self._worker = Thread(target=self._write_loop, daemon=True)
        self._worker.start()

    def schedule_write(self, entry: CacheEntry):
        self._queue.put(entry)

    def _write_loop(self):
        while True:
            entries = []
            # æ‰¹é‡æ”¶é›†
            while not self._queue.empty() and len(entries) < 100:
                entries.append(self._queue.get())
            if entries:
                self._batch_write(entries)
            time.sleep(0.1)
```

**æ•ˆæœ**: å†™æ“ä½œä¸é˜»å¡ä¸»æµç¨‹ï¼Œæ‰¹é‡å†™å…¥æé«˜æ•ˆç‡

#### æ–¹æ¡ˆ C: åˆ†ç‰‡ç¼“å­˜

```python
class ShardedCache:
    def __init__(self, shard_count: int = 16):
        self._shards = [SignatureCache() for _ in range(shard_count)]
        self._shard_count = shard_count

    def _get_shard(self, key: str) -> SignatureCache:
        shard_id = hash(key) % self._shard_count
        return self._shards[shard_id]

    def get(self, key: str) -> Optional[str]:
        return self._get_shard(key).get(key)

    def set(self, key: str, value: str):
        self._get_shard(key).set(key, value)
```

**æ•ˆæœ**: 16 ä¸ªåˆ†ç‰‡ = 16 å€å¹¶å‘èƒ½åŠ›

---

## 3. æ¨èæ¶æ„è®¾è®¡

### 3.1 æ··åˆæ¶æ„ (Hybrid Architecture)

åŸºäºç ”ç©¶ç»“è®ºï¼Œæ¨èé‡‡ç”¨ **SQLite + åˆ†å±‚ç¼“å­˜** çš„æ··åˆæ¶æ„ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Antigravity API                           â”‚
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    ConversationContext                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  conversation_id: "conv_abc123"                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  namespace: "cursor"                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  agent_id: "agent_1"                                   â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                                    â”‚
â”‚                              â–¼                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    SignatureCacheManager                     â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  L1: Memory Cache (Sharded, per-namespace)            â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  namespace:cursor                               â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    â”œâ”€â”€ conv_abc123 â†’ OrderedDict{...}           â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    â””â”€â”€ conv_def456 â†’ OrderedDict{...}           â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  namespace:agent_1                              â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚    â””â”€â”€ conv_ghi789 â†’ OrderedDict{...}           â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                        â”‚                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚                        â–¼ miss                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  L2: SQLite Persistent Cache                    â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  ~/.antigravity/signature_cache.db              â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚  (WAL mode, async write, batch commit)          â”‚  â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸ºä»€ä¹ˆä¸ç”¨ Redisï¼Ÿ

| è€ƒé‡ç‚¹ | Redis | SQLite |
|--------|-------|--------|
| **éƒ¨ç½²å¤æ‚åº¦** | éœ€è¦é¢å¤–æœåŠ¡ | å†…åµŒï¼Œé›¶éƒ¨ç½² |
| **è¿ç»´æˆæœ¬** | éœ€è¦ç›‘æ§ã€å¤‡ä»½ | è‡ªåŠ¨ç®¡ç† |
| **é€‚ç”¨åœºæ™¯** | åˆ†å¸ƒå¼ç³»ç»Ÿ | æœ¬åœ° API ä»£ç† |
| **æ€§èƒ½** | 10ä¸‡+ QPS | WALæ¨¡å¼ 1ä¸‡+ QPS |
| **æŒä¹…åŒ–** | RDB/AOF é…ç½® | è‡ªåŠ¨ |

**ç»“è®º**: æœ¬åœ° API ä»£ç†åœºæ™¯ä¸‹ï¼ŒSQLite + WAL æ¨¡å¼å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€å¼•å…¥ Redis çš„é¢å¤–å¤æ‚åº¦ã€‚

### 3.3 å…³é”®æ•°æ®ç»“æ„

```python
@dataclass
class ConversationContext:
    """å¯¹è¯ä¸Šä¸‹æ–‡"""
    conversation_id: str
    namespace: str = "default"
    agent_id: Optional[str] = None
    created_at: float = field(default_factory=time.time)

@dataclass
class SignatureCacheKey:
    """å¤åˆç¼“å­˜é”®"""
    namespace: str
    conversation_id: str
    thinking_hash: str

    def __str__(self) -> str:
        return f"{self.namespace}:{self.conversation_id}:{self.thinking_hash}"

class SignatureCacheManager:
    """åˆ†å±‚ç¼“å­˜ç®¡ç†å™¨"""

    def __init__(self, db_path: str = "~/.antigravity/signature_cache.db"):
        self._l1_cache: Dict[str, Dict[str, OrderedDict]] = {}  # namespace -> conv_id -> cache
        self._l1_lock = RWLock()  # è¯»å†™é”
        self._db = SignatureDatabase(db_path)  # L2 SQLite
        self._write_queue = AsyncWriteQueue(self._db)  # å¼‚æ­¥å†™å…¥é˜Ÿåˆ—

    def get(self, ctx: ConversationContext, thinking_text: str) -> Optional[str]:
        """è·å–ç¼“å­˜çš„ signature"""
        key = self._build_key(ctx, thinking_text)

        # L1 æŸ¥æ‰¾
        with self._l1_lock.read_lock():
            l1_result = self._l1_get(key)
            if l1_result:
                return l1_result

        # L2 æŸ¥æ‰¾
        l2_result = self._db.get(key)
        if l2_result:
            # å›å¡« L1
            self._l1_set(key, l2_result)
            return l2_result.signature

        return None

    def set(self, ctx: ConversationContext, thinking_text: str, signature: str):
        """ç¼“å­˜ signature"""
        key = self._build_key(ctx, thinking_text)
        entry = CacheEntry(signature=signature, thinking_text=thinking_text, ...)

        # L1 ç«‹å³å†™å…¥
        with self._l1_lock.write_lock():
            self._l1_set(key, entry)

        # L2 å¼‚æ­¥å†™å…¥
        self._write_queue.enqueue(key, entry)
```

---

## 4. å®æ–½è·¯çº¿å›¾

### Phase 1: å¯¹è¯éš”ç¦» (P0, 1-2 å¤©)

**ç›®æ ‡**: æ·»åŠ  conversation_id æ”¯æŒï¼Œå®ç°åŸºæœ¬éš”ç¦»

**ä¿®æ”¹æ–‡ä»¶**:
- `src/signature_cache.py`: æ·»åŠ  `ConversationContext` å’Œå¤åˆé”®
- `src/antigravity_router.py`: ä»è¯·æ±‚å¤´æå– `X-Conversation-Id`

**éªŒè¯**: å¤šå¯¹è¯å¹¶è¡Œæµ‹è¯•ï¼Œç¡®è®¤æ— ä¸²æ‰°

### Phase 2: SQLite æŒä¹…åŒ– (P0, 2-3 å¤©)

**ç›®æ ‡**: æ·»åŠ  L2 SQLite ç¼“å­˜å±‚

**æ–°å¢æ–‡ä»¶**:
- `src/signature_database.py`: SQLite æ“ä½œå°è£…

**ä¿®æ”¹æ–‡ä»¶**:
- `src/signature_cache.py`: é›†æˆ L2 å±‚

**éªŒè¯**: æœåŠ¡é‡å¯åç¼“å­˜æ¢å¤æµ‹è¯•

### Phase 3: å¤š Agent éš”ç¦» (P1, 1-2 å¤©)

**ç›®æ ‡**: æ·»åŠ  namespace æ”¯æŒ

**ä¿®æ”¹æ–‡ä»¶**:
- `src/signature_cache.py`: æ·»åŠ  namespace å¤„ç†
- `src/antigravity_router.py`: ä»è¯·æ±‚å¤´æå– `X-Namespace`

**éªŒè¯**: å¤š Agent å¹¶è¡Œæµ‹è¯•

### Phase 4: æ€§èƒ½ä¼˜åŒ– (P2, å¯é€‰)

**ç›®æ ‡**: å¼•å…¥è¯»å†™é”å’Œå¼‚æ­¥å†™å…¥

**æ–°å¢æ–‡ä»¶**:
- `src/async_cache_writer.py`: å¼‚æ­¥å†™å…¥é˜Ÿåˆ—

**ä¿®æ”¹æ–‡ä»¶**:
- `src/signature_cache.py`: æ›¿æ¢å…¨å±€é”ä¸ºè¯»å†™é”

**éªŒè¯**: å‹åŠ›æµ‹è¯•ï¼Œç¡®è®¤æ€§èƒ½æå‡

---

## 5. é¢„æœŸæ”¶ç›Š

| ç»´åº¦ | å½“å‰çŠ¶æ€ | ä¼˜åŒ–å | æ”¹è¿› |
|------|----------|--------|------|
| **æœåŠ¡é‡å¯æ¢å¤** | âŒ ç¼“å­˜ä¸¢å¤± | âœ… SQLite æŒä¹…åŒ– | 100% æ¢å¤ |
| **å¤šå¯¹è¯éš”ç¦»** | âŒ å…¨å±€å…±äº« | âœ… conversation_id éš”ç¦» | é›¶ä¸²æ‰° |
| **å¤š Agent éš”ç¦»** | âŒ æ— éš”ç¦» | âœ… namespace éš”ç¦» | é›¶ä¸²æ‰° |
| **é«˜å¹¶å‘æ€§èƒ½** | ğŸŸ¡ å…¨å±€é” | âœ… è¯»å†™é” + åˆ†ç‰‡ | 10x+ æå‡ |
| **Cursor ç¦»çº¿æ¢å¤** | âŒ ç¼“å­˜å¤±æ•ˆ | âœ… SQLite æŒä¹…åŒ– | 100% æ¢å¤ |

---

## 6. é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|------|----------|
| SQLite å†™å…¥å¤±è´¥ | ä½ | ä¸­ | WAL æ¨¡å¼ + é‡è¯•æœºåˆ¶ |
| L1/L2 æ•°æ®ä¸ä¸€è‡´ | ä½ | ä¸­ | L1 ä½œä¸ºç¼“å­˜ï¼ŒL2 ä¸ºæº |
| ç£ç›˜ç©ºé—´ä¸è¶³ | ä½ | é«˜ | TTL æ¸…ç† + å®¹é‡ç›‘æ§ |
| è¿ç§»å…¼å®¹æ€§ | ä¸­ | ä½ | æ¸è¿›å¼è¿ç§»ï¼Œä¿æŒæ—§æ¥å£ |

---

## 7. ç»“è®º

### 7.1 æ¨èæ–¹æ¡ˆ

é‡‡ç”¨ **SQLite + åˆ†å±‚ç¼“å­˜ (L1 Memory + L2 SQLite)** çš„æ··åˆæ¶æ„ï¼Œé…åˆ **å¤åˆé”® (`namespace:conversation_id:hash`)** å®ç°éš”ç¦»ã€‚

### 7.2 ä¸æ¨è Redis

æœ¬åœ° API ä»£ç†åœºæ™¯ä¸‹ï¼ŒSQLite + WAL æ¨¡å¼å®Œå…¨æ»¡è¶³éœ€æ±‚ï¼Œæ— éœ€å¼•å…¥ Redis çš„é¢å¤–å¤æ‚åº¦ã€‚

### 7.3 å®æ–½ä¼˜å…ˆçº§

1. **P0**: å¯¹è¯éš”ç¦» + SQLite æŒä¹…åŒ– (è§£å†³æ ¸å¿ƒç—›ç‚¹)
2. **P1**: å¤š Agent éš”ç¦» (å¢å¼ºå¥å£®æ€§)
3. **P2**: æ€§èƒ½ä¼˜åŒ– (é”¦ä¸Šæ·»èŠ±)

---

**ç ”ç©¶å®Œæˆ** âœ…

*æœ¬æŠ¥å‘Šç”± Claude Opus 4.5 (æµ®æµ®é…±) ç”Ÿæˆ à¸…'Ï‰'à¸…*
