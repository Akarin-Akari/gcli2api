# 数据库与凭证安全说明

## 📍 数据库文件位置

### 默认位置
- **路径**: `./creds/credentials.db`（相对于项目根目录）
- **完整路径**: `F:\antigravity2api-official\creds\credentials.db`

### 配置方式
数据库位置可以通过以下方式修改：

1. **环境变量**（优先级最高）:
   ```bash
   export CREDENTIALS_DIR="/path/to/your/creds"
   ```

2. **数据库配置**:
   - 在 Web 面板的配置页面设置 `credentials_dir` 字段

3. **代码默认值**:
   - 如果未设置，默认使用 `./creds` 目录

### 数据库结构
数据库包含以下表：
- `credentials` - 普通 Google Cloud Gemini API 凭证
- `antigravity_credentials` - Antigravity API 凭证
- `config` - 系统配置
- `sqlite_sequence` - SQLite 自增序列

## 🔒 凭证安全保护

### Git 忽略规则
项目已配置 `.gitignore` 文件，**确保凭证不会被提交到 GitHub**：

```gitignore
# Credential files - should never be committed
*.json                    # 所有 JSON 文件（包括凭证文件）
creds/                    # 整个 creds 目录
*.bak                     # 备份文件
*.log                     # 日志文件
.env                      # 环境变量文件
```

### 验证方法
使用以下命令验证凭证文件是否被 Git 忽略：

```bash
# 检查数据库文件是否被忽略
git check-ignore -v creds/credentials.db

# 查看 creds 目录下是否有文件被跟踪
git ls-files creds/

# 如果返回空，说明所有凭证文件都被正确忽略
```

### 凭证文件格式
凭证文件命名规则：
- **普通凭证**: `{project_id}-{timestamp}.json`
- **Antigravity 凭证**: `ag_{project_id}-{timestamp}.json`

示例：
```
creds/
  ├── credentials.db                    # SQLite 数据库（包含所有凭证元数据）
  ├── project-123-1766350344.json      # 普通凭证文件
  └── ag_project-456-1766352764.json   # Antigravity 凭证文件
```

## ⚠️ 安全注意事项

### ✅ 安全措施
1. **`.gitignore` 已配置**: `creds/` 目录和所有 `*.json` 文件都被忽略
2. **数据库本地存储**: 默认使用本地 SQLite，不会上传到云端
3. **凭证加密**: 凭证数据存储在数据库中，不会以明文形式出现在代码中

### ⚠️ 注意事项
1. **不要手动提交凭证文件**: 即使 `.gitignore` 已配置，也要避免使用 `git add -f` 强制添加
2. **检查备份文件**: 备份文件（`*.bak`）也被忽略，但建议定期清理
3. **环境变量**: 如果使用环境变量存储敏感信息，确保 `.env` 文件也在 `.gitignore` 中
4. **代码审查**: 在提交 PR 前，检查是否有敏感信息泄露

### 🔍 安全检查清单
在提交代码前，请检查：

- [ ] `git status` 中没有显示 `creds/` 目录下的文件
- [ ] `git ls-files creds/` 返回空
- [ ] 没有硬编码的凭证信息
- [ ] 日志文件中没有敏感信息
- [ ] 备份文件没有被提交

## 📋 数据库迁移

如果需要将凭证从 master 版本迁移到 official 版本：

```bash
# 使用提供的迁移脚本
python copy_credentials.py
```

脚本会：
1. 自动备份目标数据库
2. 复制 `antigravity_credentials` 表数据
3. 复制 `credentials` 表数据（可选）
4. 复制 `config` 表数据（可选）
5. 验证迁移结果

## 🛡️ 最佳实践

1. **定期备份**: 定期备份 `creds/credentials.db` 文件
2. **权限控制**: 确保 `creds/` 目录权限设置正确（仅当前用户可读写）
3. **版本控制**: 使用 Git 标签标记稳定版本，但**不要**包含凭证数据
4. **环境隔离**: 开发、测试、生产环境使用不同的凭证目录

## 📞 问题排查

如果遇到"无有效的 antigravity 凭证"错误：

1. **检查数据库文件是否存在**:
   ```bash
   ls -la creds/credentials.db
   ```

2. **检查凭证数量**:
   ```python
   python check_db.py
   ```

3. **检查凭证状态**:
   - 访问 Web 面板: `http://127.0.0.1:7861/auth`
   - 查看 Antigravity 凭证标签页
   - 确认凭证未被禁用（`disabled=0`）

4. **从 master 版本迁移**:
   ```bash
   python copy_credentials.py
   ```

