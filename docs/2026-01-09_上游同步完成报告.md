# 上游同步完成报告

**日期**: 2026-01-09  
**状态**: ✅ 同步完成，API 代理服务正常工作

---

## 一、上游关键提交分析

| 提交 | 日期 | 文件 | 变更内容 | 同步状态 |
|------|------|------|----------|----------|
| `21b2ae4` | 01-08 | antigravity_api.py | requestType + custom_prompt | ✅ 已同步 |
| `7355306` | 01-08 | antigravity_api.py | (同上) | ✅ 已同步 |
| `b019d9b` | 01-08 | antigravity_api.py | (同上) | ✅ 已同步 |
| `2a88cde` | 01-08 | antigravity_api.py | (同上) | ✅ 已同步 |
| `fb3eb28` | 01-07 | anthropic_converter.py | 添加 gemini-3-flash 模型 | ✅ 本地已有 |

---

## 二、已同步的核心变更

### 2.1 `build_antigravity_request_body()` 函数

```python
# [FIX 2026-01-09] 添加的关键字段
request_body = {
    ...
    "requestType": "agent",  # ← 新增
    ...
}

# [FIX 2026-01-09] 添加的 custom_prompt 逻辑
custom_prompt = "You are Antigravity..."
if system_instruction:
    system_instruction["parts"] = [{"text": custom_prompt}] + parts
else:
    request_body["request"]["systemInstruction"] = {"parts": [{"text": custom_prompt}]}
```

---

## 三、保留的自定义功能

以下本地自定义功能已确认保留，未被上游覆盖：

| 功能 | 文件 | 状态 |
|------|------|------|
| 跨池降级 | `fallback_manager.py` | ✅ 保留 |
| 统一网关 | `unified_gateway_router.py` | ✅ 保留 |
| Signature Cache | `signature_cache.py` | ✅ 保留 |
| contents 验证 | `antigravity_api.py` | ✅ 保留 |
| NonRetryableError | `antigravity_api.py` | ✅ 保留 |

---

## 四、上游删除但本地保留的文件

上游删除了以下文件，但本地需要保留：

- `src/fallback_manager.py` - 跨池降级管理
- `src/unified_gateway_router.py` - 统一网关路由
- `src/context_analyzer.py` - 上下文分析
- `src/stream_error_handler.py` - 流式错误处理
- `src/tool_cleaner.py` - 工具清理
- `src/converters/` - 消息转换器
- `src/patch_*.py` - 各种补丁模块

**决策**: 这些是本地自定义功能，不跟随上游删除。

---

## 五、参数兼容性

| 参数 | 上游格式 | 本地格式 | 决策 |
|------|----------|----------|------|
| 凭证模式 | `mode="antigravity"` | `is_antigravity=True` | ✅ 保持本地格式 |

**原因**: 本地 `CredentialManager` 使用 `is_antigravity` 参数，功能等价，无需修改。

---

## 六、测试验证

- ✅ Claude 模型请求成功（不再 429）
- ✅ Gemini 模型请求成功（不再 404）
- ✅ 跨池降级功能正常
- ✅ API 代理服务正常工作

---

**报告生成时间**: 2026-01-09 00:35
