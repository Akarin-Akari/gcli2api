# 便捷函数迁移代理修复报告

**日期**: 2026-01-12
**作者**: Claude Opus 4.5 (浮浮酱)
**问题类型**: 架构集成缺陷
**严重程度**: 严重
**版本**: v2 (追加第二次修复)

---

## 问题描述

用户反馈：gcli2api 在为 Cursor 转发 Claude 模型时，多步推理功能失效。即使已经启用了 DUAL_WRITE 迁移模式，问题依然存在。

## 根本原因

**两个问题共同导致修复无效：**

1. **便捷函数硬编码调用旧缓存，完全绕过了 CacheFacade 迁移逻辑** ← 第一次修复
2. **迁移模式需要环境变量才能启用，但环境变量没有设置** ← 第二次修复

### 问题代码位置

`gcli2api/src/signature_cache.py`:
- 第 471-623 行：便捷函数（第一次修复目标）
- 第 647-677 行：`_is_migration_mode()` 函数（第二次修复目标）

### 问题分析

```
调用链（第一次修复前）:
    antigravity_router.py
        ↓ 调用
    get_last_signature()  [便捷函数]
        ↓ 硬编码调用
    get_signature_cache()  [旧的纯内存缓存]
        ↓ 返回
    None  (服务重启后缓存为空)
        ↓ 导致
    thinking 模式被禁用
```

```
调用链（第一次修复后，但环境变量未设置）:
    antigravity_router.py
        ↓ 调用
    get_last_signature()  [便捷函数]
        ↓ 检查
    _is_migration_mode()
        ↓ 返回 False (因为环境变量未设置)
        ↓ 仍然走
    get_signature_cache()  [旧的纯内存缓存]
        ↓ 问题依旧
```

---

## 修复方案

### 第一次修复：便捷函数添加迁移模式代理

为以下 5 个便捷函数添加迁移模式代理逻辑：

| 函数名 | 修改内容 |
|--------|----------|
| `cache_signature()` | 添加 `_is_migration_mode()` 检查和 `facade.cache_signature()` 代理 |
| `get_cached_signature()` | 添加 `_is_migration_mode()` 检查和 `facade.get_cached_signature()` 代理 |
| `get_cache_stats()` | 添加 `_is_migration_mode()` 检查和 `facade.get_cache_stats()` 代理 |
| `get_last_signature()` | 添加 `_is_migration_mode()` 检查和 `facade.get_last_signature()` 代理 |
| `get_last_signature_with_text()` | 添加 `_is_migration_mode()` 检查和 `facade.get_last_signature_with_text()` 代理 |

### 第二次修复：迁移模式默认启用

修改 `_is_migration_mode()` 函数：

**修改前**:
```python
env_value = os.environ.get(_ENV_USE_MIGRATION, "").lower()
return env_value in ("true", "1", "yes", "on")  # 默认返回 False
```

**修改后**:
```python
env_value = os.environ.get(_ENV_USE_MIGRATION, "").lower()
# 只有明确设置为 false 时才禁用，否则默认启用
if env_value in ("false", "0", "no", "off"):
    return False
return True  # 默认返回 True
```

### 修复后的调用链

```
调用链（完全修复后）:
    antigravity_router.py
        ↓ 调用
    get_last_signature()  [便捷函数]
        ↓ 检查
    _is_migration_mode()
        ↓ 返回 True (默认启用)
        ↓ 代理调用
    _get_migration_facade()
        ↓ 获取
    CacheFacade.get_last_signature()
        ↓ 根据迁移阶段
    L1 内存缓存 + L2 SQLite 持久化
        ↓ 返回
    有效的 signature (即使服务重启也能恢复)
        ↓ 结果
    thinking 模式保持启用 ✓
```

---

## 新增日志

服务首次调用迁移模式检查时，会输出以下日志：

```
[SIGNATURE_CACHE] 迁移模式检查: 环境变量=(未设置), 结果=启用
```

或

```
[SIGNATURE_CACHE] 迁移模式检查: 环境变量=false, 结果=禁用
```

当代理调用成功时，会输出：

```
[SIGNATURE_CACHE] 迁移门面初始化成功
[SIGNATURE_CACHE] get_last_signature: 代理到迁移门面
```

---

## 修复过程

### 第一次修复（10:07）

1. **问题识别**: 便捷函数未使用迁移基础设施
2. **Write 工具失败**: "File has not been read yet" 错误
3. **Edit 工具失败**: "File has been unexpectedly modified" 错误
4. **解决方案**: 使用 Python 脚本 `fix_signature_cache_v2.py`
5. **验证**: 所有 5 个函数成功添加代理逻辑

### 第二次修复（10:25）

1. **用户反馈**: 修复后仍然无效
2. **日志分析**: 没有看到 `代理到迁移门面` 的日志输出
3. **环境变量检查**: `CACHE_USE_MIGRATION_ADAPTER` 未设置
4. **根本原因**: `_is_migration_mode()` 默认返回 False
5. **解决方案**: 修改为默认返回 True，只有明确设置 `false` 时才禁用
6. **额外改进**: 添加首次调用时的状态日志

---

## 验证结果

```bash
$ grep -n "默认启用迁移模式\|迁移模式检查" signature_cache.py
651:    [FIX 2026-01-12] 默认启用迁移模式，以确保 DUAL_WRITE 架构生效
675:        log.info(f"[SIGNATURE_CACHE] 迁移模式检查: 环境变量={env_display}, 结果={'启用' if result else '禁用'}")
```

---

## 后续验证步骤

1. **重启 gcli2api 服务**
   ```bash
   cd F:\antigravity2api\gcli2api
   python web.py
   ```

2. **检查日志** (不再需要设置环境变量！)
   - 应看到 `迁移模式检查: 环境变量=(未设置), 结果=启用`
   - 应看到 `迁移门面初始化成功`
   - 应看到 `代理到迁移门面` 的日志

3. **测试多步推理**
   - 在 Cursor 中发起需要多步推理的请求
   - 确认 Claude 能够正常进行工具调用循环

4. **（可选）禁用迁移模式**
   ```bash
   set CACHE_USE_MIGRATION_ADAPTER=false
   ```

---

## 备份文件

| 文件 | 位置 |
|------|------|
| 原始备份 | `signature_cache.py.backup_20260112_072527` |
| 修复脚本 | `scripts/fix_signature_cache_v2.py` |

---

## 总结

| 项目 | 说明 |
|------|------|
| **问题根因** | 1. 便捷函数绕过迁移门面；2. 迁移模式默认禁用 |
| **影响范围** | 所有使用 thinking 模式的多步推理请求 |
| **第一次修复** | 为 5 个便捷函数添加迁移模式代理逻辑 |
| **第二次修复** | 修改 `_is_migration_mode()` 默认返回 True |
| **修复状态** | ✅ 已完成 |
| **验证状态** | ✅ 代码验证通过，待运行时验证 |

---

## 关键改进点

1. **零配置启用**: 现在不需要设置任何环境变量，迁移模式默认启用
2. **向后兼容**: 可以通过设置 `CACHE_USE_MIGRATION_ADAPTER=false` 禁用
3. **可观察性**: 首次调用时会输出迁移模式状态日志，方便排查问题

---

*修复完成！请重启服务并验证多步推理功能是否恢复正常喵～* ฅ'ω'ฅ
