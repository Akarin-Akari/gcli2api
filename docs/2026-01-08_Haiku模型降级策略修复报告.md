# Haiku 模型降级策略修复报告

**日期**: 2026-01-08
**修复人**: Claude Opus 4.5
**问题类型**: 模型映射错误

---

## 问题描述

用户观察到 gcli2api 在转发来自 Claude Code 的请求时，使用了错误的降级策略：

```
[05:13:46] [INFO] [ANTHROPIC] /messages 模型映射: upstream=claude-haiku-4-5-20251001 -> downstream=gemini-2.5-flash
```

**预期行为**: Haiku 模型应该降级到 `gemini-3-flash`
**实际行为**: Haiku 模型被错误地降级到 `gemini-2.5-flash`

---

## 根因分析

### 问题1: anthropic_converter.py 硬编码错误

**位置**: `src/anthropic_converter.py:226-227`

```python
# 修复前
if claude_model == "claude-haiku-4-5":
    return "gemini-2.5-flash"  # ❌ 错误的硬编码值
```

`fallback_manager.py` 中正确定义了 `HAIKU_FALLBACK_TARGET = "gemini-3-flash"`，但 `anthropic_converter.py` 中的 `map_claude_model_to_gemini` 函数使用了硬编码的错误值。

### 问题2: model_mapping 字典中的错误映射

**位置**: `src/anthropic_converter.py:262-263`

```python
# 修复前
model_mapping = {
    ...
    "claude-haiku-4": "claude-haiku-4.5",  # 可能导致循环
    "claude-3-haiku-20240307": "gemini-2.5-flash",  # ❌ 错误的硬编码值
}
```

---

## 修复方案

### 修复1: 使用 fallback_manager 常量

```python
# 修复后
if claude_model == "claude-haiku-4-5":
    # 使用 fallback_manager 中定义的 Haiku 降级目标，保持一致性
    from src.fallback_manager import HAIKU_FALLBACK_TARGET
    return HAIKU_FALLBACK_TARGET  # gemini-3-flash
```

### 修复2: 统一 Haiku 模型处理逻辑

```python
# 修复后 - 在 model_mapping 之前添加统一处理
# Haiku 模型统一使用 HAIKU_FALLBACK_TARGET
from src.fallback_manager import HAIKU_FALLBACK_TARGET, is_haiku_model
if is_haiku_model(claude_model):
    return HAIKU_FALLBACK_TARGET  # gemini-3-flash

model_mapping = {
    "claude-sonnet-4.5": "claude-sonnet-4-5",
    "claude-3-5-sonnet-20241022": "claude-sonnet-4-5",
    "claude-3-5-sonnet-20240620": "claude-sonnet-4-5",
    "claude-opus-4": "gemini-3-pro-high",
    # 移除了 haiku 相关的硬编码映射
}
```

---

## 降级策略审查结果

### 1. HAIKU_MODELS 集合 ✅

`fallback_manager.py` 中定义的 Haiku 模型集合：

```python
HAIKU_MODELS = {
    "claude-haiku-4-5",
    "claude-haiku-4.5",
    "haiku-4.5",
    "haiku-4-5",
    "claude-3-haiku",
    "claude-3-haiku-20240307",
}
```

`is_haiku_model()` 函数还使用模糊匹配 `"haiku" in model_lower`，能覆盖所有变体。

### 2. 跨池降级映射 ✅

| 源模型 | 降级目标 | 状态 |
|--------|----------|------|
| claude-opus-4-5-thinking | gemini-3-pro-high | ✅ 正确 |
| claude-opus-4-5 | gemini-3-pro-high | ✅ 正确 |
| claude-sonnet-4-5-thinking | gemini-2.5-pro | ✅ 正确 |
| claude-sonnet-4-5 | gemini-2.5-pro | ✅ 正确 |
| **所有 Haiku 模型** | **gemini-3-flash** | ✅ 已修复 |

### 3. 其他文件检查 ✅

- `converters/model_config.py` - 正确使用 `is_haiku_model()` 和 `HAIKU_FALLBACK_TARGET`
- `antigravity_anthropic_router.py` - 正确导入并使用 fallback_manager 的常量
- `unified_gateway_router.py` - 正确处理 haiku 模型的规范化映射

---

## 修改的文件

| 文件 | 修改内容 |
|------|----------|
| `src/anthropic_converter.py` | 修复 haiku 模型映射，使用 `HAIKU_FALLBACK_TARGET` 常量 |

---

## 验证方法

修复后，Haiku 模型请求应该显示：

```
[INFO] [ANTHROPIC] /messages 模型映射: upstream=claude-haiku-4-5-20251001 -> downstream=gemini-3-flash
```

---

## 备份文件

- `src/anthropic_converter.py.bak.haiku_fix` - 修复前的备份

---

## 总结

本次修复解决了 Haiku 模型降级策略不一致的问题，确保所有 Haiku 模型都正确降级到 `gemini-3-flash`。修复遵循了以下原则：

1. **DRY 原则**: 使用 `fallback_manager.py` 中定义的常量，避免硬编码
2. **单一职责**: 所有 Haiku 模型的降级逻辑统一由 `is_haiku_model()` 函数判断
3. **一致性**: 确保整个代码库中 Haiku 模型的处理逻辑一致
